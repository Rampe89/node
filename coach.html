<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Project 230 â€“ TorTour Prep Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --bg-alt: #020617;
      --card: #02091a;
      --accent: #38bdf8;
      --accent2: #22c55e;
      --accent-soft: rgba(56, 189, 248, 0.2);
      --text: #e5e7eb;
      --text-muted: #9ca3af;
      --danger: #f97373;
      --warning: #fb923c;
      --radius: 14px;
      --shadow: 0 22px 50px rgba(15,23,42,0.9);
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background:
        radial-gradient(circle at top, #0f172a 0, #020617 55%),
        radial-gradient(circle at bottom, #020617 0, #000 65%);
      color: var(--text);
    }

    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 24px;
    }

    header h1 {
      margin: 0;
      font-size: 1.9rem;
      letter-spacing: 0.06em;
      display: flex;
      align-items: center;
      gap: 10px;
      text-transform: uppercase;
    }

    header h1 span.logo {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 38px;
      height: 38px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 20%, #38bdf8, #0ea5e9 40%, #4c1d95 100%);
      color: #f9fafb;
      font-size: 1.3rem;
      font-weight: 800;
      box-shadow:
        0 0 25px rgba(56,189,248,0.8),
        0 0 55px rgba(14,165,233,0.8);
      border: 1px solid rgba(186,230,253,0.9);
    }

    header p {
      margin: 4px 0 0;
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    .pill {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      color: var(--text-muted);
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: radial-gradient(circle at top left, rgba(56,189,248,0.25), transparent 55%),
                  rgba(15,23,42,0.95);
      backdrop-filter: blur(12px);
    }

    .pill strong {
      color: var(--accent);
    }

    .grid {
      display: grid;
      grid-template-columns: 2fr 3fr;
      gap: 24px;
      margin-bottom: 24px;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background:
        radial-gradient(circle at top left, rgba(56,189,248,0.12), transparent 55%),
        radial-gradient(circle at bottom right, rgba(124,58,237,0.14), transparent 55%),
        var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px 18px 20px;
      border: 1px solid rgba(30,64,175,0.8);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(56,189,248,0.08), transparent 60%);
      opacity: 0.6;
      pointer-events: none;
    }

    .card > * {
      position: relative;
      z-index: 1;
    }

    .card h2 {
      margin: 0 0 8px;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-weight: 600;
    }

    .card h2 span {
      font-size: 0.75rem;
      font-weight: 400;
      color: var(--text-muted);
      text-transform: none;
      letter-spacing: normal;
    }

    .small {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    label {
      display: block;
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    input, select, textarea {
      width: 100%;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid rgba(30,64,175,0.9);
      background: rgba(15,23,42,0.94);
      color: var(--text);
      font-size: 0.85rem;
    }

    input:focus, select:focus, textarea:focus {
      outline: 1px solid var(--accent);
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.3);
    }

    textarea {
      resize: vertical;
      min-height: 40px;
      max-height: 120px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px 14px;
      margin-top: 10px;
    }

    .inline-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .inline-row input[type="checkbox"] {
      width: auto;
    }

    .btn-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .btn-group-right {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 7px 16px;
      font-size: 0.85rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #38bdf8, #22c55e);
      color: #020617;
      box-shadow:
        0 12px 22px rgba(56,189,248,0.5),
        0 0 30px rgba(34,197,94,0.6);
    }

    .btn-secondary {
      background: rgba(15,23,42,0.9);
      color: var(--text-muted);
      border: 1px solid rgba(30,64,175,0.9);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-muted);
      border: 1px dashed rgba(148,163,184,0.4);
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 8px;
    }

    .summary-card {
      border-radius: 10px;
      padding: 10px 10px;
      background: radial-gradient(circle at top, rgba(15,23,42,0.9), rgba(15,23,42,0.92));
      border: 1px solid rgba(30,64,175,0.9);
    }

    .summary-label {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .summary-value {
      font-size: 1.05rem;
      font-weight: 600;
    }

    .summary-value-big {
      font-size: 1.6rem;
      font-weight: 800;
    }

    .tag-ok {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.75rem;
      background: var(--accent-soft);
      color: var(--accent);
      display: inline-flex;
      align-items: center;
      margin-top: 4px;
      border: 1px solid rgba(56,189,248,0.6);
    }

    .tag-warn {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.75rem;
      background: rgba(248,250,252,0.02);
      color: var(--warning);
      border: 1px solid rgba(249,115,22,0.45);
      display: inline-flex;
      align-items: center;
      margin-top: 4px;
    }

    .tag-bad {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.75rem;
      background: rgba(248,113,113,0.08);
      color: var(--danger);
      border: 1px solid rgba(248,113,113,0.6);
      display: inline-flex;
      align-items: center;
      margin-top: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.8rem;
    }

    thead {
      background: rgba(15,23,42,0.95);
    }

    th, td {
      padding: 6px 6px;
      border-bottom: 1px solid rgba(30,64,175,0.6);
      text-align: left;
      white-space: nowrap;
    }

    th {
      position: sticky;
      top: 0;
      background: rgba(15,23,42,0.97);
      z-index: 1;
    }

    tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.85);
    }

    .table-wrapper {
      max-height: 360px;
      overflow: auto;
      margin-top: 4px;
      border-radius: 10px;
      border: 1px solid rgba(30,64,175,0.8);
      background: rgba(15,23,42,0.9);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      font-size: 0.75rem;
      color: var(--text-muted);
      gap: 6px;
    }

    .chip-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 8px rgba(56,189,248,0.8);
    }

    .hint {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .danger-link {
      color: var(--danger);
      text-decoration: underline;
      cursor: pointer;
      font-size: 0.78rem;
    }

    .nowrap {
      white-space: nowrap;
    }

    .ampel-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .coach-text {
      font-size: 0.8rem;
      line-height: 1.4;
      margin-top: 4px;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(30,64,175,0.9);
      overflow: hidden;
      margin-top: 6px;
    }

    .progress-fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #38bdf8, #22c55e);
      width: 0%;
      transition: width 0.4s ease-out;
      box-shadow:
        0 0 14px rgba(56,189,248,0.9),
        0 0 22px rgba(34,197,94,0.7);
    }

    .level-subtext {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    #importJsonInput {
      display: none;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>
          <span class="logo">P230</span>
          Project 230 â€“ TorTour Prep
        </h1>
        <p>Dein Project-230-Board: Training, Recovery, Alltag & TorTour-Vorbereitung â€“ alles lokal, ohne Server.</p>
      </div>
      <div>
        <div class="pill">
          <span>Projekt:</span><strong>TorTour de Ruhr Â· 230 km</strong>
        </div>
      </div>
    </header>

    <!-- Einstellungen & Check-in -->
    <div class="grid">
      <section class="card">
        <h2>TorTour-Einstellungen <span>Race Â· Zielbereiche Â· Backup</span></h2>
        <p class="small">
          Setze Renn-Datum & Zielbereiche â€“ und sichere deine Daten per Export, falls der Browser mal leergerÃ¤umt wird.
        </p>
        <div class="settings-grid">
          <div>
            <label for="raceDate">Renn-Datum (TorTour de Ruhr)</label>
            <input type="date" id="raceDate" />
          </div>
          <div>
            <label for="targetKm">Ziel-Wochenkilometer (Laufen)</label>
            <input type="number" id="targetKm" min="0" step="1" placeholder="Standard: 90" />
          </div>
          <div>
            <label for="targetSleep">Ziel-Schlaf (Ã˜ h / Tag)</label>
            <input type="number" id="targetSleep" min="0" step="0.1" placeholder="z.B. 7.5" />
          </div>
          <div>
            <label for="targetFluids">Ziel-FlÃ¼ssigkeit (Ã˜ L / Tag)</label>
            <input type="number" id="targetFluids" min="0" step="0.1" placeholder="z.B. 2.5" />
          </div>
        </div>

        <div class="btn-row" style="margin-top: 10px;">
          <div class="btn-group-right">
            <button class="btn-secondary" id="saveSettingsBtn">Einstellungen speichern</button>
          </div>
          <div class="btn-group-right">
            <button class="btn-ghost" id="exportJsonBtn">Backup exportieren (JSON)</button>
            <button class="btn-ghost" id="exportCsvBtn">Daten exportieren (CSV)</button>
            <button class="btn-ghost" id="importJsonBtn">Backup importieren</button>
            <input type="file" id="importJsonInput" accept="application/json" />
          </div>
        </div>

        <div class="summary-grid" id="raceSummary"></div>
        <p class="hint">
          Backup-Tipp: Alle paar Wochen JSON sichern, dann kannst du Project 230 auch auf anderen GerÃ¤ten laden.
        </p>
      </section>

      <section class="card">
        <h2>Neuen Tag eintragen <span>TÃ¤gliches Log</span></h2>
        <p class="small">Einmal kurz loggen â€“ das Dashboard kÃ¼mmert sich um Auswertung, Fortschritt & Empfehlungen.</p>

        <div class="form-grid">
          <div>
            <label for="entryDate">Datum</label>
            <input type="date" id="entryDate" />
          </div>

          <div>
            <label for="weight">Gewicht (kg)</label>
            <input type="number" id="weight" step="0.1" min="0" />
          </div>

          <div>
            <label for="trainingType">Training (Art)</label>
            <select id="trainingType">
              <option value="">â€“ Kein Training / Rest â€“</option>
              <option value="Langer Lauf">Langer Lauf</option>
              <option value="Intervall">Intervall</option>
              <option value="Tempo">Tempolauf</option>
              <option value="Locker">Lockerer Lauf</option>
              <option value="Kraft">Kraft / Stabi</option>
              <option value="Cross">Cross / Alternativ</option>
              <option value="Indoor Rad">Indoor Rad</option>
              <option value="Fitnessboxen">Fitnessboxen</option>
              <option value="Wettkampf">Wettkampf / Test</option>
            </select>
          </div>

          <div>
            <label for="distanceKm">Distanz (km)</label>
            <input type="number" id="distanceKm" step="0.1" min="0" />
          </div>

          <div>
            <label for="durationMin">Dauer (Minuten)</label>
            <input type="number" id="durationMin" step="1" min="0" />
          </div>

          <div>
            <label for="rpe">Belastung (RPE 1â€“10)</label>
            <input type="number" id="rpe" step="1" min="1" max="10" />
          </div>

          <div>
            <label for="sleepHours">Schlaf (Stunden)</label>
            <input type="number" id="sleepHours" step="0.1" min="0" />
          </div>

          <div>
            <label for="sleepQuality">Schlaf-QualitÃ¤t</label>
            <select id="sleepQuality">
              <option value="">â€“</option>
              <option value="sehr gut">sehr gut</option>
              <option value="gut">gut</option>
              <option value="okay">okay</option>
              <option value="schlecht">schlecht</option>
            </select>
          </div>

          <div>
            <label for="fluidsLiters">FlÃ¼ssigkeit (L)</label>
            <input type="number" id="fluidsLiters" step="0.1" min="0" />
          </div>

          <div>
            <label for="wellbeing">Wohlbefinden (1 = mies, 5 = top)</label>
            <select id="wellbeing">
              <option value="">â€“</option>
              <option value="1">1 â€“ sehr schlecht</option>
              <option value="2">2</option>
              <option value="3">3 â€“ neutral</option>
              <option value="4">4</option>
              <option value="5">5 â€“ sehr gut</option>
            </select>
          </div>

          <div>
            <label>&nbsp;</label>
            <div class="inline-row">
              <input type="checkbox" id="nightRun" />
              <span>Nachtlauf</span>
            </div>
            <div class="inline-row">
              <input type="checkbox" id="hasPain" />
              <span>Schmerzen heute?</span>
            </div>
          </div>

          <div>
            <label>Supplements heute</label>
            <div class="inline-row">
              <input type="checkbox" id="suppOmega3" />
              <span>Omega 3</span>
            </div>
            <div class="inline-row">
              <input type="checkbox" id="suppZink" />
              <span>Zink</span>
            </div>
            <div class="inline-row">
              <input type="checkbox" id="suppMagnesium" />
              <span>Magnesium</span>
            </div>
            <div class="inline-row">
              <input type="checkbox" id="suppD3" />
              <span>Vitamin D3</span>
            </div>
          </div>

          <div style="grid-column: 1 / -1;">
            <label for="painNote">Schmerz / Beschwerden (optional)</label>
            <textarea id="painNote" placeholder="z.B. rechtes Knie, Achillessehne, Magen, mental mÃ¼de â€¦"></textarea>
          </div>

          <div style="grid-column: 1 / -1;">
            <label for="comments">Weitere Notizen</label>
            <textarea id="comments" placeholder="Was lief gut? Was war schwer? Was hast du gelernt?"></textarea>
          </div>
        </div>

        <div class="btn-row">
          <span class="hint">
            Alles wird lokal im Browser gespeichert (<code>localStorage</code>). Kein Upload, kein Server.
            <span class="danger-link" id="clearDataLink">Alle Daten lÃ¶schen</span>
          </span>
          <div class="btn-group-right">
            <button class="btn-secondary" id="fillTodayBtn">Heute Ã¼bernehmen</button>
            <button class="btn-primary" id="addEntryBtn">Eintrag speichern</button>
          </div>
        </div>
      </section>
    </div>

    <!-- Auswertung 7 Tage + Score -->
    <section class="card">
      <h2>Auswertung letzte 7 Tage <span>Training Â· Recovery Â· Project-230-Status</span></h2>
      <div class="summary-grid" id="statsSummary"></div>
      <p class="hint">
        Ziel: stabile Wochenstruktur, gute Recovery & kontinuierlicher Fortschritt Richtung TorTour-Tag.
      </p>
      <div id="coachFeedback" class="hint"></div>
    </section>

    <!-- Coaching-Empfehlungen -->
    <section class="card" style="margin-top:20px;">
      <h2>Coach-Empfehlungen <span>Tages- & Wochen-Fokus</span></h2>
      <div class="summary-grid">
        <div class="summary-card">
          <div class="summary-label">Empfehlung fÃ¼r morgen</div>
          <div class="summary-value" id="dailyCoachTitle">Wird aus deinen Daten berechnet â€¦</div>
          <div class="coach-text" id="dailyCoachText"></div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Wochen-Coaching</div>
          <div class="summary-value" id="weeklyCoachTitle">Wochenplan basierend auf letzter Woche</div>
          <div class="coach-text" id="weeklyCoachText"></div>
        </div>
      </div>
      <p class="hint">
        Empfehlungen basieren auf Lauf-Wochenkilometern, Belastung, Schlaf, FlÃ¼ssigkeit, Wohlbefinden, Schmerzen & Supplements.
      </p>
    </section>

    <!-- Rohdaten -->
    <section class="card" style="margin-top: 20px;">
      <h2>Alle EintrÃ¤ge <span>Project-230-Log â€“ scroll- & filterbar</span></h2>
      <div class="chip" style="margin-bottom: 6px;">
        <span class="chip-dot"></span>
        <span>Datenbasis fÃ¼r deine TorTour-Vorbereitung & deinen Alltag</span>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Datum</th>
              <th>Gewicht</th>
              <th>Training</th>
              <th>km</th>
              <th>Dauer</th>
              <th>RPE</th>
              <th>Schlaf (h)</th>
              <th>FlÃ¼ssigkeit (L)</th>
              <th>Wohlbef.</th>
              <th>Nacht?</th>
              <th>Schmerz?</th>
              <th>Omega 3</th>
              <th>Zink</th>
              <th>Magnesium</th>
              <th>D3</th>
              <th>Schmerz-Notiz</th>
              <th>Weitere Notizen</th>
            </tr>
          </thead>
          <tbody id="entriesTableBody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    function parseNumber(value) {
      if (value === null || value === undefined) return null;
      var v = String(value).replace(',', '.').trim();
      if (v === '') return null;
      var num = parseFloat(v);
      return isNaN(num) ? null : num;
    }

    function saveState(key, data) {
      localStorage.setItem(key, JSON.stringify(data));
    }

    function loadState(key, fallback) {
      var raw = localStorage.getItem(key);
      if (!raw) return fallback;
      try {
        return JSON.parse(raw);
      } catch (e) {
        console.warn('Konnte State nicht lesen:', key, e);
        return fallback;
      }
    }

    var STORAGE_ENTRIES_KEY = "ttdr_entries_v3";
    var STORAGE_SETTINGS_KEY = "ttdr_settings_v1";

    var entries = loadState(STORAGE_ENTRIES_KEY, []);
    var settings = loadState(STORAGE_SETTINGS_KEY, {
      raceDate: "",
      targetKm: 90,
      targetSleep: 7.5,
      targetFluids: 2.5
    });

    var raceDateInput = document.getElementById("raceDate");
    var targetKmInput = document.getElementById("targetKm");
    var targetSleepInput = document.getElementById("targetSleep");
    var targetFluidsInput = document.getElementById("targetFluids");
    var raceSummaryEl = document.getElementById("raceSummary");

    var entryDateInput = document.getElementById("entryDate");
    var weightInput = document.getElementById("weight");
    var trainingTypeInput = document.getElementById("trainingType");
    var distanceKmInput = document.getElementById("distanceKm");
    var durationMinInput = document.getElementById("durationMin");
    var rpeInput = document.getElementById("rpe");
    var sleepHoursInput = document.getElementById("sleepHours");
    var sleepQualityInput = document.getElementById("sleepQuality");
    var fluidsLitersInput = document.getElementById("fluidsLiters");
    var wellbeingInput = document.getElementById("wellbeing");
    var nightRunInput = document.getElementById("nightRun");
    var hasPainInput = document.getElementById("hasPain");
    var painNoteInput = document.getElementById("painNote");
    var commentsInput = document.getElementById("comments");
    var suppOmega3Input = document.getElementById("suppOmega3");
    var suppZinkInput = document.getElementById("suppZink");
    var suppMagnesiumInput = document.getElementById("suppMagnesium");
    var suppD3Input = document.getElementById("suppD3");

    var saveSettingsBtn = document.getElementById("saveSettingsBtn");
    var fillTodayBtn = document.getElementById("fillTodayBtn");
    var addEntryBtn = document.getElementById("addEntryBtn");
    var clearDataLink = document.getElementById("clearDataLink");

    var exportJsonBtn = document.getElementById("exportJsonBtn");
    var exportCsvBtn = document.getElementById("exportCsvBtn");
    var importJsonBtn = document.getElementById("importJsonBtn");
    var importJsonInput = document.getElementById("importJsonInput");

    var statsSummaryEl = document.getElementById("statsSummary");
    var entriesTableBody = document.getElementById("entriesTableBody");
    var coachFeedbackEl = document.getElementById("coachFeedback");

    var dailyCoachTitleEl = document.getElementById("dailyCoachTitle");
    var dailyCoachTextEl = document.getElementById("dailyCoachText");
    var weeklyCoachTitleEl = document.getElementById("weeklyCoachTitle");
    var weeklyCoachTextEl = document.getElementById("weeklyCoachText");

    function initSettingsUI() {
      if (settings.raceDate) raceDateInput.value = settings.raceDate;
      if (settings.targetKm != null) targetKmInput.value = settings.targetKm;
      if (settings.targetSleep != null) targetSleepInput.value = settings.targetSleep;
      if (settings.targetFluids != null) targetFluidsInput.value = settings.targetFluids;
    }

    function saveSettings() {
      settings.raceDate = raceDateInput.value || "";

      var tk = parseNumber(targetKmInput.value);
      settings.targetKm = tk != null ? tk : 90;

      var ts = parseNumber(targetSleepInput.value);
      settings.targetSleep = ts != null ? ts : 7.5;

      var tf = parseNumber(targetFluidsInput.value);
      settings.targetFluids = tf != null ? tf : 2.5;

      saveState(STORAGE_SETTINGS_KEY, settings);
      updateRaceSummary();
      updateStats();
    }

    function updateRaceSummary() {
      raceSummaryEl.innerHTML = "";

      var today = new Date();
      today.setHours(0,0,0,0);

      var raceDateStr = settings.raceDate;
      var blocks = "";

      if (raceDateStr) {
        var raceDate = new Date(raceDateStr + "T00:00:00");
        var diffMs = raceDate.getTime() - today.getTime();
        var diffDays = Math.round(diffMs / (1000 * 60 * 60 * 24));

        var statusText = "";
        var tagClass = "tag-ok";

        if (diffDays > 0) {
          statusText = diffDays + " Tage bis zur TorTour";
          if (diffDays < 7) {
            tagClass = "tag-bad";
            statusText = "Race Week â€“ " + diffDays + " Tage";
          } else if (diffDays < 30) {
            tagClass = "tag-warn";
          }
        } else if (diffDays === 0) {
          statusText = "HEUTE ist TorTour-Day!";
          tagClass = "tag-bad";
        } else {
          statusText = "Rennen liegt " + Math.abs(diffDays) + " Tage zurÃ¼ck";
          tagClass = "tag-warn";
        }

        blocks +=
          '<div class="summary-card">' +
            '<div class="summary-label">Race-Countdown</div>' +
            '<div class="summary-value">' + statusText + '</div>' +
            '<div class="' + tagClass + '">Race Date: ' + raceDate.toLocaleDateString("de-DE") + '</div>' +
          '</div>';
      } else {
        blocks +=
          '<div class="summary-card">' +
            '<div class="summary-label">Race-Countdown</div>' +
            '<div class="summary-value">Noch kein Datum gesetzt</div>' +
            '<div class="tag-warn">Trage das Renn-Datum ein, um den Countdown zu aktivieren.</div>' +
          '</div>';
      }

      blocks +=
        '<div class="summary-card">' +
          '<div class="summary-label">Ziel-Wochenkilometer</div>' +
          '<div class="summary-value">' + (settings.targetKm != null ? settings.targetKm + ' km' : '90 km (Standard)') + '</div>' +
          '<div class="tag-ok">Solider Ultra-Bereich fÃ¼r deine TorTour-Basis.</div>' +
        '</div>' +
        '<div class="summary-card">' +
          '<div class="summary-label">Ziel-Schlaf</div>' +
          '<div class="summary-value">' + (settings.targetSleep != null ? settings.targetSleep + ' h / Tag' : '7.5 h / Tag') + '</div>' +
          '<div class="tag-ok">Recovery-Fokus â€“ Schlaf ist dein wichtigster Regenerationsfaktor.</div>' +
        '</div>' +
        '<div class="summary-card">' +
          '<div class="summary-label">Ziel-FlÃ¼ssigkeit</div>' +
          '<div class="summary-value">' + (settings.targetFluids != null ? settings.targetFluids + ' L / Tag' : '2.5 L / Tag') + '</div>' +
          '<div class="tag-ok">Hydration als Grundlage fÃ¼r lange Sessions.</div>' +
        '</div>';

      raceSummaryEl.innerHTML = blocks;
    }

    function getMonday(dateString) {
      var d = new Date(dateString + "T00:00:00");
      var day = d.getDay(); 
      var diff = (day === 0 ? -6 : 1 - day);
      d.setDate(d.getDate() + diff);
      d.setHours(0,0,0,0);
      return d;
    }

    function formatDateShort(dateString) {
      var d = new Date(dateString + "T00:00:00");
      return d.toLocaleDateString("de-DE", { day: "2-digit", month: "2-digit" });
    }

    function computeDailyXP(entry, settings) {
      var targetKm = settings.targetKm || 90;
      var targetSleep = settings.targetSleep || 7.5;
      var targetFluids = settings.targetFluids || 2.5;

      var xp = 0;

      var dist = parseNumber(entry.distanceKm);
      var dur = parseNumber(entry.durationMin);
      var rpe = parseNumber(entry.rpe);
      var sleep = parseNumber(entry.sleepHours);
      var fluids = parseNumber(entry.fluidsLiters);
      var wb = parseNumber(entry.wellbeing);

      var isTraining = dur != null && dur > 0;

      if (isTraining) {
        xp += 10;
      } else {
        xp += 3;
      }

      if (dist != null && dist > 0 && targetKm > 0) {
        var targetDailyKm = targetKm / 7;
        var ratio = dist / targetDailyKm;
        if (ratio >= 0.8 && ratio <= 1.5) {
          xp += 10;
        } else if (ratio > 0.3) {
          xp += 5;
        } else {
          xp += 2;
        }
      }

      if (sleep != null) {
        var rs = sleep / targetSleep;
        if (rs >= 0.95) xp += 6;
        else if (rs >= 0.8) xp += 4;
        else if (rs >= 0.6) xp += 2;
      }

      if (fluids != null) {
        var rf = fluids / targetFluids;
        if (rf >= 0.95) xp += 5;
        else if (rf >= 0.8) xp += 3;
        else if (rf >= 0.6) xp += 1;
      }

      if (wb != null) {
        if (wb >= 4) xp += 3;
        else if (wb === 3) xp += 2;
        else if (wb <= 2) xp += 1;
      }

      if (entry.nightRun) {
        xp += 8;
      }
      if (entry.trainingType === "Langer Lauf" && dist != null && dist >= 25) {
        xp += 8;
      }

      if (dur != null && rpe != null && dur >= 60 && rpe >= 8) {
        xp += 5;
      }

      if (entry.omega3 && entry.zink && entry.magnesium && entry.d3) {
        xp += 3;
      }

      if (xp < 3) xp = 3;
      if (xp > 35) xp = 35;

      return xp;
    }

    function computeTotalXP(entries, settings) {
      var total = 0;
      for (var i = 0; i < entries.length; i++) {
        var e = entries[i];
        if (!e.date) continue;
        total += computeDailyXP(e, settings);
      }
      return Math.round(total);
    }

    function getProgressFromXP(totalXP) {
      var xpPerStep = 50;
      var score = Math.floor(totalXP / xpPerStep);
      if (score < 0) score = 0;
      if (score > 100) score = 100;
      var currScore = score;
      var nextScore = score < 100 ? score + 1 : 100;
      var xpIntoStep = totalXP - currScore * xpPerStep;
      return {
        score: score,
        currScore: currScore,
        nextScore: nextScore,
        xpIntoStep: xpIntoStep,
        xpPerStep: xpPerStep
      };
    }

    function exportJSON() {
      var data = {
        version: 2,
        exportedAt: new Date().toISOString(),
        settings: settings,
        entries: entries
      };
      var blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      var dateStr = new Date().toISOString().slice(0,10);
      a.href = url;
      a.download = "project230_backup_" + dateStr + ".json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function exportCSV() {
      if (!entries || entries.length === 0) {
        alert("Keine EintrÃ¤ge vorhanden, die exportiert werden kÃ¶nnten.");
        return;
      }
      var header = [
        "date","weight","trainingType","distanceKm","durationMin","rpe",
        "sleepHours","sleepQuality","fluidsLiters","wellbeing",
        "nightRun","hasPain","omega3","zink","magnesium","d3","painNote","comments"
      ];
      var rows = [header];

      for (var i = 0; i < entries.length; i++) {
        var e = entries[i];
        rows.push([
          e.date || "",
          e.weight != null ? e.weight : "",
          e.trainingType || "",
          e.distanceKm != null ? e.distanceKm : "",
          e.durationMin != null ? e.durationMin : "",
          e.rpe != null ? e.rpe : "",
          e.sleepHours != null ? e.sleepHours : "",
          e.sleepQuality || "",
          e.fluidsLiters != null ? e.fluidsLiters : "",
          e.wellbeing != null ? e.wellbeing : "",
          e.nightRun ? "1" : "0",
          e.hasPain ? "1" : "0",
          e.omega3 ? "1" : "0",
          e.zink ? "1" : "0",
          e.magnesium ? "1" : "0",
          e.d3 ? "1" : "0",
          (e.painNote || "").replace(/"/g, '""'),
          (e.comments || "").replace(/"/g, '""')
        ]);
      }

      var csvContent = rows.map(function(r) {
        return r.map(function(cell) {
          var str = String(cell);
          if (str.indexOf(",") !== -1 || str.indexOf("\"") !== -1 || str.indexOf("\n") !== -1) {
            return "\"" + str.replace(/"/g, '""') + "\"";
          }
          return str;
        }).join(",");
      }).join("\n");

      var blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      var dateStr2 = new Date().toISOString().slice(0,10);
      a.href = url;
      a.download = "project230_entries_" + dateStr2 + ".csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function triggerImport() {
      importJsonInput.value = "";
      importJsonInput.click();
    }

    function handleImportFile(event) {
      var file = event.target.files[0];
      if (!file) return;

      var reader = new FileReader();
      reader.onload = function(ev) {
        try {
          var text = ev.target.result;
          var data = JSON.parse(text);

          if (!data || (!Array.isArray(data.entries) && !Array.isArray(data))) {
            alert("Die JSON-Datei enthÃ¤lt kein erwartetes Format.");
            return;
          }

          var importedEntries;
          var importedSettings;

          if (Array.isArray(data)) {
            importedEntries = data;
            importedSettings = settings;
          } else {
            importedEntries = Array.isArray(data.entries) ? data.entries : [];
            importedSettings = data.settings || {};
          }

          if (!confirm("Backup mit " + importedEntries.length + " EintrÃ¤gen laden und bestehende Daten Ã¼berschreiben?")) {
            return;
          }

          entries = importedEntries.map(function(e) {
            return {
              date: e.date || "",
              weight: e.weight != null ? e.weight : null,
              trainingType: e.trainingType || "",
              distanceKm: e.distanceKm != null ? e.distanceKm : null,
              durationMin: e.durationMin != null ? e.durationMin : null,
              rpe: e.rpe != null ? e.rpe : null,
              sleepHours: e.sleepHours != null ? e.sleepHours : null,
              sleepQuality: e.sleepQuality || "",
              fluidsLiters: e.fluidsLiters != null ? e.fluidsLiters : null,
              wellbeing: e.wellbeing != null ? e.wellbeing : null,
              nightRun: !!e.nightRun,
              hasPain: !!e.hasPain,
              omega3: !!e.omega3,
              zink: !!e.zink,
              magnesium: !!e.magnesium,
              d3: !!e.d3,
              painNote: e.painNote || "",
              comments: e.comments || ""
            };
          });

          settings = {
            raceDate: importedSettings.raceDate || "",
            targetKm: importedSettings.targetKm != null ? importedSettings.targetKm : 90,
            targetSleep: importedSettings.targetSleep != null ? importedSettings.targetSleep : 7.5,
            targetFluids: importedSettings.targetFluids != null ? importedSettings.targetFluids : 2.5
          };

          saveState(STORAGE_ENTRIES_KEY, entries);
          saveState(STORAGE_SETTINGS_KEY, settings);

          initSettingsUI();
          updateRaceSummary();
          updateStats();
          alert("Backup erfolgreich importiert. Deine Project-230-Daten wurden geladen.");
        } catch (err) {
          console.error("Fehler beim Import:", err);
          alert("Fehler beim Import der JSON-Datei. PrÃ¼fe, ob es ein gÃ¼ltiges Backup ist.");
        }
      };
      reader.readAsText(file);
    }

    function updateStats() {
      statsSummaryEl.innerHTML = "";
      if (coachFeedbackEl) coachFeedbackEl.textContent = "";

      if (!entries || entries.length === 0) {
        statsSummaryEl.innerHTML =
          '<div class="summary-card">' +
            '<div class="summary-label">Noch keine Daten</div>' +
            '<div class="summary-value">Starte mit deinem ersten Eintrag ðŸ‘£</div>' +
            '<div class="tag-warn">Ein paar Tage loggen, dann gibt es Score, Fortschritt & Coaching.</div>' +
          '</div>';
        entriesTableBody.innerHTML = "";
        updateCoaching({}, {});
        return;
      }

      var sorted = entries.slice().sort(function(a, b) {
        return (a.date || "").localeCompare(b.date || "");
      });

      var today = new Date();
      today.setHours(0,0,0,0);
      var sevenDaysAgo = new Date(today.getTime() - 6 * 24*60*60*1000);
      var threeDaysAgo = new Date(today.getTime() - 2 * 24*60*60*1000);
      var fourteenDaysAgo = new Date(today.getTime() - 13 * 24*60*60*1000);
      var thirtyDaysAgo = new Date(today.getTime() - 30 * 24*60*60*1000);
      var thirtyDaysAgoStr = thirtyDaysAgo.toISOString().substring(0,10);

      var sumKm = 0;
      var sumSleep = 0;
      var sumFluids = 0;
      var countSleep = 0;
      var countFluids = 0;

      var trimp7 = 0;
      var trimp3 = 0;

      var latestWeight = null;
      var weight30days = null;

      var weeklyKmMap = {};
      var dailyTrimpMap = {};
      var sleepMap = {};
      var fluidsMap = {};
      var weightSeries = [];
      var suppMap = {};

      var last7WellbeingSum = 0;
      var last7WellbeingCount = 0;
      var painCountLast7 = 0;

      for (var i = 0; i < sorted.length; i++) {
        var e = sorted[i];
        if (!e.date) continue;
        var d = new Date(e.date + "T00:00:00");
        var dateStr = e.date;

        if (d >= sevenDaysAgo && d <= today) {
          var dist = parseNumber(e.distanceKm);
          if (dist != null) sumKm += dist;

          var sleep = parseNumber(e.sleepHours);
          if (sleep != null) { sumSleep += sleep; countSleep++; }

          var fluids = parseNumber(e.fluidsLiters);
          if (fluids != null) { sumFluids += fluids; countFluids++; }

          var wb = parseNumber(e.wellbeing);
          if (wb != null) { last7WellbeingSum += wb; last7WellbeingCount++; }

          if (e.hasPain === true) painCountLast7++;

          if (!suppMap[dateStr]) {
            suppMap[dateStr] = { omega3: false, zink: false, magnesium: false, d3: false };
          }
          if (e.omega3) suppMap[dateStr].omega3 = true;
          if (e.zink) suppMap[dateStr].zink = true;
          if (e.magnesium) suppMap[dateStr].magnesium = true;
          if (e.d3) suppMap[dateStr].d3 = true;
        }

        var dur = parseNumber(e.durationMin);
        var rpeVal = parseNumber(e.rpe);
        var trimp = 0;
        if (dur != null && rpeVal != null) {
          trimp = dur * rpeVal;
        }
        if (d >= sevenDaysAgo && d <= today) trimp7 += trimp;
        if (d >= threeDaysAgo && d <= today) trimp3 += trimp;

        var w = parseNumber(e.weight);
        if (w != null) {
          if (!latestWeight || e.date > latestWeight.date) {
            latestWeight = { date: e.date, weight: w };
          }
          if (e.date <= thirtyDaysAgoStr) {
            if (!weight30days || e.date > weight30days.date) {
              weight30days = { date: e.date, weight: w };
            }
          }
          weightSeries.push({ date: e.date, weight: w });
        }

        var distForWeekly = parseNumber(e.distanceKm);
        if (distForWeekly != null && distForWeekly > 0) {
          var monday = getMonday(e.date);
          var mondayStr = monday.toISOString().substring(0,10);
          if (!weeklyKmMap[mondayStr]) weeklyKmMap[mondayStr] = 0;
          weeklyKmMap[mondayStr] += distForWeekly;
        }

        if (!dailyTrimpMap[dateStr]) dailyTrimpMap[dateStr] = 0;
        dailyTrimpMap[dateStr] += trimp;

        if (d >= fourteenDaysAgo && d <= today) {
          var s14 = parseNumber(e.sleepHours);
          var f14 = parseNumber(e.fluidsLiters);
          if (s14 != null) sleepMap[dateStr] = s14;
          if (f14 != null) fluidsMap[dateStr] = f14;
        }
      }

      var avgSleep = countSleep > 0 ? (sumSleep / countSleep) : null;
      var avgFluids = countFluids > 0 ? (sumFluids / countFluids) : null;
      var avgWellbeing = last7WellbeingCount > 0 ? last7WellbeingSum / last7WellbeingCount : null;

      var suppDates = Object.keys(suppMap);
      var suppDaysAll = 0;
      var suppTrackedDays = suppDates.length;
      for (var j = 0; j < suppDates.length; j++) {
        var dStr = suppDates[j];
        var daySupp = suppMap[dStr];
        if (daySupp.omega3 && daySupp.zink && daySupp.magnesium && daySupp.d3) {
          suppDaysAll++;
        }
      }

      function buildTag(current, target, unit, direction) {
        if (direction === undefined) direction = "higher-better";
        if (target == null || current == null) {
          return '<div class="tag-warn">Noch zu wenige Daten oder kein Ziel gesetzt.</div>';
        }
        var diff = current - target;
        var diffAbs = Math.abs(diff).toFixed(1);

        if (direction === "higher-better") {
          if (current >= target * 0.95 && current <= target * 1.1) {
            return '<div class="tag-ok">Sehr nah am Ziel (' + (diff >= 0 ? "+" : "â€“") + diffAbs + ' ' + unit + ')</div>';
          } else if (current >= target * 0.7) {
            return '<div class="tag-warn">Okay, aber noch Luft nach oben (' + (diff >= 0 ? "+" : "â€“") + diffAbs + ' ' + unit + ')</div>';
          } else {
            return '<div class="tag-bad">Deutlich unter Ziel (' + (diff >= 0 ? "+" : "â€“") + diffAbs + ' ' + unit + ')</div>';
          }
        } else {
          if (current <= target * 1.05) {
            return '<div class="tag-ok">Im Zielbereich (' + (diff >= 0 ? "+" : "â€“") + diffAbs + ' ' + unit + ')</div>';
          } else if (current <= target * 1.2) {
            return '<div class="tag-warn">Etwas drÃ¼ber (' + diffAbs + ' ' + unit + ') â€“ beobachten.</div>';
          } else {
            return '<div class="tag-bad">Deutlich drÃ¼ber (' + diffAbs + ' ' + unit + ') â€“ Belastung prÃ¼fen.</div>';
          }
        }
      }

      function buildSuppTag(suppDaysAll, suppTrackedDays) {
        if (suppTrackedDays === 0) {
          return '<div class="tag-warn">Noch keine Tage mit Eintrag in den letzten 7 Tagen.</div>';
        }
        var ratio = suppDaysAll / suppTrackedDays;
        var percent = Math.round(ratio * 100);
        if (ratio >= 0.8) {
          return '<div class="tag-ok">Sehr stabil: an ' + percent + '% der erfassten Tage alle Supplements genommen.</div>';
        } else if (ratio >= 0.5) {
          return '<div class="tag-warn">Okay, aber ausbaufÃ¤hig: an ' + percent + '% der erfassten Tage komplett.</div>';
        } else {
          return '<div class="tag-bad">Erinnerung: Supplements nur an ' + percent + '% der erfassten Tage komplett â€“ wenn sie Teil deiner Strategie sind, gern konstanter.</div>';
        }
      }

      function levelFromScore(score) {
        if (score >= 80) return { label: "GrÃ¼n", className: "tag-ok" };
        if (score >= 60) return { label: "Gelb", className: "tag-warn" };
        return { label: "Rot", className: "tag-bad" };
      }

      var kmScore = 50;
      var sleepScore = 50;
      var fluidsScore = 50;
      var weightScore = 50;
      var loadScore = 50;

      var targetKm = settings.targetKm || 90;

      if (targetKm > 0 && sumKm > 0) {
        var ratioKm = sumKm / targetKm;
        if (ratioKm >= 0.8 && ratioKm <= 1.1) kmScore = 90;
        else if (ratioKm >= 0.6 && ratioKm <= 1.3) kmScore = 75;
        else if (ratioKm >= 0.4 && ratioKm <= 1.6) kmScore = 55;
        else kmScore = 35;
      } else if (sumKm > 0) {
        kmScore = 70;
      }

      var targetSleep = settings.targetSleep || 7.5;
      if (avgSleep != null) {
        var ratioSl = avgSleep / targetSleep;
        if (ratioSl >= 0.95 && ratioSl <= 1.1) sleepScore = 90;
        else if (ratioSl >= 0.8 && ratioSl <= 1.2) sleepScore = 75;
        else if (ratioSl >= 0.6 && ratioSl <= 1.4) sleepScore = 55;
        else sleepScore = 35;
      }

      var targetFluids = settings.targetFluids || 2.5;
      if (avgFluids != null) {
        var ratioFl = avgFluids / targetFluids;
        if (ratioFl >= 0.95 && ratioFl <= 1.1) fluidsScore = 90;
        else if (ratioFl >= 0.8 && ratioFl <= 1.2) fluidsScore = 75;
        else if (ratioFl >= 0.6 && ratioFl <= 1.4) fluidsScore = 55;
        else fluidsScore = 35;
      }

      if (latestWeight && weight30days) {
        var diffW = latestWeight.weight - weight30days.weight;
        var diffAbsW = Math.abs(diffW);
        if (diffAbsW < 0.5) weightScore = 90;
        else if (diffAbsW < 1.5) weightScore = 75;
        else if (diffAbsW < 3) weightScore = 55;
        else weightScore = 35;
      } else if (latestWeight && !weight30days) {
        weightScore = 65;
      }

      if (trimp7 > 0) {
        var ratioLoad = trimp3 / trimp7;
        if (ratioLoad >= 0.35 && ratioLoad <= 0.55) loadScore = 90;
        else if (ratioLoad >= 0.25 && ratioLoad <= 0.65) loadScore = 75;
        else if (ratioLoad >= 0.15 && ratioLoad <= 0.75) loadScore = 55;
        else loadScore = 35;
      }

      var overallScore = Math.round(
        kmScore * 0.4 +
        sleepScore * 0.25 +
        fluidsScore * 0.15 +
        weightScore * 0.1 +
        loadScore * 0.1
      );

      var overallText;
      if (overallScore >= 85) {
        overallText = "Sehr gut im Plan â€“ deine Vorbereitung auf die 230 km wirkt stabil und durchdacht.";
      } else if (overallScore >= 70) {
        overallText = "Gut unterwegs â€“ ein paar Stellschrauben (v.a. Schlaf/Struktur) bringen dich noch ruhiger Richtung Race-Day.";
      } else if (overallScore >= 55) {
        overallText = "Solide Basis, aber noch nicht richtig stabil. Fokus auf Routine, Recovery & klare Wochenstruktur.";
      } else {
        overallText = "Achtung: Vorbereitung wirkt wackelig. Umfang, Schlaf & Hydration bewusst prÃ¼fen, bevor du weiter hochdrehst.";
      }

      var kmLevel = levelFromScore(kmScore);
      var sleepLevel = levelFromScore(sleepScore);
      var fluidsLevel = levelFromScore(fluidsScore);
      var weightLevel = levelFromScore(weightScore);
      var loadLevel = levelFromScore(loadScore);

      var totalXP = computeTotalXP(sorted, settings);
      var progress = getProgressFromXP(totalXP);
      var levelPercent = Math.min(100, Math.max(0, progress.score));

      var summaryHtml = "";

      summaryHtml +=
        '<div class="summary-card">' +
          '<div class="summary-label">Project 230 â€“ Gesamtfortschritt</div>' +
          '<div class="summary-value-big">' + progress.score + ' / 100</div>' +
          '<div class="progress-bar">' +
            '<div class="progress-fill" style="width: ' + levelPercent.toFixed(1) + '%;"></div>' +
          '</div>' +
          '<div class="level-subtext">' +
            'Trainingspunkte gesamt: ' + totalXP + ' Â· basiert auf allen eingetragenen Tagen (Training, Recovery & Supplements).' +
          '</div>' +
          '<div class="' +
            (progress.score >= 80 ? 'tag-ok' : (progress.score >= 60 ? 'tag-warn' : 'tag-bad')) +
          '">' +
            (progress.score >= 80
              ? 'Hoher Vorbereitungsstatus â€“ halte Struktur & Gesundheit im Fokus, dann passt Project 230 sehr gut.'
              : progress.score >= 60
                ? 'Gute Basis â€“ mit etwas mehr Konstanz bei Schlaf/Umfang kannst du den Status weiter ausbauen.'
                : 'Aufbauphase â€“ jede saubere Woche bringt deinen Project-230-Fortschritt deutlich nach vorn.') +
          '</div>' +
        '</div>';

      summaryHtml +=
        '<div class="summary-card">' +
          '<div class="summary-label">Gesamt-Status Vorbereitung (letzte 7 Tage)</div>' +
          '<div class="summary-value-big">' + overallScore + ' / 100</div>' +
          '<div class="' + (overallScore >= 80 ? "tag-ok" : overallScore >= 60 ? "tag-warn" : "tag-bad") + '">' + overallText + '</div>' +
          '<div class="ampel-row">' +
            '<span class="' + kmLevel.className + '">Training (' + kmLevel.label + ')</span>' +
            '<span class="' + sleepLevel.className + '">Schlaf (' + sleepLevel.label + ')</span>' +
            '<span class="' + fluidsLevel.className + '">FlÃ¼ssigkeit (' + fluidsLevel.label + ')</span>' +
            '<span class="' + weightLevel.className + '">Gewicht (' + weightLevel.label + ')</span>' +
            '<span class="' + loadLevel.className + '">Belastung (' + loadLevel.label + ')</span>' +
          '</div>' +
        '</div>';

      summaryHtml +=
        '<div class="summary-card">' +
          '<div class="summary-label">Wochenkilometer (Laufen, letzte 7 Tage)</div>' +
          '<div class="summary-value">' + sumKm.toFixed(1) + ' km</div>' +
          buildTag(sumKm, targetKm, 'km/Woche', 'higher-better') +
        '</div>';

      summaryHtml +=
        '<div class="summary-card">' +
          '<div class="summary-label">Ã˜ Schlaf (letzte 7 Tage)</div>' +
          '<div class="summary-value">' + (avgSleep != null ? avgSleep.toFixed(2) + ' h' : 'â€“') + '</div>' +
          buildTag(avgSleep, targetSleep, 'h/Tag', 'higher-better') +
        '</div>';

      summaryHtml +=
        '<div class="summary-card">' +
          '<div class="summary-label">Ã˜ FlÃ¼ssigkeit (letzte 7 Tage)</div>' +
          '<div class="summary-value">' + (avgFluids != null ? avgFluids.toFixed(2) + ' L' : 'â€“') + '</div>' +
          buildTag(avgFluids, targetFluids, 'L/Tag', 'higher-better') +
        '</div>';

      var weightLine = "â€“";
      var trendTag = '<div class="tag-warn">Noch zu wenige Daten fÃ¼r einen Trend.</div>';

      if (latestWeight) {
        weightLine = latestWeight.weight.toFixed(1) + " kg";
        if (weight30days) {
          var diffW2 = latestWeight.weight - weight30days.weight;
          var diffAbs2 = Math.abs(diffW2).toFixed(1);
          if (Math.abs(diffW2) < 0.5) {
            trendTag = '<div class="tag-ok">Gewicht stabil (Â±' + diffAbs2 + ' kg in 30 Tagen)</div>';
          } else if (diffW2 < 0) {
            trendTag = '<div class="tag-warn">Gewichtsabnahme (' + diffAbs2 + ' kg in 30 Tagen) â€“ passt das zu deinem Plan?</div>';
          } else {
            trendTag = '<div class="tag-warn">Gewichtszunahme (' + diffAbs2 + ' kg in 30 Tagen) â€“ bewusst so geplant?</div>';
          }
        }
      }

      summaryHtml +=
        '<div class="summary-card">' +
          '<div class="summary-label">Aktuelles Gewicht</div>' +
          '<div class="summary-value">' + weightLine + '</div>' +
          trendTag +
        '</div>';

      summaryHtml +=
        '<div class="summary-card">' +
          '<div class="summary-label">Supplements (letzte 7 Tage)</div>' +
          '<div class="summary-value">' +
            (suppTrackedDays > 0 ? (suppDaysAll + ' / ' + suppTrackedDays + ' Tage komplett') : 'â€“') +
          '</div>' +
          buildSuppTag(suppDaysAll, suppTrackedDays) +
        '</div>';

      statsSummaryEl.innerHTML = summaryHtml;

      if (coachFeedbackEl) {
        var hints = [];

        if (kmScore < 60) hints.push("Trainingsumfang langsam, aber stetig steigern â€“ max. ~10 % mehr Wochen-km als in der Vorwoche.");
        else if (kmScore >= 80) hints.push("Training: Wochenkilometer liegen sehr gut im Zielbereich â€“ Konstanz > Heldentaten.");

        if (sleepScore < 60) hints.push("Schlaf: 1â€“2 Abende bewusst frÃ¼her ins Bett, v.a. nach langen oder intensiven Einheiten.");
        else if (sleepScore >= 80) hints.push("Schlaf: Erholung sieht stark aus â€“ weiter so, das gibt viele stille Bonuspunkte.");

        if (fluidsScore < 60) hints.push("Hydration: Trinkmenge leicht erhÃ¶hen (z.B. +0,5 L/Tag), besonders an langen Lauf- oder Indoor-Rad-Tagen.");
        else if (fluidsScore >= 80) hints.push("Hydration: FlÃ¼ssigkeitszufuhr stabil â€“ sehr gut fÃ¼r Ultra-Belastung.");

        if (weightScore < 60 && latestWeight && weight30days) {
          hints.push("Gewichtstrend auffÃ¤llig â€“ Energiezufuhr vs. Trainingsbelastung bewusst checken.");
        }

        if (loadScore < 60 && trimp7 > 0) {
          hints.push("Belastung: nicht zu viele harte Tage nacheinander â€“ maximal 2 sehr intensive Sessions in 3 Tagen.");
        }

        if (avgWellbeing != null && avgWellbeing <= 2.5) {
          hints.push("Wohlbefinden eher niedrig â€“ eventuell Stress / Schlaf / Umfang etwas reduzieren, bevor du in ein echtes Defizit lÃ¤ufst.");
        }

        if (painCountLast7 >= 3) {
          hints.push("Mehrere Tage mit Schmerzen â€“ Umfang/IntensitÃ¤t anpassen, ggf. Physio/Arzt im Hinterkopf behalten.");
        }

        if (suppTrackedDays > 0 && suppDaysAll < suppTrackedDays * 0.6) {
          hints.push("Supplements: Wenn sie bewusst Teil deiner Strategie sind, versuch sie mit einer festen Routine (z.B. FrÃ¼hstÃ¼ck) zu koppeln.");
        }

        coachFeedbackEl.innerHTML =
          "<strong>Coach-Fazit:</strong> " + overallText + "<br>" +
          (hints.length > 0 ? hints.map(function(h){ return "â€¢ " + h; }).join("<br>") :
            "â€¢ Aktuell kein akuter Handlungsbedarf â€“ weiter strukturiert trainieren und auf deinen KÃ¶rper hÃ¶ren.");
      }

      var rowsHtml = "";
      for (var k = 0; k < sorted.length; k++) {
        var e2 = sorted[k];
        rowsHtml +=
          "<tr>" +
            '<td class="nowrap">' + (e2.date || "") + "</td>" +
            "<td>" + (e2.weight != null ? e2.weight : "") + "</td>" +
            "<td>" + (e2.trainingType || "") + "</td>" +
            "<td>" + (e2.distanceKm != null ? e2.distanceKm : "") + "</td>" +
            "<td>" + (e2.durationMin != null ? e2.durationMin : "") + "</td>" +
            "<td>" + (e2.rpe != null ? e2.rpe : "") + "</td>" +
            "<td>" + (e2.sleepHours != null ? e2.sleepHours : "") + "</td>" +
            "<td>" + (e2.fluidsLiters != null ? e2.fluidsLiters : "") + "</td>" +
            "<td>" + (e2.wellbeing != null ? e2.wellbeing : "") + "</td>" +
            "<td>" + (e2.nightRun ? "Ja" : "") + "</td>" +
            "<td>" + (e2.hasPain ? "Ja" : "") + "</td>" +
            "<td>" + (e2.omega3 ? "âœ“" : "") + "</td>" +
            "<td>" + (e2.zink ? "âœ“" : "") + "</td>" +
            "<td>" + (e2.magnesium ? "âœ“" : "") + "</td>" +
            "<td>" + (e2.d3 ? "âœ“" : "") + "</td>" +
            "<td>" + (e2.painNote || "") + "</td>" +
            "<td>" + (e2.comments || "") + "</td>" +
          "</tr>";
      }
      entriesTableBody.innerHTML = rowsHtml;

      updateCoaching({
        sumKm: sumKm,
        targetKm: targetKm,
        trimp7: trimp7,
        trimp3: trimp3,
        avgSleep: avgSleep,
        avgFluids: avgFluids,
        avgWellbeing: avgWellbeing,
        painCountLast7: painCountLast7,
        suppDaysAll: suppDaysAll,
        suppTrackedDays: suppTrackedDays
      }, {
        kmScore: kmScore,
        sleepScore: sleepScore,
        fluidsScore: fluidsScore,
        weightScore: weightScore,
        loadScore: loadScore,
        overallScore: overallScore
      });
    }

    function updateCoaching(metrics, scores) {
      var sumKm = metrics.sumKm || 0;
      var targetKm = metrics.targetKm || 90;
      var trimp7 = metrics.trimp7 || 0;
      var trimp3 = metrics.trimp3 || 0;
      var avgSleep = metrics.avgSleep;
      var avgFluids = metrics.avgFluids;
      var avgWellbeing = metrics.avgWellbeing;
      var painCountLast7 = metrics.painCountLast7 || 0;
      var suppDaysAll = metrics.suppDaysAll || 0;
      var suppTrackedDays = metrics.suppTrackedDays || 0;

      var kmScore = scores.kmScore || 50;
      var sleepScore = scores.sleepScore || 50;
      var fluidsScore = scores.fluidsScore || 50;
      var weightScore = scores.weightScore || 50;
      var loadScore = scores.loadScore || 50;
      var overallScore = scores.overallScore || 50;

      var loadRatio = trimp7 > 0 ? trimp3 / trimp7 : 0;
      var loadFlag = "mittel";
      if (trimp7 > 0 && loadRatio > 0.65) loadFlag = "hoch";
      else if (trimp7 > 0 && loadRatio < 0.25) loadFlag = "niedrig";

      var sleepFlag = "okay";
      if (avgSleep != null) {
        if (avgSleep >= 7) sleepFlag = "gut";
        else if (avgSleep < 6) sleepFlag = "schlecht";
      }

      var fluidsFlag = "okay";
      if (avgFluids != null) {
        if (avgFluids >= 2.5) fluidsFlag = "gut";
        else if (avgFluids < 1.8) fluidsFlag = "schlecht";
      }

      var wellbeingFlag = "neutral";
      if (avgWellbeing != null) {
        if (avgWellbeing >= 4) wellbeingFlag = "gut";
        else if (avgWellbeing <= 2.5) wellbeingFlag = "niedrig";
      }

      var suppFlag = "neutral";
      if (suppTrackedDays > 0) {
        var sr = suppDaysAll / suppTrackedDays;
        if (sr >= 0.8) suppFlag = "gut";
        else if (sr <= 0.4) suppFlag = "niedrig";
      }

      var kmRatio = targetKm > 0 ? sumKm / targetKm : 0;
      var trainingState = "unter";
      if (kmRatio >= 0.8 && kmRatio <= 1.1) trainingState = "imPlan";
      else if (kmRatio > 1.1) trainingState = "drÃ¼ber";

      var dailyTitle = "Empfehlung fÃ¼r morgen";
      var dailyText = "";

      if (painCountLast7 >= 3 || wellbeingFlag === "niedrig" || sleepFlag === "schlecht") {
        dailyTitle = "Morgen: Erholung priorisieren";
        dailyText =
          "Die letzten Tage waren von Schmerzen, niedrigem Wohlbefinden oder wenig Schlaf geprÃ¤gt. " +
          "Empfehlung: Restday oder maximal 30â€“45 Min sehr locker (z.B. lockeres Joggen, Indoor-Rad easy, leichte Stabi), RPE 2â€“3, " +
          "dazu Fokus auf Schlaf & ErnÃ¤hrung â€“ Vorbereitung auf 230 km lÃ¤uft Ã¼ber Gesundheit, nicht Ã¼ber Sturheit.";
      } else if (loadFlag === "hoch") {
        dailyTitle = "Morgen: sehr ruhiger Tag";
        dailyText =
          "Die Belastung der letzten 3 Tage ist im Vergleich zur Wochenbelastung hoch. " +
          "Empfehlung: 40â€“60 Min lockerer Lauf (RPE 3â€“4), easy Indoor-Rad oder kompletter Restday, " +
          "keine Tempo-/IntervallblÃ¶cke. QualitÃ¤t verschiebst du bewusst â€“ dein KÃ¶rper dankt es dir.";
      } else if (trainingState === "unter") {
        dailyTitle = "Morgen: solider Aufbau-Tag";
        dailyText =
          "Deine Wochenkilometer liegen aktuell unter dem Zielbereich. " +
          "Wenn du dich gut fÃ¼hlst: z.B. 10â€“14 km lockerer Dauerlauf (RPE 4â€“5) " +
          "oder 60â€“75 Min Indoor-Rad im Grundlagenbereich. " +
          "Fokus: stabile Struktur, nicht heroische Einzeltage â€“ so wird Project 230 entspannt stÃ¤rker.";
      } else if (trainingState === "drÃ¼ber") {
        dailyTitle = "Morgen: Umfang halten, IntensitÃ¤t runter";
        dailyText =
          "Du liegst diese Woche bereits Ã¼ber deinem Zielumfang. " +
          "Empfehlung: 8â€“10 km sehr entspannt (RPE 3â€“4) oder lockeres Indoor-Rad, " +
          "keine intensiven Passagen. Ziel: System nicht Ã¼berladen â€“ der lange Tag kommt frÃ¼h genug.";
      } else {
        dailyTitle = "Morgen: kontrollierter Trainingsreiz";
        dailyText =
          "Belastung, Schlaf & Hydration sehen solide aus. " +
          "Empfehlung: z.B. 10â€“12 km, davon 4â€“6 km etwas zÃ¼giger (RPE 6), Rest locker, " +
          "oder eine moderat fordernde Box-/Athletik-Session mit gutem Warm-up & Cool-down. " +
          "Keine Vollgas-Orgie, eher kontrolliert flott â€“ so sammelst du Trainingspunkte ohne Ã¼berzudrehen.";
      }

      if (suppFlag === "niedrig") {
        dailyText +=
          "<br><br>Bonus: Wenn Omega 3, Zink, Magnesium & D3 Teil deines Setups sein sollen, " +
          "koppel die Einnahme an eine feste Routine (z.B. FrÃ¼hstÃ¼ck oder ZÃ¤hneputzen), damit es automatisch mitlÃ¤uft.";
      }

      if (!entries || entries.length < 3) {
        dailyTitle = "Morgen: Datenbasis noch dÃ¼nn";
        dailyText =
          "Trage ein paar Tage Training, Schlaf, FlÃ¼ssigkeit & Supplements ein. " +
          "Sobald mindestens 3â€“5 EintrÃ¤ge da sind, werden Score & Empfehlungen deutlich genauer.";
      }

      dailyCoachTitleEl.textContent = dailyTitle;
      dailyCoachTextEl.innerHTML = dailyText;

      var weeklyTitle = "Wochenplan basierend auf letzter Woche";
      var weeklyText = "";

      if (!entries || entries.length < 7) {
        weeklyText =
          "Noch nicht genug Daten fÃ¼r eine verlÃ¤ssliche Wochenanalyse. " +
          "Sobald 1â€“2 Wochen voll getrackt sind, bekommst du einen strukturierten Wochenplan " +
          "(inkl. langem Lauf, evtl. Back-to-back, Indoor-Rad & Box-/Kraftanteilen), der dich Schritt fÃ¼r Schritt Richtung TorTour schiebt.";
        weeklyCoachTitleEl.textContent = weeklyTitle;
        weeklyCoachTextEl.innerHTML = weeklyText;
        return;
      }

      if (kmRatio < 0.6) {
        weeklyText =
          "Deine letzte Woche lag klar unter deinem Zielumfang (~" + (kmRatio*100).toFixed(0) + " % vom Ziel, bezogen auf Laufen).<br>" +
          "<strong>Empfohlener Fokus fÃ¼r diese Woche:</strong><br>" +
          "â€¢ Ziel: ca. " + (targetKm * 0.7).toFixed(0) + "â€“" + (targetKm * 0.85).toFixed(0) + " Lauf-km<br>" +
          "â€¢ 3â€“4 lockere LÃ¤ufe (RPE 3â€“5) Ã  8â€“12 km<br>" +
          "â€¢ 1 Langer Lauf um 22â€“26 km<br>" +
          "â€¢ 1â€“2 Einheiten Indoor-Rad oder Fitnessboxen als ergÃ¤nzendes Ausdauer-/Stabi-Training<br>" +
          "â€¢ Keine brutalen Intervalle â€“ erst Routine & solide Basis aufbauen.";
      } else if (kmRatio >= 0.6 && kmRatio <= 1.1 && loadScore >= 60) {
        weeklyText =
          "Deine letzte Woche liegt im sinnvollen Bereich und die Belastungssteuerung sieht brauchbar aus.<br>" +
          "<strong>Empfohlener Wochenplan:</strong><br>" +
          "â€¢ Ziel: ca. " + targetKm.toFixed(0) + " Lauf-km<br>" +
          "â€¢ 3 lockere LÃ¤ufe Ã  10â€“12 km (RPE 3â€“5)<br>" +
          "â€¢ 1 QualitÃ¤tseinheit (z.B. 6Ã—3 Min zÃ¼gig, RPE 6â€“7, mit lockerem Ein-/Auslaufen)<br>" +
          "â€¢ 1 Langer Lauf: 26â€“34 km<br>" +
          "â€¢ 1â€“2 ergÃ¤nzende Sessions: Indoor-Rad (Grundlagenbereich) oder Fitnessboxen / Kraft<br>" +
          "â€¢ Alle 2â€“3 Wochen: Langer Lauf als Nachtlauf (Checkbox â€žNachtlaufâ€œ) + bewusst ruhigere Tage danach.";
      } else if (kmRatio > 1.1 && loadScore >= 60) {
        weeklyText =
          "Du warst letzte Woche eher im oberen Bereich (~" + (kmRatio*100).toFixed(0) + " % vom Zielumfang).<br>" +
          "<strong>Empfohlene Woche (leicht gebremst):</strong><br>" +
          "â€¢ Ziel: " + (targetKm*0.8).toFixed(0) + "â€“" + (targetKm*0.9).toFixed(0) + " Lauf-km<br>" +
          "â€¢ 3 lockere LÃ¤ufe Ã  8â€“12 km<br>" +
          "â€¢ 1 moderater Langer Lauf: 22â€“28 km<br>" +
          "â€¢ QualitÃ¤t sehr gezielt: max. 1 kÃ¼rzere Tempoeinheit, ansonsten Fokus auf frische Beine & Schlaf<br>" +
          "â€¢ ErgÃ¤nzend: lockeres Indoor-Rad statt zusÃ¤tzlicher harter Laufeinheiten.";
      } else {
        weeklyText =
          "Die Kombination aus Umfang & Belastung ist etwas unausgeglichen.<br>" +
          "<strong>Empfehlung:</strong><br>" +
          "â€¢ Umfang leicht reduzieren, Schlaf & Hydration hochziehen.<br>" +
          "â€¢ 3â€“4 Einheiten locker, 1 Langer Lauf, maximal 1 wirklich harter Tag.<br>" +
          "â€¢ Alternativ: harte Laufeinheiten gelegentlich durch fordernde, aber gelenkschonendere Sessions (Indoor-Rad / Boxen) ersetzen.";
      }

      if (painCountLast7 >= 3) {
        weeklyText += "<br><strong>Zusatz:</strong> Mehrere Tage mit Schmerzen â†’ eher eine Deload-Woche (50â€“60 % Umfang, kein High-Intensity). Vorbereitung auf 230 km funktioniert nur mit einem KÃ¶rper, der mitmacht.";
      }

      if (suppTrackedDays > 0 && suppDaysAll < suppTrackedDays * 0.6) {
        weeklyText += "<br><br><strong>Supplements:</strong> Wenn Omega 3, Zink, Magnesium & D3 bewusst Teil deiner Strategie sind, lohnt sich eine simple Routine (z.B. Wochenbox + fester Tageszeitpunkt).";
      }

      weeklyCoachTitleEl.textContent = weeklyTitle;
      weeklyCoachTextEl.innerHTML = weeklyText;
    }

    function addEntry() {
      var dateVal = entryDateInput.value || new Date().toISOString().substring(0,10);

      var entry = {
        date: dateVal,
        weight: weightInput.value ? parseNumber(weightInput.value) : null,
        trainingType: trainingTypeInput.value || "",
        distanceKm: distanceKmInput.value ? parseNumber(distanceKmInput.value) : null,
        durationMin: durationMinInput.value ? parseNumber(durationMinInput.value) : null,
        rpe: rpeInput.value ? parseNumber(rpeInput.value) : null,
        sleepHours: sleepHoursInput.value ? parseNumber(sleepHoursInput.value) : null,
        sleepQuality: sleepQualityInput.value || "",
        fluidsLiters: fluidsLitersInput.value ? parseNumber(fluidsLitersInput.value) : null,
        wellbeing: wellbeingInput.value ? parseNumber(wellbeingInput.value) : null,
        nightRun: nightRunInput.checked,
        hasPain: hasPainInput.checked,
        omega3: suppOmega3Input.checked,
        zink: suppZinkInput.checked,
        magnesium: suppMagnesiumInput.checked,
        d3: suppD3Input.checked,
        painNote: painNoteInput.value || "",
        comments: commentsInput.value || ""
      };

      entries.push(entry);
      saveState(STORAGE_ENTRIES_KEY, entries);

      trainingTypeInput.value = "";
      distanceKmInput.value = "";
      durationMinInput.value = "";
      rpeInput.value = "";
      wellbeingInput.value = "";
      nightRunInput.checked = false;
      hasPainInput.checked = false;
      suppOmega3Input.checked = false;
      suppZinkInput.checked = false;
      suppMagnesiumInput.checked = false;
      suppD3Input.checked = false;
      painNoteInput.value = "";
      commentsInput.value = "";

      updateStats();
    }

    function fillToday() {
      var todayStr = new Date().toISOString().substring(0,10);
      entryDateInput.value = todayStr;
    }

    function clearAllData() {
      if (!confirm("Wirklich alle Daten (EintrÃ¤ge & Einstellungen) lÃ¶schen? Das kann nicht rÃ¼ckgÃ¤ngig gemacht werden.")) {
        return;
      }
      entries = [];
      settings = {
        raceDate: "",
        targetKm: 90,
        targetSleep: 7.5,
        targetFluids: 2.5
      };
      saveState(STORAGE_ENTRIES_KEY, entries);
      saveState(STORAGE_SETTINGS_KEY, settings);
      initSettingsUI();
      updateRaceSummary();
      updateStats();
    }

    saveSettingsBtn.addEventListener("click", saveSettings);
    addEntryBtn.addEventListener("click", addEntry);
    fillTodayBtn.addEventListener("click", fillToday);
    clearDataLink.addEventListener("click", clearAllData);

    exportJsonBtn.addEventListener("click", exportJSON);
    exportCsvBtn.addEventListener("click", exportCSV);
    importJsonBtn.addEventListener("click", triggerImport);
    importJsonInput.addEventListener("change", handleImportFile);

    (function init() {
      if (!entryDateInput.value) {
        entryDateInput.value = new Date().toISOString().substring(0,10);
      }
      initSettingsUI();
      updateRaceSummary();
      updateStats();
    })();
  </script>
</body>
</html>

