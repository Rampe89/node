<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Project 230 â€“ TorTour de Ruhr Prep Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --bg-alt: #020617;
      --card: #02091a;
      --accent: #38bdf8;
      --accent2: #22c55e;
      --accent-soft: rgba(56, 189, 248, 0.2);
      --text: #e5e7eb;
      --text-muted: #9ca3af;
      --danger: #f97373;
      --warning: #fb923c;
      --radius: 14px;
      --shadow: 0 22px 50px rgba(15,23,42,0.9);
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background:
        radial-gradient(circle at top, #0f172a 0, #020617 55%),
        radial-gradient(circle at bottom, #020617 0, #000 65%);
      color: var(--text);
    }

    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 16px;
    }

    header h1 {
      margin: 0;
      font-size: 1.9rem;
      letter-spacing: 0.06em;
      display: flex;
      align-items: center;
      gap: 10px;
      text-transform: uppercase;
    }

    header h1 span.logo {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 38px;
      height: 38px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 20%, #38bdf8, #0ea5e9 40%, #4c1d95 100%);
      color: #f9fafb;
      font-size: 1.3rem;
      font-weight: 800;
      box-shadow:
        0 0 25px rgba(56,189,248,0.8),
        0 0 55px rgba(14,165,233,0.8);
      border: 1px solid rgba(186,230,253,0.9);
    }

    header p {
      margin: 4px 0 0;
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    .pill {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      color: var(--text-muted);
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: radial-gradient(circle at top left, rgba(56,189,248,0.25), transparent 55%),
                  rgba(15,23,42,0.95);
      backdrop-filter: blur(12px);
    }

    .pill strong {
      color: var(--accent);
    }

    .grid {
      display: grid;
      grid-template-columns: 2fr 3fr;
      gap: 24px;
      margin-bottom: 24px;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background:
        radial-gradient(circle at top left, rgba(56,189,248,0.12), transparent 55%),
        radial-gradient(circle at bottom right, rgba(124,58,237,0.14), transparent 55%),
        var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px 18px 20px;
      border: 1px solid rgba(30,64,175,0.8);
      position: relative;
      overflow: hidden;
      margin-top: 8px;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(56,189,248,0.08), transparent 60%);
      opacity: 0.6;
      pointer-events: none;
    }

    .card > * {
      position: relative;
      z-index: 1;
    }

    .card h2 {
      margin: 0 0 8px;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-weight: 600;
    }

    .card h2 span {
      font-size: 0.75rem;
      font-weight: 400;
      color: var(--text-muted);
      text-transform: none;
      letter-spacing: normal;
    }

    .small {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    label {
      display: block;
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    input, select, textarea {
      width: 100%;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid rgba(30,64,175,0.9);
      background: rgba(15,23,42,0.94);
      color: var(--text);
      font-size: 0.85rem;
    }

    input:focus, select:focus, textarea:focus {
      outline: 1px solid var(--accent);
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.3);
    }

    textarea {
      resize: vertical;
      min-height: 40px;
      max-height: 120px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px 14px;
      margin-top: 10px;
    }

    .inline-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .inline-row input[type="checkbox"] {
      width: auto;
    }

    .btn-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .btn-group-right {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 7px 16px;
      font-size: 0.85rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #38bdf8, #22c55e);
      color: #020617;
      box-shadow:
        0 12px 22px rgba(56,189,248,0.5),
        0 0 30px rgba(34,197,94,0.6);
    }

    .btn-secondary {
      background: rgba(15,23,42,0.9);
      color: var(--text-muted);
      border: 1px solid rgba(30,64,175,0.9);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-muted);
      border: 1px dashed rgba(148,163,184,0.4);
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 8px;
    }

    .summary-card {
      border-radius: 10px;
      padding: 10px 10px;
      background: radial-gradient(circle at top, rgba(15,23,42,0.9), rgba(15,23,42,0.92));
      border: 1px solid rgba(30,64,175,0.9);
    }

    .summary-label {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .summary-value {
      font-size: 1.05rem;
      font-weight: 600;
    }

    .summary-value-big {
      font-size: 1.6rem;
      font-weight: 800;
    }

    .tag-ok {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.75rem;
      background: var(--accent-soft);
      color: var(--accent);
      display: inline-flex;
      align-items: center;
      margin-top: 4px;
      border: 1px solid rgba(56,189,248,0.6);
    }

    .tag-warn {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.75rem;
      background: rgba(248,250,252,0.02);
      color: var(--warning);
      border: 1px solid rgba(249,115,22,0.45);
      display: inline-flex;
      align-items: center;
      margin-top: 4px;
    }

    .tag-bad {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.75rem;
      background: rgba(248,113,113,0.08);
      color: var(--danger);
      border: 1px solid rgba(248,113,113,0.6);
      display: inline-flex;
      align-items: center;
      margin-top: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.8rem;
    }

    thead {
      background: rgba(15,23,42,0.95);
    }

    th, td {
      padding: 6px 6px;
      border-bottom: 1px solid rgba(30,64,175,0.6);
      text-align: left;
      white-space: nowrap;
    }

    th {
      position: sticky;
      top: 0;
      background: rgba(15,23,42,0.97);
      z-index: 1;
    }

    tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.85);
    }

    .table-wrapper {
      max-height: 360px;
      overflow: auto;
      margin-top: 4px;
      border-radius: 10px;
      border: 1px solid rgba(30,64,175,0.8);
      background: rgba(15,23,42,0.9);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.4);
      font-size: 0.75rem;
      color: var(--text-muted);
      gap: 6px;
    }

    .chip-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 8px rgba(56,189,248,0.8);
    }

    .hint {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .danger-link {
      color: var(--danger);
      text-decoration: underline;
      cursor: pointer;
      font-size: 0.78rem;
    }

    .nowrap {
      white-space: nowrap;
    }

    .ampel-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .chart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-top: 8px;
    }

    .chart-card {
      background: rgba(15,23,42,0.9);
      border-radius: 10px;
      padding: 10px;
      border: 1px solid rgba(30,64,175,0.9);
    }

    .chart-card-title {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    canvas {
      width: 100%;
      height: 180px;
    }

    .coach-text {
      font-size: 0.8rem;
      line-height: 1.4;
      margin-top: 4px;
    }

    /* Progressbar */
    .progress-bar {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(30,64,175,0.9);
      overflow: hidden;
      margin-top: 6px;
    }

    .progress-fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #38bdf8, #22c55e);
      width: 0%;
      transition: width 0.4s ease-out;
      box-shadow:
        0 0 14px rgba(56,189,248,0.9),
        0 0 22px rgba(34,197,94,0.7);
    }

    .level-subtext {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* Hidden file input for import */
    #importJsonInput {
      display: none;
    }

    .today-status-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }

    .status-pill {
      border-radius: 999px;
      padding: 3px 10px;
      font-size: 0.75rem;
      border: 1px solid rgba(148,163,184,0.4);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot-ok {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34,197,94,0.8);
    }

    .status-dot-warn {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #fb923c;
      box-shadow: 0 0 8px rgba(249,115,22,0.8);
    }

    .status-dot-bad {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #f97373;
      box-shadow: 0 0 8px rgba(248,113,113,0.8);
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>
          <span class="logo">P230</span>
          Project 230 â€“ TorTour Prep
        </h1>
        <p>Dein Board fÃ¼r 230 km: Training, Recovery, Alltag & TorTour-Vorbereitung â€“ alles lokal.</p>
      </div>
      <div>
        <div class="pill">
          <span>Projekt:</span><strong>TorTour de Ruhr Â· 230 km</strong>
        </div>
      </div>
    </header>

    <!-- Heute-Ãœbersicht -->
    <section class="card" id="todayCard">
      <h2>Heute <span id="todayDateLabel">â€“</span></h2>
      <p class="small">
        Kurzer Blick: Ist fÃ¼r heute schon alles drin? Gewicht, Training, Schlaf, FlÃ¼ssigkeit, Supplements.
      </p>
      <div id="todayOverview">
        <!-- per JS -->
      </div>
      <div class="btn-row" style="margin-top: 10px;">
        <span class="hint">Tipp: Eintrag fÃ¼r heute dauert realistisch 30â€“60 Sekunden.</span>
        <div class="btn-group-right">
          <button class="btn-secondary" id="goTodayBtn">Heute ins Formular Ã¼bernehmen</button>
          <button class="btn-ghost" id="copyLastDayBtn">Letzten Tag Ã¼bernehmen</button>
        </div>
      </div>
    </section>

    <!-- Einstellungen & Check-in -->
    <div class="grid">
      <section class="card">
        <h2>TorTour-Einstellungen <span>Race Â· Zielbereiche Â· Backup</span></h2>
        <p class="small">
          Setze Renn-Datum & Zielbereiche â€“ und sichere deine Daten per Export, falls der Browser mal leergerÃ¤umt wird.
        </p>
        <div class="settings-grid">
          <div>
            <label for="raceDate">Renn-Datum (TorTour de Ruhr)</label>
            <input type="date" id="raceDate" />
          </div>
          <div>
            <label for="targetKm">Ziel-Wochenkilometer (Laufen)</label>
            <input type="number" id="targetKm" min="0" step="1" placeholder="Standard: 90" />
          </div>
          <div>
            <label for="targetSleep">Ziel-Schlaf (Ã˜ h / Tag)</label>
            <input type="number" id="targetSleep" min="0" step="0.1" placeholder="z.B. 7.5" />
          </div>
          <div>
            <label for="targetFluids">Ziel-FlÃ¼ssigkeit (Ã˜ L / Tag)</label>
            <input type="number" id="targetFluids" min="0" step="0.1" placeholder="z.B. 2.5" />
          </div>
        </div>

        <div class="btn-row" style="margin-top: 10px;">
          <div class="btn-group-right">
            <button class="btn-secondary" id="saveSettingsBtn">Einstellungen speichern</button>
          </div>
          <div class="btn-group-right">
            <button class="btn-ghost" id="exportJsonBtn">Backup exportieren (JSON)</button>
            <button class="btn-ghost" id="exportCsvBtn">Daten exportieren (CSV)</button>
            <button class="btn-ghost" id="importJsonBtn">Backup importieren</button>
            <input type="file" id="importJsonInput" accept="application/json" />
          </div>
        </div>

        <div class="summary-grid" id="raceSummary">
          <!-- per JS -->
        </div>
        <p class="hint">
          Backup-Tipp: Alle paar Wochen JSON sichern, dann kannst du Project 230 auch auf anderen GerÃ¤ten laden.
        </p>
      </section>

      <section class="card">
        <h2>Neuen Tag eintragen <span>TÃ¤gliches Log</span></h2>
        <p class="small">Einmal kurz loggen â€“ das Dashboard kÃ¼mmert sich um Auswertung, Level & Empfehlungen.</p>

        <div class="form-grid">
          <div>
            <label for="entryDate">Datum</label>
            <input type="date" id="entryDate" />
          </div>

          <div>
            <label for="weight">Gewicht (kg)</label>
            <input type="number" id="weight" step="0.1" min="0" />
          </div>

          <div>
            <label for="trainingType">Training (Art)</label>
            <select id="trainingType">
              <option value="">â€“ Kein Training / Rest â€“</option>
              <option value="Langer Lauf">Langer Lauf</option>
              <option value="Intervall">Intervall</option>
              <option value="Tempo">Tempolauf</option>
              <option value="Locker">Lockerer Lauf</option>
              <option value="Kraft">Kraft / Stabi</option>
              <option value="Cross">Cross / Alternativ</option>
              <option value="Indoor Rad">Indoor Rad</option>
              <option value="Fitnessboxen">Fitnessboxen</option>
              <option value="Wettkampf">Wettkampf / Test</option>
            </select>
          </div>

          <div>
            <label for="distanceKm">Distanz (km, Lauf)</label>
            <input type="number" id="distanceKm" step="0.1" min="0" />
          </div>

          <div>
            <label for="durationMin">Dauer (Minuten)</label>
            <input type="number" id="durationMin" step="1" min="0" />
          </div>

          <div>
            <label for="rpe">Belastung (RPE 1â€“10)</label>
            <input type="number" id="rpe" step="1" min="1" max="10" />
          </div>

          <div>
            <label for="sleepHours">Schlaf (Stunden)</label>
            <input type="number" id="sleepHours" step="0.1" min="0" />
          </div>

          <div>
            <label for="sleepQuality">Schlaf-QualitÃ¤t</label>
            <select id="sleepQuality">
              <option value="">â€“</option>
              <option value="sehr gut">sehr gut</option>
              <option value="gut">gut</option>
              <option value="okay">okay</option>
              <option value="schlecht">schlecht</option>
            </select>
          </div>

          <div>
            <label for="fluidsLiters">FlÃ¼ssigkeit (L)</label>
            <input type="number" id="fluidsLiters" step="0.1" min="0" />
          </div>

          <div>
            <label for="wellbeing">Wohlbefinden (1 = mies, 5 = top)</label>
            <select id="wellbeing">
              <option value="">â€“</option>
              <option value="1">1 â€“ sehr schlecht</option>
              <option value="2">2</option>
              <option value="3">3 â€“ neutral</option>
              <option value="4">4</option>
              <option value="5">5 â€“ sehr gut</option>
            </select>
          </div>

          <div>
            <label>&nbsp;</label>
            <div class="inline-row">
              <input type="checkbox" id="nightRun" />
              <span>Nachtlauf</span>
            </div>
            <div class="inline-row">
              <input type="checkbox" id="hasPain" />
              <span>Schmerzen heute?</span>
            </div>
          </div>

          <div>
            <label>Supplements heute</label>
            <div class="inline-row">
              <input type="checkbox" id="suppOmega3" />
              <span>Omega 3</span>
            </div>
            <div class="inline-row">
              <input type="checkbox" id="suppZink" />
              <span>Zink</span>
            </div>
            <div class="inline-row">
              <input type="checkbox" id="suppMagnesium" />
              <span>Magnesium</span>
            </div>
            <div class="inline-row">
              <input type="checkbox" id="suppD3" />
              <span>Vitamin D3</span>
            </div>
          </div>

          <div style="grid-column: 1 / -1;">
            <label for="painNote">Schmerz / Beschwerden (optional)</label>
            <textarea id="painNote" placeholder="z.B. rechtes Knie, Achillessehne, Magen, mental mÃ¼de â€¦"></textarea>
          </div>

          <div style="grid-column: 1 / -1;">
            <label for="comments">Weitere Notizen</label>
            <textarea id="comments" placeholder="Was lief gut? Was war schwer? Was hast du gelernt?"></textarea>
          </div>
        </div>

        <div class="btn-row">
          <span class="hint">
            Alles wird lokal im Browser gespeichert (<code>localStorage</code>). Kein Upload, kein Server.
            <span class="danger-link" id="clearDataLink">Alle Daten lÃ¶schen</span>
          </span>
          <div class="btn-group-right">
            <button class="btn-secondary" id="fillTodayBtn">Heute Ã¼bernehmen</button>
            <button class="btn-primary" id="addEntryBtn">Eintrag speichern</button>
          </div>
        </div>
      </section>
    </div>

    <!-- Auswertung 7 Tage + Level -->
    <section class="card">
      <h2>Auswertung letzte 7 Tage <span>Training Â· Recovery Â· Project-230-Level</span></h2>

      <div class="summary-grid" id="statsSummary">
        <!-- per JS -->
      </div>

      <p class="hint">
        Ziel: stabile Wochenstruktur, gute Recovery & kontinuierlicher Fortschritt Richtung TorTour-Tag.
      </p>
      <div id="coachFeedback" class="hint"></div>
    </section>

    <!-- Coaching-Empfehlungen -->
    <section class="card" style="margin-top:20px;">
      <h2>Coach-Empfehlungen <span>Tages- & Wochen-Fokus</span></h2>
      <div class="summary-grid">
        <div class="summary-card">
          <div class="summary-label">Empfehlung fÃ¼r morgen</div>
          <div class="summary-value" id="dailyCoachTitle">Wird aus deinen Daten berechnet â€¦</div>
          <div class="coach-text" id="dailyCoachText"></div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Wochen-Coaching</div>
          <div class="summary-value" id="weeklyCoachTitle">Wochenplan basierend auf letzter Woche</div>
          <div class="coach-text" id="weeklyCoachText"></div>
        </div>
      </div>
      <p class="hint">
        Empfehlungen basieren auf Wochenkilometern (Laufen), Belastung, Schlaf, FlÃ¼ssigkeit, Wohlbefinden, Beschwerden & Supplements.
      </p>
    </section>

    <!-- Visualisierung -->
    <section class="card" style="margin-top:20px;">
      <h2>Visualisierung <span>Trends Â· Belastung Â· Progress</span></h2>
      <div class="chart-grid">
        <div class="chart-card">
          <div class="chart-card-title">Wochenkilometer (Laufen) vs. Ziel</div>
          <canvas id="weeklyKmChart"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-card-title">Belastung (TRIMP-light, 7-Tage-Summe)</div>
          <canvas id="trimpChart"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-card-title">Schlaf & FlÃ¼ssigkeit (letzte 14 Tage)</div>
          <canvas id="sleepHydrationChart"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-card-title">Gewicht Ã¼ber die Zeit</div>
          <canvas id="weightChart"></canvas>
        </div>
      </div>
    </section>

    <!-- Rohdaten -->
    <section class="card" style="margin-top: 20px;">
      <h2>Alle EintrÃ¤ge <span>Project-230-Log â€“ scroll- & filterbar</span></h2>
      <div class="chip" style="margin-bottom: 6px;">
        <span class="chip-dot"></span>
        <span>Datenbasis fÃ¼r deine TorTour-Vorbereitung & deinen Alltag</span>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Datum</th>
              <th>Gewicht</th>
              <th>Training</th>
              <th>km</th>
              <th>Dauer</th>
              <th>RPE</th>
              <th>Schlaf (h)</th>
              <th>FlÃ¼ssigkeit (L)</th>
              <th>Wohlbef.</th>
              <th>Nacht?</th>
              <th>Schmerz?</th>
              <th>Omega 3</th>
              <th>Zink</th>
              <th>Magnesium</th>
              <th>D3</th>
              <th>Schmerz-Notiz</th>
              <th>Weitere Notizen</th>
            </tr>
          </thead>
          <tbody id="entriesTableBody">
            <!-- per JS -->
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // --- Helper ---
    function parseNumber(value) {
      if (value === null || value === undefined) return null;
      const v = String(value).replace(',', '.').trim();
      if (v === '') return null;
      const num = parseFloat(v);
      return isNaN(num) ? null : num;
    }

    function saveState(key, data) {
      localStorage.setItem(key, JSON.stringify(data));
    }

    function loadState(key, fallback) {
      const raw = localStorage.getItem(key);
      if (!raw) return fallback;
      try {
        return JSON.parse(raw);
      } catch (e) {
        console.warn('Konnte State nicht lesen:', key, e);
        return fallback;
      }
    }

    const STORAGE_ENTRIES_KEY = "ttdr_entries_v3";
    const STORAGE_SETTINGS_KEY = "ttdr_settings_v1";

    let entries = loadState(STORAGE_ENTRIES_KEY, []);
    let settings = loadState(STORAGE_SETTINGS_KEY, {
      raceDate: "",
      targetKm: 90,
      targetSleep: 7.5,
      targetFluids: 2.5
    });

    // --- DOM ---
    const raceDateInput = document.getElementById("raceDate");
    const targetKmInput = document.getElementById("targetKm");
    const targetSleepInput = document.getElementById("targetSleep");
    const targetFluidsInput = document.getElementById("targetFluids");
    const raceSummaryEl = document.getElementById("raceSummary");

    const entryDateInput = document.getElementById("entryDate");
    const weightInput = document.getElementById("weight");
    const trainingTypeInput = document.getElementById("trainingType");
    const distanceKmInput = document.getElementById("distanceKm");
    const durationMinInput = document.getElementById("durationMin");
    const rpeInput = document.getElementById("rpe");
    const sleepHoursInput = document.getElementById("sleepHours");
    const sleepQualityInput = document.getElementById("sleepQuality");
    const fluidsLitersInput = document.getElementById("fluidsLiters");
    const wellbeingInput = document.getElementById("wellbeing");
    const nightRunInput = document.getElementById("nightRun");
    const hasPainInput = document.getElementById("hasPain");
    const painNoteInput = document.getElementById("painNote");
    const commentsInput = document.getElementById("comments");
    const suppOmega3Input = document.getElementById("suppOmega3");
    const suppZinkInput = document.getElementById("suppZink");
    const suppMagnesiumInput = document.getElementById("suppMagnesium");
    const suppD3Input = document.getElementById("suppD3");

    const saveSettingsBtn = document.getElementById("saveSettingsBtn");
    const fillTodayBtn = document.getElementById("fillTodayBtn");
    const addEntryBtn = document.getElementById("addEntryBtn");
    const clearDataLink = document.getElementById("clearDataLink");

    const exportJsonBtn = document.getElementById("exportJsonBtn");
    const exportCsvBtn = document.getElementById("exportCsvBtn");
    const importJsonBtn = document.getElementById("importJsonBtn");
    const importJsonInput = document.getElementById("importJsonInput");

    const statsSummaryEl = document.getElementById("statsSummary");
    const entriesTableBody = document.getElementById("entriesTableBody");
    const coachFeedbackEl = document.getElementById("coachFeedback");

    const dailyCoachTitleEl = document.getElementById("dailyCoachTitle");
    const dailyCoachTextEl = document.getElementById("dailyCoachText");
    const weeklyCoachTitleEl = document.getElementById("weeklyCoachTitle");
    const weeklyCoachTextEl = document.getElementById("weeklyCoachText");

    const todayDateLabel = document.getElementById("todayDateLabel");
    const todayOverviewEl = document.getElementById("todayOverview");
    const goTodayBtn = document.getElementById("goTodayBtn");
    const copyLastDayBtn = document.getElementById("copyLastDayBtn");

    // Charts
    let weeklyKmChart = null;
    let trimpChart = null;
    let sleepHydrationChart = null;
    let weightChart = null;

    // --- Settings UI ---
    function initSettingsUI() {
      if (settings.raceDate) raceDateInput.value = settings.raceDate;
      if (settings.targetKm != null) targetKmInput.value = settings.targetKm;
      if (settings.targetSleep != null) targetSleepInput.value = settings.targetSleep;
      if (settings.targetFluids != null) targetFluidsInput.value = settings.targetFluids;
    }

    function saveSettings() {
      settings.raceDate = raceDateInput.value || "";
      settings.targetKm = parseNumber(targetKmInput.value) ?? 90;
      settings.targetSleep = parseNumber(targetSleepInput.value) ?? 7.5;
      settings.targetFluids = parseNumber(targetFluidsInput.value) ?? 2.5;

      saveState(STORAGE_SETTINGS_KEY, settings);
      updateRaceSummary();
      updateStats();
    }

    function updateRaceSummary() {
      raceSummaryEl.innerHTML = "";

      const today = new Date();
      today.setHours(0,0,0,0);

      const raceDateStr = settings.raceDate;
      let blocks = "";

      if (raceDateStr) {
        const raceDate = new Date(raceDateStr + "T00:00:00");
        const diffMs = raceDate.getTime() - today.getTime();
        const diffDays = Math.round(diffMs / (1000 * 60 * 60 * 24));

        let statusText = "";
        let tagClass = "tag-ok";

        if (diffDays > 0) {
          statusText = diffDays + " Tage bis zur TorTour";
          if (diffDays < 7) {
            tagClass = "tag-bad";
            statusText = "Race Week â€“ " + diffDays + " Tage";
          } else if (diffDays < 30) {
            tagClass = "tag-warn";
          }
        } else if (diffDays === 0) {
          statusText = "HEUTE ist TorTour-Day!";
          tagClass = "tag-bad";
        } else {
          statusText = "Rennen liegt " + Math.abs(diffDays) + " Tage zurÃ¼ck";
          tagClass = "tag-warn";
        }

        blocks += `
          <div class="summary-card">
            <div class="summary-label">Race-Countdown</div>
            <div class="summary-value">${statusText}</div>
            <div class="${tagClass}">Race Date: ${raceDate.toLocaleDateString("de-DE")}</div>
          </div>
        `;
      } else {
        blocks += `
          <div class="summary-card">
            <div class="summary-label">Race-Countdown</div>
            <div class="summary-value">Noch kein Datum gesetzt</div>
            <div class="tag-warn">Trage das Renn-Datum ein, um den Countdown zu aktivieren.</div>
          </div>
        `;
      }

      blocks += `
        <div class="summary-card">
          <div class="summary-label">Ziel-Wochenkilometer</div>
          <div class="summary-value">${settings.targetKm != null ? settings.targetKm + " km" : "90 km (Standard)"}</div>
          <div class="tag-ok">Solider Ultra-Bereich fÃ¼r deine TorTour-Basis.</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Ziel-Schlaf</div>
          <div class="summary-value">${settings.targetSleep != null ? settings.targetSleep + " h / Tag" : "7.5 h / Tag"}</div>
          <div class="tag-ok">Recovery-Fokus â€“ Schlaf ist dein wichtigster Regenerationsfaktor.</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Ziel-FlÃ¼ssigkeit</div>
          <div class="summary-value">${settings.targetFluids != null ? settings.targetFluids + " L / Tag" : "2.5 L / Tag"}</div>
          <div class="tag-ok">Hydration als Grundlage fÃ¼r lange Sessions.</div>
        </div>
      `;

      raceSummaryEl.innerHTML = blocks;
    }

    // Helper: Montag der Woche eines Datums
    function getMonday(dateString) {
      const d = new Date(dateString + "T00:00:00");
      const day = d.getDay(); // 0=So,1=Mo
      const diff = (day === 0 ? -6 : 1 - day);
      d.setDate(d.getDate() + diff);
      d.setHours(0,0,0,0);
      return d;
    }

    function formatDateShort(dateString) {
      const d = new Date(dateString + "T00:00:00");
      return d.toLocaleDateString("de-DE", { day: "2-digit", month: "2-digit" });
    }

    // --- Level / XP-Berechnung ---
    function computeDailyXP(entry, settings) {
      const targetKm = settings.targetKm || 90;
      const targetSleep = settings.targetSleep || 7.5;
      const targetFluids = settings.targetFluids || 2.5;

      let xp = 0;

      const dist = parseNumber(entry.distanceKm);
      const dur = parseNumber(entry.durationMin);
      const rpe = parseNumber(entry.rpe);
      const sleep = parseNumber(entry.sleepHours);
      const fluids = parseNumber(entry.fluidsLiters);
      const wb = parseNumber(entry.wellbeing);

      // Training zÃ¤hlt auch ohne Distanz (Indoor-Rad, Boxen)
      const isTraining = dur != null && dur > 0;

      // Grund-XP
      if (isTraining) {
        xp += 10;
      } else {
        xp += 3; // Restday
      }

      // Distanz vs. Tagesziel (nur wenn Distanz vorhanden)
      if (dist != null && dist > 0 && targetKm > 0) {
        const targetDailyKm = targetKm / 7;
        const ratio = dist / targetDailyKm;
        if (ratio >= 0.8 && ratio <= 1.5) {
          xp += 10;
        } else if (ratio > 0.3) {
          xp += 5;
        } else {
          xp += 2;
        }
      }

      // Schlaf
      if (sleep != null) {
        const ratio = sleep / targetSleep;
        if (ratio >= 0.95) xp += 6;
        else if (ratio >= 0.8) xp += 4;
        else if (ratio >= 0.6) xp += 2;
      }

      // FlÃ¼ssigkeit
      if (fluids != null) {
        const ratio = fluids / targetFluids;
        if (ratio >= 0.95) xp += 5;
        else if (ratio >= 0.8) xp += 3;
        else if (ratio >= 0.6) xp += 1;
      }

      // Wohlbefinden
      if (wb != null) {
        if (wb >= 4) xp += 3;
        else if (wb === 3) xp += 2;
        else if (wb <= 2) xp += 1;
      }

      // Spezial: Nachtlauf & langer Lauf
      if (entry.nightRun) {
        xp += 8;
      }
      if (entry.trainingType === "Langer Lauf" && dist != null && dist >= 25) {
        xp += 8;
      }

      // Sehr harte Sessions
      if (dur != null && rpe != null && dur >= 60 && rpe >= 8) {
        xp += 5;
      }

      // Supplements komplett
      if (entry.omega3 && entry.zink && entry.magnesium && entry.d3) {
        xp += 3;
      }

      if (xp < 3) xp = 3;
      if (xp > 40) xp = 40;

      return xp;
    }

    function computeTotalXP(entries, settings) {
      let total = 0;
      for (const e of entries) {
        if (!e.date) continue;
        total += computeDailyXP(e, settings);
      }
      return Math.round(total);
    }

    function getLevelFromXP(totalXP) {
      const maxLevel = 100;
      const xpPerLevel = 50; // 50 XP pro Level
      let level = Math.floor(totalXP / xpPerLevel) + 1;
      if (level > maxLevel) level = maxLevel;
      const currLevelXp = (level - 1) * xpPerLevel;
      const nextLevelXp = level < maxLevel ? level * xpPerLevel : currLevelXp;
      const xpIntoLevel = totalXP - currLevelXp;
      return { level, currLevelXp, nextLevelXp, xpIntoLevel, xpPerLevel };
    }

    // --- Export / Import ---
    function exportJSON() {
      const data = {
        version: 2,
        exportedAt: new Date().toISOString(),
        settings,
        entries
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const dateStr = new Date().toISOString().slice(0,10);
      a.href = url;
      a.download = `project230_backup_${dateStr}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function exportCSV() {
      if (!entries || entries.length === 0) {
        alert("Keine EintrÃ¤ge vorhanden, die exportiert werden kÃ¶nnten.");
        return;
      }
      const header = [
        "date","weight","trainingType","distanceKm","durationMin","rpe",
        "sleepHours","sleepQuality","fluidsLiters","wellbeing",
        "nightRun","hasPain","omega3","zink","magnesium","d3","painNote","comments"
      ];
      const rows = [header];

      for (const e of entries) {
        rows.push([
          e.date || "",
          e.weight != null ? e.weight : "",
          e.trainingType || "",
          e.distanceKm != null ? e.distanceKm : "",
          e.durationMin != null ? e.durationMin : "",
          e.rpe != null ? e.rpe : "",
          e.sleepHours != null ? e.sleepHours : "",
          e.sleepQuality || "",
          e.fluidsLiters != null ? e.fluidsLiters : "",
          e.wellbeing != null ? e.wellbeing : "",
          e.nightRun ? "1" : "0",
          e.hasPain ? "1" : "0",
          e.omega3 ? "1" : "0",
          e.zink ? "1" : "0",
          e.magnesium ? "1" : "0",
          e.d3 ? "1" : "0",
          (e.painNote || "").replace(/"/g, '""'),
          (e.comments || "").replace(/"/g, '""')
        ]);
      }

      const csvContent = rows.map(r =>
        r.map(cell => {
          const str = String(cell);
          if (str.includes(",") || str.includes("\"") || str.includes("\n")) {
            return `"${str.replace(/"/g, '""')}"`;
          }
          return str;
        }).join(",")
      ).join("\n");

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const dateStr = new Date().toISOString().slice(0,10);
      a.href = url;
      a.download = `project230_entries_${dateStr}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function triggerImport() {
      importJsonInput.value = "";
      importJsonInput.click();
    }

    function handleImportFile(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(ev) {
        try {
          const text = ev.target.result;
          const data = JSON.parse(text);

          if (!data || (!Array.isArray(data.entries) && !Array.isArray(data))) {
            alert("Die JSON-Datei enthÃ¤lt kein erwartetes Format.");
            return;
          }

          let importedEntries;
          let importedSettings;

          if (Array.isArray(data)) {
            importedEntries = data;
            importedSettings = settings;
          } else {
            importedEntries = Array.isArray(data.entries) ? data.entries : [];
            importedSettings = data.settings || settings;
          }

          if (!confirm(`Backup mit ${importedEntries.length} EintrÃ¤gen laden und bestehende Daten Ã¼berschreiben?`)) {
            return;
          }

          entries = importedEntries.map(e => ({
            ...e,
            omega3: !!e.omega3,
            zink: !!e.zink,
            magnesium: !!e.magnesium,
            d3: !!e.d3
          }));

          settings = {
            raceDate: importedSettings.raceDate || "",
            targetKm: importedSettings.targetKm ?? settings.targetKm ?? 90,
            targetSleep: importedSettings.targetSleep ?? settings.targetSleep ?? 7.5,
            targetFluids: importedSettings.targetFluids ?? settings.targetFluids ?? 2.5
          };

          saveState(STORAGE_ENTRIES_KEY, entries);
          saveState(STORAGE_SETTINGS_KEY, settings);

          initSettingsUI();
          updateRaceSummary();
          updateStats();
          alert("Backup erfolgreich importiert. Deine Project-230-Daten wurden geladen.");
        } catch (err) {
          console.error("Fehler beim Import:", err);
          alert("Fehler beim Import der JSON-Datei. PrÃ¼fe, ob es ein gÃ¼ltiges Backup ist.");
        }
      };
      reader.readAsText(file);
    }

    // --- Heute-Ãœbersicht ---
    function updateTodayOverview(sortedEntries) {
      const today = new Date();
      const todayStr = today.toISOString().substring(0,10);
      if (todayDateLabel) {
        todayDateLabel.textContent = today.toLocaleDateString("de-DE", {
          weekday: "short",
          day: "2-digit",
          month: "2-digit"
        });
      }
      if (!todayOverviewEl) return;

      const todays = (sortedEntries || []).filter(e => e.date === todayStr);
      if (todays.length === 0) {
        todayOverviewEl.innerHTML = `
          <div class="summary-card">
            <div class="summary-label">Status heute</div>
            <div class="summary-value">Noch kein Eintrag fÃ¼r heute</div>
            <div class="today-status-row">
              <span class="status-pill"><span class="status-dot-bad"></span>Training: offen</span>
              <span class="status-pill"><span class="status-dot-warn"></span>Schlaf / FlÃ¼ssigkeit: offen</span>
              <span class="status-pill"><span class="status-dot-warn"></span>Supplements: offen</span>
            </div>
            <p class="hint">Eintrag anlegen: Datum auf heute, grob Training/Schlaf/FlÃ¼ssigkeit/Supplements eintragen, speichern â€“ fertig.</p>
          </div>
        `;
        return;
      }

      const entry = todays[todays.length - 1];
      const hasTraining = (parseNumber(entry.durationMin) > 0) || (parseNumber(entry.distanceKm) > 0);
      const hasSleep = parseNumber(entry.sleepHours) != null;
      const hasFluids = parseNumber(entry.fluidsLiters) != null;
      const hasWeight = parseNumber(entry.weight) != null;
      const suppAll = !!(entry.omega3 && entry.zink && entry.magnesium && entry.d3);
      const suppAny = !!(entry.omega3 || entry.zink || entry.magnesium || entry.d3);

      todayOverviewEl.innerHTML = `
        <div class="summary-grid">
          <div class="summary-card">
            <div class="summary-label">Heute eingetragen</div>
            <div class="summary-value">
              ${entry.trainingType || "Kein Training / Rest"}
            </div>
            <div class="today-status-row">
              <span class="status-pill">
                <span class="${hasTraining ? "status-dot-ok" : "status-dot-warn"}"></span>
                Training
              </span>
              <span class="status-pill">
                <span class="${hasSleep && hasFluids ? "status-dot-ok" : "status-dot-warn"}"></span>
                Schlaf & FlÃ¼ssigkeit
              </span>
              <span class="status-pill">
                <span class="${suppAll ? "status-dot-ok" : suppAny ? "status-dot-warn" : "status-dot-bad"}"></span>
                Supplements
              </span>
              <span class="status-pill">
                <span class="${hasWeight ? "status-dot-ok" : "status-dot-warn"}"></span>
                Gewicht
              </span>
            </div>
          </div>
        </div>
      `;
    }

    // --- Stats, Level, Charts & Coaching ---
    function updateStats() {
      statsSummaryEl.innerHTML = "";
      if (coachFeedbackEl) coachFeedbackEl.textContent = "";

      if (!entries || entries.length === 0) {
        statsSummaryEl.innerHTML = `
          <div class="summary-card">
            <div class="summary-label">Noch keine Daten</div>
            <div class="summary-value">Starte mit deinem ersten Eintrag ðŸ‘£</div>
            <div class="tag-warn">Ein paar Tage loggen, dann gibt es Level, Score & Coaching.</div>
          </div>
        `;
        entriesTableBody.innerHTML = "";
        updateTodayOverview([]);
        updateCharts({});
        updateCoaching({}, {});
        return;
      }

      const sorted = [...entries].sort((a, b) => (a.date || "").localeCompare(b.date || ""));

      const today = new Date();
      today.setHours(0,0,0,0);
      const sevenDaysAgo = new Date(today.getTime() - 6 * 24*60*60*1000);
      const threeDaysAgo = new Date(today.getTime() - 2 * 24*60*60*1000);
      const fourteenDaysAgo = new Date(today.getTime() - 13 * 24*60*60*1000);

      let sumKm = 0;
      let sumSleep = 0;
      let sumFluids = 0;
      let countSleep = 0;
      let countFluids = 0;

      let trimp7 = 0;
      let trimp3 = 0;

      const thirtyDaysAgo = new Date(today.getTime() - 30 * 24*60*60*1000);
      const thirtyDaysAgoStr = thirtyDaysAgo.toISOString().substring(0,10);

      let latestWeight = null;
      let weight30days = null;

      const weeklyKmMap = {};
      const dailyTrimpMap = {};
      const sleepMap = {};
      const fluidsMap = {};
      const weightSeries = [];
      const suppMap = {};

      let last7WellbeingSum = 0;
      let last7WellbeingCount = 0;
      let painCountLast7 = 0;

      for (const e of sorted) {
        if (!e.date) continue;
        const d = new Date(e.date + "T00:00:00");
        const dateStr = e.date;

        // 7-Tage-Fenster
        if (d >= sevenDaysAgo && d <= today) {
          const dist = parseNumber(e.distanceKm);
          if (dist != null) sumKm += dist;

          const sleep = parseNumber(e.sleepHours);
          if (sleep != null) { sumSleep += sleep; countSleep++; }

          const fluids = parseNumber(e.fluidsLiters);
          if (fluids != null) { sumFluids += fluids; countFluids++; }

          const wb = parseNumber(e.wellbeing);
          if (wb != null) { last7WellbeingSum += wb; last7WellbeingCount++; }

          if (e.hasPain === true) painCountLast7++;

          if (!suppMap[dateStr]) {
            suppMap[dateStr] = {
              omega3: false,
              zink: false,
              magnesium: false,
              d3: false
            };
          }
          if (e.omega3) suppMap[dateStr].omega3 = true;
          if (e.zink) suppMap[dateStr].zink = true;
          if (e.magnesium) suppMap[dateStr].magnesium = true;
          if (e.d3) suppMap[dateStr].d3 = true;
        }

        // TRIMP
        const dur = parseNumber(e.durationMin);
        const rpeVal = parseNumber(e.rpe);
        let trimp = 0;
        if (dur != null && rpeVal != null) {
          trimp = dur * rpeVal;
        }
        if (d >= sevenDaysAgo && d <= today) trimp7 += trimp;
        if (d >= threeDaysAgo && d <= today) trimp3 += trimp;

        // Gewicht
        const w = parseNumber(e.weight);
        if (w != null) {
          if (!latestWeight || e.date > latestWeight.date) {
            latestWeight = { date: e.date, weight: w };
          }
          if (e.date <= thirtyDaysAgoStr) {
            if (!weight30days || e.date > weight30days.date) {
              weight30days = { date: e.date, weight: w };
            }
          }
          weightSeries.push({ date: e.date, weight: w });
        }

        // Wochen-km (nur Laufen)
        const distForWeekly = parseNumber(e.distanceKm);
        if (distForWeekly != null && distForWeekly > 0) {
          const monday = getMonday(e.date);
          const mondayStr = monday.toISOString().substring(0,10);
          if (!weeklyKmMap[mondayStr]) weeklyKmMap[mondayStr] = 0;
          weeklyKmMap[mondayStr] += distForWeekly;
        }

        if (!dailyTrimpMap[dateStr]) dailyTrimpMap[dateStr] = 0;
        dailyTrimpMap[dateStr] += trimp;

        if (d >= fourteenDaysAgo && d <= today) {
          const s = parseNumber(e.sleepHours);
          const f = parseNumber(e.fluidsLiters);
          if (s != null) sleepMap[dateStr] = s;
          if (f != null) fluidsMap[dateStr] = f;
        }
      }

      const avgSleep = countSleep > 0 ? (sumSleep / countSleep) : null;
      const avgFluids = countFluids > 0 ? (sumFluids / countFluids) : null;
      const avgWellbeing = last7WellbeingCount > 0 ? last7WellbeingSum / last7WellbeingCount : null;

      // Supplements-Statistik
      const suppDates = Object.keys(suppMap);
      let suppDaysAll = 0;
      let suppTrackedDays = suppDates.length;
      for (const dStr of suppDates) {
        const daySupp = suppMap[dStr];
        const all = daySupp.omega3 && daySupp.zink && daySupp.magnesium && daySupp.d3;
        if (all) suppDaysAll++;
      }

      function buildTag(current, target, unit, direction = "higher-better") {
        if (target == null || current == null) {
          return '<div class="tag-warn">Noch zu wenige Daten oder kein Ziel gesetzt.</div>';
        }
        let diff = current - target;
        const diffAbs = Math.abs(diff).toFixed(1);

        if (direction === "higher-better") {
          if (current >= target * 0.95 && current <= target * 1.1) {
            return `<div class="tag-ok">Sehr nah am Ziel (${diff >= 0 ? "+" : "â€“"}${diffAbs} ${unit})</div>`;
          } else if (current >= target * 0.7) {
            return `<div class="tag-warn">Okay, aber noch Luft nach oben (${diff >= 0 ? "+" : "â€“"}${diffAbs} ${unit})</div>`;
          } else {
            return `<div class="tag-bad">Deutlich unter Ziel (${diff >= 0 ? "+" : "â€“"}${diffAbs} ${unit})</div>`;
          }
        } else {
          if (current <= target * 1.05) {
            return `<div class="tag-ok">Im Zielbereich (${diff >= 0 ? "+" : "â€“"}${diffAbs} ${unit})</div>`;
          } else if (current <= target * 1.2) {
            return `<div class="tag-warn">Etwas drÃ¼ber (${diffAbs} ${unit}) â€“ beobachten.</div>`;
          } else {
            return `<div class="tag-bad">Deutlich drÃ¼ber (${diffAbs} ${unit}) â€“ Belastung prÃ¼fen.</div>`;
          }
        }
      }

      function buildSuppTag(suppDaysAll, suppTrackedDays) {
        if (suppTrackedDays === 0) {
          return '<div class="tag-warn">Noch keine Tage mit Eintrag in den letzten 7 Tagen.</div>';
        }
        const ratio = suppDaysAll / suppTrackedDays;
        const percent = Math.round(ratio * 100);
        if (ratio >= 0.8) {
          return `<div class="tag-ok">Sehr stabil: an ${percent}% der erfassten Tage alle Supplements genommen.</div>`;
        } else if (ratio >= 0.5) {
          return `<div class="tag-warn">Okay, aber ausbaufÃ¤hig: an ${percent}% der erfassten Tage komplett.</div>`;
        } else {
          return `<div class="tag-bad">Erinnerung: Supplements nur an ${percent}% der erfassten Tage komplett â€“ wenn sie Teil deiner Strategie sind, gern konstanter.</div>`;
        }
      }

      function levelFromScore(score) {
        if (score >= 80) return { label: "GrÃ¼n", className: "tag-ok" };
        if (score >= 60) return { label: "Gelb", className: "tag-warn" };
        return { label: "Rot", className: "tag-bad" };
      }

      let kmScore = 50;
      let sleepScore = 50;
      let fluidsScore = 50;
      let weightScore = 50;
      let loadScore = 50;

      const targetKm = settings.targetKm || 90;

      if (targetKm > 0 && sumKm > 0) {
        const ratio = sumKm / targetKm;
        if (ratio >= 0.8 && ratio <= 1.1) kmScore = 90;
        else if (ratio >= 0.6 && ratio <= 1.3) kmScore = 75;
        else if (ratio >= 0.4 && ratio <= 1.6) kmScore = 55;
        else kmScore = 35;
      } else if (sumKm > 0) {
        kmScore = 70;
      }

      const targetSleep = settings.targetSleep || 7.5;
      if (avgSleep != null) {
        const ratio = avgSleep / targetSleep;
        if (ratio >= 0.95 && ratio <= 1.1) sleepScore = 90;
        else if (ratio >= 0.8 && ratio <= 1.2) sleepScore = 75;
        else if (ratio >= 0.6 && ratio <= 1.4) sleepScore = 55;
        else sleepScore = 35;
      }

      const targetFluids = settings.targetFluids || 2.5;
      if (avgFluids != null) {
        const ratio = avgFluids / targetFluids;
        if (ratio >= 0.95 && ratio <= 1.1) fluidsScore = 90;
        else if (ratio >= 0.8 && ratio <= 1.2) fluidsScore = 75;
        else if (ratio >= 0.6 && ratio <= 1.4) fluidsScore = 55;
        else fluidsScore = 35;
      }

      if (latestWeight && weight30days) {
        const diff = latestWeight.weight - weight30days.weight;
        const diffAbs = Math.abs(diff);
        if (diffAbs < 0.5) weightScore = 90;
        else if (diffAbs < 1.5) weightScore = 75;
        else if (diffAbs < 3) weightScore = 55;
        else weightScore = 35;
      } else if (latestWeight && !weight30days) {
        weightScore = 65;
      }

      if (trimp7 > 0) {
        const ratio = trimp3 / trimp7;
        if (ratio >= 0.35 && ratio <= 0.55) loadScore = 90;
        else if (ratio >= 0.25 && ratio <= 0.65) loadScore = 75;
        else if (ratio >= 0.15 && ratio <= 0.75) loadScore = 55;
        else loadScore = 35;
      }

      const overallScore = Math.round(
        kmScore * 0.4 +
        sleepScore * 0.25 +
        fluidsScore * 0.15 +
        weightScore * 0.1 +
        loadScore * 0.1
      );

      let overallText = "";
      if (overallScore >= 85) {
        overallText = "Sehr gut im Plan â€“ deine Vorbereitung auf die 230 km wirkt stabil und durchdacht.";
      } else if (overallScore >= 70) {
        overallText = "Gut unterwegs â€“ ein paar Stellschrauben (v.a. Schlaf/Struktur) bringen dich noch ruhiger Richtung Race-Day.";
      } else if (overallScore >= 55) {
        overallText = "Solide Basis, aber noch nicht richtig stabil. Fokus auf Routine, Recovery & klare Wochenstruktur.";
      } else {
        overallText = "Achtung: Vorbereitung wirkt wackelig. Umfang, Schlaf & Hydration bewusst prÃ¼fen, bevor du weiter hochdrehst.";
      }

      const kmLevel = levelFromScore(kmScore);
      const sleepLevel = levelFromScore(sleepScore);
      const fluidsLevel = levelFromScore(fluidsScore);
      const weightLevel = levelFromScore(weightScore);
      const loadLevel = levelFromScore(loadScore);

      // Level aus ALLEN EintrÃ¤gen
      const totalXP = computeTotalXP(sorted, settings);
      const progress = getLevelFromXP(totalXP);
      const levelPercent = progress.xpPerLevel > 0
        ? Math.min(100, Math.max(0, (progress.xpIntoLevel / progress.xpPerLevel) * 100))
        : 0;

      let summaryHtml = "";

      // Level-Karte
      summaryHtml += `
        <div class="summary-card">
          <div class="summary-label">Project 230 â€“ Level</div>
          <div class="summary-value-big">Level ${progress.level} / 100</div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${levelPercent.toFixed(1)}%;"></div>
          </div>
          <div class="level-subtext">
            Gesamt-XP: ${totalXP} Â· ${
              progress.level < 100
                ? `${progress.xpIntoLevel}/${progress.xpPerLevel} XP bis Level ${progress.level + 1}`
                : "Max-Level erreicht â€“ TorTour-Minimum voll erfÃ¼llt."
            }
          </div>
          <div class="${
            progress.level >= 100
              ? "tag-ok"
              : progress.level >= 70
                ? "tag-warn"
                : "tag-bad"
          }">
            ${
              progress.level >= 100
                ? "Level 100 â€“ du erfÃ¼llst voll das Zielsetup fÃ¼r deine TorTour-Vorbereitung."
                : progress.level >= 70
                  ? "Schon sehr weit â€“ jetzt Feintuning und Gesundheit halten, bis der Startschuss kommt."
                  : "Aufbauphase â€“ jede saubere Woche bringt dich spÃ¼rbar nÃ¤her an Level 100."
            }
          </div>
        </div>
      `;

      // Gesamt-Status
      summaryHtml += `
        <div class="summary-card">
          <div class="summary-label">Gesamt-Status (letzte 7 Tage)</div>
          <div class="summary-value-big">${overallScore} / 100</div>
          <div class="${overallScore >= 80 ? "tag-ok" : overallScore >= 60 ? "tag-warn" : "tag-bad"}">${overallText}</div>
          <div class="ampel-row">
            <span class="${kmLevel.className}">Training (${kmLevel.label})</span>
            <span class="${sleepLevel.className}">Schlaf (${sleepLevel.label})</span>
            <span class="${fluidsLevel.className}">FlÃ¼ssigkeit (${fluidsLevel.label})</span>
            <span class="${weightLevel.className}">Gewicht (${weightLevel.label})</span>
            <span class="${loadLevel.className}">Belastung (${loadLevel.label})</span>
          </div>
        </div>
      `;

      // Detailkarten
      summaryHtml += `
        <div class="summary-card">
          <div class="summary-label">Wochenkilometer (Laufen, letzte 7 Tage)</div>
          <div class="summary-value">${sumKm.toFixed(1)} km</div>
          ${buildTag(sumKm, targetKm, "km/Woche", "higher-better")}
        </div>
      `;

      summaryHtml += `
        <div class="summary-card">
          <div class="summary-label">Ã˜ Schlaf (letzte 7 Tage)</div>
          <div class="summary-value">${avgSleep != null ? avgSleep.toFixed(2) + " h" : "â€“"}</div>
          ${buildTag(avgSleep, targetSleep, "h/Tag", "higher-better")}
        </div>
      `;

      summaryHtml += `
        <div class="summary-card">
          <div class="summary-label">Ã˜ FlÃ¼ssigkeit (letzte 7 Tage)</div>
          <div class="summary-value">${avgFluids != null ? avgFluids.toFixed(2) + " L" : "â€“"}</div>
          ${buildTag(avgFluids, targetFluids, "L/Tag", "higher-better")}
        </div>
      `;

      let weightLine = "â€“";
      let trendTag = '<div class="tag-warn">Noch zu wenige Daten fÃ¼r einen Trend.</div>';

      if (latestWeight) {
        weightLine = latestWeight.weight.toFixed(1) + " kg";
        if (weight30days) {
          const diff = latestWeight.weight - weight30days.weight;
          const diffAbs = Math.abs(diff).toFixed(1);

          if (Math.abs(diff) < 0.5) {
            trendTag = `<div class="tag-ok">Gewicht stabil (Â±${diffAbs} kg in 30 Tagen)</div>`;
          } else if (diff < 0) {
            trendTag = `<div class="tag-warn">Gewichtsabnahme (${diffAbs} kg in 30 Tagen) â€“ passt das zu deinem Plan?</div>`;
          } else {
            trendTag = `<div class="tag-warn">Gewichtszunahme (${diffAbs} kg in 30 Tagen) â€“ bewusst so geplant?</div>`;
          }
        }
      }

      summaryHtml += `
        <div class="summary-card">
          <div class="summary-label">Aktuelles Gewicht</div>
          <div class="summary-value">${weightLine}</div>
          ${trendTag}
        </div>
      `;

      // Supplement-Karte
      summaryHtml += `
        <div class="summary-card">
          <div class="summary-label">Supplements (letzte 7 Tage)</div>
          <div class="summary-value">
            ${
              suppTrackedDays > 0
                ? `${suppDaysAll} / ${suppTrackedDays} Tage komplett`
                : "â€“"
            }
          </div>
          ${buildSuppTag(suppDaysAll, suppTrackedDays)}
        </div>
      `;

      statsSummaryEl.innerHTML = summaryHtml;

      // Coach-Notizen
      if (coachFeedbackEl) {
        const hints = [];

        if (kmScore < 60) hints.push("Trainingsumfang langsam, aber stetig steigern â€“ max. ~10 % mehr Wochen-km als in der Vorwoche.");
        else if (kmScore >= 80) hints.push("Training: Wochenkilometer liegen sehr gut im Zielbereich â€“ Konstanz > Heldentaten.");

        if (sleepScore < 60) hints.push("Schlaf: 1â€“2 Abende bewusst frÃ¼her ins Bett, v.a. nach langen oder intensiven Einheiten.");
        else if (sleepScore >= 80) hints.push("Schlaf: Erholung sieht stark aus â€“ weiter so, das gibt viele stille Bonuspunkte.");

        if (fluidsScore < 60) hints.push("Hydration: Trinkmenge leicht erhÃ¶hen (z.B. +0,5 L/Tag), besonders an langen Lauf- oder Indoor-Rad-Tagen.");
        else if (fluidsScore >= 80) hints.push("Hydration: FlÃ¼ssigkeitszufuhr stabil â€“ sehr gut fÃ¼r Ultra-Belastung.");

        if (weightScore < 60 && latestWeight && weight30days) {
          hints.push("Gewichtstrend auffÃ¤llig â€“ Energiezufuhr vs. Trainingsbelastung bewusst checken.");
        }

        if (loadScore < 60 && trimp7 > 0) {
          hints.push("Belastung: nicht zu viele harte Tage nacheinander â€“ maximal 2 sehr intensive Sessions in 3 Tagen.");
        }

        if (avgWellbeing != null && avgWellbeing <= 2.5) {
          hints.push("Wohlbefinden eher niedrig â€“ eventuell Stress / Schlaf / Umfang etwas reduzieren, bevor du in ein echtes Defizit lÃ¤ufst.");
        }

        if (painCountLast7 >= 3) {
          hints.push("Mehrere Tage mit Schmerzen â€“ Umfang/IntensitÃ¤t anpassen, ggf. Physio/Arzt im Hinterkopf behalten.");
        }

        if (suppTrackedDays > 0 && suppDaysAll < suppTrackedDays * 0.6) {
          hints.push("Supplements: Wenn sie bewusst Teil deiner Strategie sind, versuch sie an eine feste Routine zu koppeln (z.B. FrÃ¼hstÃ¼ck).");
        }

        const feedbackText = `
          <strong>Coach-Fazit:</strong> ${overallText}<br>
          ${hints.length > 0 ? hints.map(h => "â€¢ " + h).join("<br>") : "â€¢ Aktuell kein akuter Handlungsbedarf â€“ weiter strukturiert trainieren und auf deinen KÃ¶rper hÃ¶ren."}
        `;
        coachFeedbackEl.innerHTML = feedbackText;
      }

      // Tabelle
      let rowsHtml = "";
      for (const e of sorted) {
        rowsHtml += `
          <tr>
            <td class="nowrap">${e.date || ""}</td>
            <td>${e.weight != null ? e.weight : ""}</td>
            <td>${e.trainingType || ""}</td>
            <td>${e.distanceKm != null ? e.distanceKm : ""}</td>
            <td>${e.durationMin != null ? e.durationMin : ""}</td>
            <td>${e.rpe != null ? e.rpe : ""}</td>
            <td>${e.sleepHours != null ? e.sleepHours : ""}</td>
            <td>${e.fluidsLiters != null ? e.fluidsLiters : ""}</td>
            <td>${e.wellbeing != null ? e.wellbeing : ""}</td>
            <td>${e.nightRun ? "Ja" : ""}</td>
            <td>${e.hasPain ? "Ja" : ""}</td>
            <td>${e.omega3 ? "âœ“" : ""}</td>
            <td>${e.zink ? "âœ“" : ""}</td>
            <td>${e.magnesium ? "âœ“" : ""}</td>
            <td>${e.d3 ? "âœ“" : ""}</td>
            <td>${e.painNote || ""}</td>
            <td>${e.comments || ""}</td>
          </tr>
        `;
      }
      entriesTableBody.innerHTML = rowsHtml;

      // Heute-Ãœbersicht aktualisieren
      updateTodayOverview(sorted);

      // Charts & Coaching
      updateCharts({ weeklyKmMap, dailyTrimpMap, sleepMap, fluidsMap, weightSeries, targetKm });
      updateCoaching(
        { sumKm, targetKm, trimp7, trimp3, avgSleep, avgFluids, avgWellbeing, painCountLast7, suppDaysAll, suppTrackedDays },
        { kmScore, sleepScore, fluidsScore, weightScore, loadScore, overallScore }
      );
    }

    function updateCharts(data) {
      const ctxWeekly = document.getElementById("weeklyKmChart");
      const ctxTrimp = document.getElementById("trimpChart");
      const ctxSleepHydration = document.getElementById("sleepHydrationChart");
      const ctxWeight = document.getElementById("weightChart");

      const weeklyKmMap = data.weeklyKmMap || {};
      const dailyTrimpMap = data.dailyTrimpMap || {};
      const sleepMap = data.sleepMap || {};
      const fluidsMap = data.fluidsMap || {};
      const weightSeries = data.weightSeries || [];
      const targetKm = data.targetKm;

      // Wochen-km
      const weekKeys = Object.keys(weeklyKmMap).sort();
      const weekLabels = weekKeys.map(k => "KW ab " + formatDateShort(k));
      const weekValues = weekKeys.map(k => weeklyKmMap[k]);
      const targetLine = targetKm ? weekKeys.map(() => targetKm) : null;

      if (weeklyKmChart) weeklyKmChart.destroy();
      weeklyKmChart = new Chart(ctxWeekly, {
        type: "bar",
        data: {
          labels: weekLabels,
          datasets: [
            {
              label: "Wochenkilometer (Laufen)",
              data: weekValues
            }
          ].concat(targetLine ? [{
            type: "line",
            label: "Ziel-Wochenkilometer",
            data: targetLine,
            borderWidth: 1,
            borderDash: [4, 4],
            pointRadius: 0
          }] : [])
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { ticks: { autoSkip: true, maxTicksLimit: 6 } },
            y: { beginAtZero: true }
          }
        }
      });

      // TRIMP 7-Tage-Summen
      const trimpDates = Object.keys(dailyTrimpMap).sort();
      const trimpLabels = trimpDates.map(d => formatDateShort(d));
      const trimpValues = [];
      for (let i = 0; i < trimpDates.length; i++) {
        const d = new Date(trimpDates[i] + "T00:00:00");
        const windowStart = new Date(d.getTime() - 6 * 24*60*60*1000);
        let sum = 0;
        for (let j = 0; j <= i; j++) {
          const dj = new Date(trimpDates[j] + "T00:00:00");
          if (dj >= windowStart && dj <= d) {
            sum += dailyTrimpMap[trimpDates[j]];
          }
        }
        trimpValues.push(sum);
      }

      if (trimpChart) trimpChart.destroy();
      trimpChart = new Chart(ctxTrimp, {
        type: "line",
        data: {
          labels: trimpLabels,
          datasets: [
            {
              label: "TRIMP (7-Tage-Summe)",
              data: trimpValues,
              borderWidth: 1,
              tension: 0.3,
              pointRadius: 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { ticks: { autoSkip: true, maxTicksLimit: 6 } },
            y: { beginAtZero: true }
          }
        }
      });

      // Schlaf & Hydration (14 Tage)
      const allDatesSet = new Set([...Object.keys(sleepMap), ...Object.keys(fluidsMap)]);
      const allDates = Array.from(allDatesSet).sort();
      const shLabels = allDates.map(d => formatDateShort(d));
      const sleepValues = allDates.map(d => sleepMap[d] != null ? sleepMap[d] : null);
      const fluidsValues = allDates.map(d => fluidsMap[d] != null ? fluidsMap[d] : null);

      if (sleepHydrationChart) sleepHydrationChart.destroy();
      sleepHydrationChart = new Chart(ctxSleepHydration, {
        type: "line",
        data: {
          labels: shLabels,
          datasets: [
            {
              label: "Schlaf (h)",
              data: sleepValues,
              borderWidth: 1,
              tension: 0.3,
              pointRadius: 2,
              yAxisID: "y"
            },
            {
              label: "FlÃ¼ssigkeit (L)",
              data: fluidsValues,
              borderWidth: 1,
              tension: 0.3,
              pointRadius: 2,
              yAxisID: "y1"
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { ticks: { autoSkip: true, maxTicksLimit: 7 } },
            y: {
              position: "left",
              beginAtZero: true
            },
            y1: {
              position: "right",
              beginAtZero: true,
              grid: { drawOnChartArea: false }
            }
          }
        }
      });

      // Gewicht
      const sortedWeight = [...weightSeries].sort((a, b) => a.date.localeCompare(b.date));
      const weightLabels = sortedWeight.map(w => formatDateShort(w.date));
      const weightValues = sortedWeight.map(w => w.weight);

      if (weightChart) weightChart.destroy();
      weightChart = new Chart(ctxWeight, {
        type: "line",
        data: {
          labels: weightLabels,
          datasets: [
            {
              label: "Gewicht (kg)",
              data: weightValues,
              borderWidth: 1,
              tension: 0.3,
              pointRadius: 
