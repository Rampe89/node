<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Von der Wenn-Dann-Regel zum lernenden System ‚Äì Spamfilter Demo</title>
  <style>
    :root{
      --bg:#f7fafc; --panel:#ffffff; --ink:#0b1220; --muted:#4b5563; --accent:#2563eb;
      --ok:#16a34a; --bad:#dc2626; --border:#e5e7eb; --shadow:0 1px 2px rgba(0,0,0,.05);
      --radius:12px; --meta:#6b7280; --divider:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font:16px/1.6 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Helvetica, Arial; color:var(--ink); background:var(--bg)}
    .wrap{max-width:1080px; margin:0 auto; padding:20px}
    header{display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:10px}
    h1{font-size:22px; margin:0; font-weight:800}
    h2{margin:0 0 6px; font-size:18px}
    h3{margin:0 0 6px; font-size:15px}
    .small{font-size:13px; color:var(--muted)}
    .label{display:inline-block; font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid var(--border); background:#f9fafb}

    /* Layout */
    .grid{display:grid; grid-template-columns:minmax(280px,320px) 1fr; gap:18px}
    .panel{background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow)}
    .divider{height:1px; background:var(--divider); margin:10px 0}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}

    /* Controls */
    select,input,button,textarea{background:#fff; border:1px solid var(--border); color:var(--ink); padding:10px 12px; border-radius:10px; height:40px}
    select{width:100%}
    input[type="number"]{width:90px}
    input[type="range"]{height:auto}
    button{cursor:pointer; transition:transform .12s ease}
    button.primary{background:var(--accent); color:#fff; border-color:var(--accent); font-weight:700}
    button:hover{transform:translateY(-1px)}
    button:focus-visible, input:focus-visible, select:focus-visible{outline:2px solid var(--accent); outline-offset:2px}

    /* Tables */
    table{width:100%; border-collapse:collapse; background:#fff; border:1px solid var(--border); border-radius:8px; overflow:hidden}
    th,td{border-bottom:1px solid var(--border); padding:8px 10px; text-align:left}
    thead th{background:#f3f4f6; font-weight:700; font-size:13px; color:#374151}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

    /* Inbox */
    .inbox{display:grid; gap:10px}
    .email-card{display:grid; grid-template-columns:36px 1fr auto; gap:10px; align-items:center; background:#fff; border:1px solid var(--border); border-radius:10px; padding:10px}
    .avatar{width:30px; height:30px; border-radius:999px; background:#e5e7eb; color:#374151; display:grid; place-items:center; font-weight:700; font-size:11px}
    .subject{font-weight:800}
    .snippet{color:var(--muted); font-size:14px; margin-top:2px}
    .meta{color:var(--meta); font-size:12px}
    .pill-ok{background:#dcfce7; border-color:#bbf7d0}
    .pill-bad{background:#fee2e2; border-color:#fecaca}

    /* Decision boxes */
    .decision{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .decision .box{background:#fff; border:1px solid var(--border); border-radius:10px; padding:10px}
    .out{font-weight:800; font-size:18px}
    .ok{color:var(--ok)} .bad{color:var(--bad)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Von der Wenn-Dann-Regel zum lernenden System ¬∑ Spamfilter (Demo)</h1>
        <div class="small">Posteingang simulieren, Regeln pr√ºfen, Perzeptron testen. Direktstart.</div>
      </div>
      <button id="btnShot">Screenshot-Ansicht</button>
    </header>

    <div class="grid">
      <!-- Sidebar -->
      <aside class="panel" style="align-self:start">
        <h2>Datensatz</h2>
        <p class="small">Beispiel-Mails. Features sind 0/1. ‚ÄûSoll‚Äú = korrektes Label.</p>

        <label class="small" for="emailSelect" style="display:block;margin-top:6px">Mail ausw√§hlen</label>
        <select id="emailSelect" aria-label="Beispiel-Mail w√§hlen"></select>
        <div style="margin-top:8px"><span id="goldTag" class="label">Soll: ‚Äì</span></div>

        <div class="divider"></div>

        <table id="featTable" aria-label="Merkmalswerte">
          <thead><tr><th>Feature</th><th>Wert</th></tr></thead>
          <tbody></tbody>
        </table>

        <details style="margin-top:10px">
          <summary>Alle Datens√§tze</summary>
          <table id="dataTable" style="margin-top:8px">
            <thead id="dataHead"></thead>
            <tbody id="dataBody"></tbody>
          </table>
        </details>
      </aside>

      <!-- Main -->
      <main style="display:grid;gap:16px">
        <!-- Inbox + Entscheidungen -->
        <section class="panel">
          <div class="row" style="justify-content:space-between">
            <h2 style="margin:0">Posteingang</h2>
            <div class="row">
              <button id="prevMail">‚ü® Zur√ºck</button>
              <button id="nextMail" class="primary">Weiter ‚ü©</button>
              <button id="autoPlay">Auto</button>
              <span class="small">Mail <span id="idxNow">1</span>/<span id="idxTotal">‚Äì</span></span>
            </div>
          </div>
          <div class="divider"></div>

          <div id="inbox" class="inbox"></div>

          <div class="divider"></div>
          <div class="decision">
            <div class="box">
              <h3>Regelbasierte Entscheidung</h3>
              <div id="ruleWhy" class="small mono">Regeln: ‚Äì</div>
              <div id="ruleOut" class="out">‚Äì</div>
              <div class="divider"></div>
              <h4 style="margin:0 0 4px 0">Auswertung</h4>
              <div class="small mono">Trefferquote: <span id="ruleAcc">‚Äì</span></div>
              <div class="small mono">TP / TN: <span id="ruleTP">‚Äì</span></div>
              <div class="small mono">FP / FN: <span id="ruleFP">‚Äì</span></div>
            </div>
            <div class="box" id="learnBox">
              <h3>Perzeptron-Entscheidung</h3>
              <div id="neuSum" class="small mono">Summe = ‚Äì</div>
              <div id="neuOut" class="out">‚Äì</div>
              <div class="divider"></div>
              <h4 style="margin:0 0 4px 0">Auswertung</h4>
              <div class="small mono">Trefferquote: <span id="neuAcc">‚Äì</span></div>
              <div class="small mono">TP / TN: <span id="neuTP">‚Äì</span></div>
              <div class="small mono">FP / FN: <span id="neuFP">‚Äì</span></div>
            </div>
          </div>
        </section>

        <!-- Regeln -->
        <section class="panel" id="rulePanel">
          <h2 style="margin:0">Regelbasierter Filter</h2>
          <div class="divider"></div>
          <div class="row"><label><input type="checkbox" class="r" data-key="r0" checked> <span id="ruleLbl0">Betreff enth√§lt ¬ªgratis¬´</span> ‚áí Spam</label></div>
          <div class="row"><label><input type="checkbox" class="r" data-key="r1" checked> <span id="ruleLbl1">Verd√§chtige/typo Absenderdom√§ne</span> ‚áí Spam</label></div>
          <div class="row"><label><input type="checkbox" class="r" data-key="r2" checked> <span id="ruleLbl2">Betreff in ALL CAPS</span> ‚áí Spam</label></div>
          <div class="row"><label><input type="checkbox" class="r" data-key="r3" checked> <span id="ruleLbl3">Dringlichkeit/Alarm</span> ‚áí Spam</label></div>
          <div class="row"><label><input type="checkbox" class="r" data-key="r4" checked> <span id="ruleLbl4">Werbung/Promo-Sprache</span> ‚áí Spam</label></div>
          <div class="row" style="margin-top:6px"><label>Erkl√§r-Reihenfolge:
            <select id="ruleOrder" aria-label="Regelreihenfolge">
              <option value="natural">Nat√ºrliche Reihenfolge</option>
              <option value="prioritizeSpam">‚ÄûSpam‚Äú-Regeln zuerst</option>
            </select>
          </label></div>
        </section>

        <!-- Perzeptron -->
        <section class="panel" id="neuronPanel">
          <h2 style="margin:0">Lernendes System (Perzeptron)</h2>
          <div class="divider"></div>
          <div class="small">Gewichtete Summe der Merkmale, Vergleich mit Schwelle Œ∏.</div>
          <div class="row" style="flex-wrap:wrap;margin-top:6px">
            <label id="wName0">w‚ÇÅ <input id="w0" type="range" min="-2" max="2" step="0.1" value="0.8"><input id="w0Val" type="number" min="-2" max="2" step="0.1" value="0.8"></label>
            <label id="wName1">w‚ÇÇ <input id="w1" type="range" min="-2" max="2" step="0.1" value="-0.5"><input id="w1Val" type="number" min="-2" max="2" step="0.1" value="-0.5"></label>
            <label id="wName2">w‚ÇÉ <input id="w2" type="range" min="-2" max="2" step="0.1" value="0.6"><input id="w2Val" type="number" min="-2" max="2" step="0.1" value="0.6"></label>
            <label id="wName3">w‚ÇÑ <input id="w3" type="range" min="-2" max="2" step="0.1" value="0.4"><input id="w3Val" type="number" min="-2" max="2" step="0.1" value="0.4"></label>
            <label id="wName4">w‚ÇÖ <input id="w4" type="range" min="-2" max="2" step="0.1" value="0.7"><input id="w4Val" type="number" min="-2" max="2" step="0.1" value="0.7"></label>
            <label>Œ∏ <input id="theta" type="range" min="0" max="3" step="0.1" value="0.7"><input id="thetaVal" type="number" min="0" max="3" step="0.1" value="0.7"></label>
          </div>

          <div class="divider"></div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:6px">
            <div>
              <h3 style="margin:0 0 6px 0">Training</h3>
              <div class="row" style="margin-top:4px">
                <button id="fitOnce">üöÄ 1√ó trainieren</button>
                <button id="fitAuto" class="primary">ü§ñ Auto-Training</button>
                <button id="resetW">üîÅ Gewichte zur√ºcksetzen</button>
              </div>
              <div id="trainLog" class="small mono" style="margin-top:8px;max-height:120px;overflow:auto;border:1px solid var(--border);border-radius:8px;padding:8px"></div>
            </div>
            <div>
              <details>
                <summary>üìâ Fehler pro Epoche</summary>
                <table style="margin-top:6px">
                  <thead><tr><th>Epoche</th><th>Updates</th></tr></thead>
                  <tbody id="epochTableBody"></tbody>
                </table>
              </details>
              <details style="margin-top:6px">
                <summary>‚öñÔ∏è Gewichtsverlauf</summary>
                <table style="margin-top:6px">
                  <thead><tr><th>Epoche</th><th>w‚ÇÅ</th><th>w‚ÇÇ</th><th>w‚ÇÉ</th><th>w‚ÇÑ</th><th>w‚ÇÖ</th><th>Œ∏</th></tr></thead>
                  <tbody id="weightTableBody"></tbody>
                </table>
              </details>
            </div>
          </div>
        </section>

        <!-- Vergleich -->
        <section class="panel" id="comparePanel">
          <h2 style="margin:0">Direkter Vergleich</h2>
          <div class="divider"></div>
          <table>
            <thead><tr><th>Mail</th><th>Regelbasiert</th><th>Mini-Neuron</th><th>Soll</th></tr></thead>
            <tbody id="compareBody"></tbody>
          </table>
        </section>
      </main>
    </div>

    <div class="small" style="margin-top:10px;color:#6b7280">¬© Demo, frei nutzbar.</div>
  </div>

  <script>
  "use strict";
  document.addEventListener("DOMContentLoaded", function(){
    /* ---------- Daten ---------- */
    // Features: g=¬ªgratis¬´, k=typo/verd√§chtige Dom√§ne, l=ALL CAPS, c=Dringlichkeit, d=Promo-Sprache
    const DEFAULT_DATA = [
      { subj:"GRATIS IPHONE JETZT SICHERN", fromName:"Gewinn-Club", from:"support@rnicrosoft.com", time:"09:12", snippet:"Nur heute: Jetzt sichern und abholen.", g:1, k:1, l:1, c:1, d:1, y:1 },
      { subj:"WICHTIG: IHR PAKET KONNTE NICHT ZUGESTELLT WERDEN", fromName:"Zustellung", from:"benachrichtigung@am4zon-help.net", time:"11:28", snippet:"Best√§tigen Sie Ihre Adresse, um die Zustellung abzuschlie√üen.", g:0, k:1, l:1, c:1, d:0, y:1 },
      { subj:"SONDERAKTION HEUTE NUR F√úR SIE", fromName:"Shopping World", from:"deals@shopping-world.net", time:"08:41", snippet:"Exklusive Rabatte f√ºr kurze Zeit.", g:0, k:0, l:1, c:1, d:1, y:1 },
      { subj:"Gewinn best√§tigt: Jetzt PR√ÑMIE abholen", fromName:"Lotto Online", from:"gewinn@lotto-online.net", time:"10:05", snippet:"Herzlichen Gl√ºckwunsch! Folgen Sie dem Link zur Pr√§mie.", g:0, k:1, l:0, c:1, d:1, y:1 },
      { subj:"Rechnung Oktober", fromName:"Buchhaltung", from:"invoice@contoso.com", time:"08:01", snippet:"Ihre Monatsabrechnung ist verf√ºgbar.", g:0, k:1, l:0, c:0, d:0, y:0 },
      { subj:"Elternabend ‚Äì Raum√§nderung", fromName:"Sekretariat HSA Klunkau", from:"sekretariat@hsa-klunkau.de", time:"07:43", snippet:"Bitte beachten: Der Elternabend findet nun in Raum B104 statt.", g:0, k:0, l:0, c:0, d:0, y:0 },
      { subj:"Einladung: Fachgruppe Informatik ‚Äì Protokoll", fromName:"Fachgruppe", from:"kollegium@hs-klunkau.de", time:"15:06", snippet:"Anbei das Protokoll der letzten Sitzung.", g:0, k:0, l:0, c:0, d:0, y:0 }
    ];
    let data = DEFAULT_DATA.slice();

    const FEATS = [
      { key:"g", label:"Betreff enth√§lt ¬ªgratis¬´" },
      { key:"k", label:"Verd√§chtige/typo Absenderdom√§ne" },
      { key:"l", label:"Betreff in ALL CAPS" },
      { key:"c", label:"Dringlichkeit/Alarm" },
      { key:"d", label:"Werbung/Promo-Sprache" }
    ];

    /* ---------- Helpers ---------- */
    const $ = (id) => document.getElementById(id);
    const currentMail = ()=> data[$("emailSelect").selectedIndex || 0];
    const mailToFeatVec = (m)=> [m.g, m.k, m.l, m.c, m.d];
    const escapeHtml = (s)=> String(s).replace(/[&<>"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]));
    function initials(name){ return (name||"?").split(/\s+/).map(p=>p[0]).filter(Boolean).slice(0,2).join("").toUpperCase(); }

    /* ---------- UI Nodes ---------- */
    const emailSelect = $("emailSelect");
    const goldTag = $("goldTag");
    const featTableBody = document.querySelector("#featTable tbody");
    const dataHead = $("dataHead");
    const dataBody = $("dataBody");
    const compareBody = $("compareBody");
    const inbox = $("inbox");

    // Regel-Checkboxes
    const ruleChecks = { r0:null, r1:null, r2:null, r3:null, r4:null };
    function resolveRuleRefs(){
      ruleChecks.r0 = document.querySelector('input[data-key="r0"]');
      ruleChecks.r1 = document.querySelector('input[data-key="r1"]');
      ruleChecks.r2 = document.querySelector('input[data-key="r2"]');
      ruleChecks.r3 = document.querySelector('input[data-key="r3"]');
      ruleChecks.r4 = document.querySelector('input[data-key="r4"]');
    }
    resolveRuleRefs();
    const ruleOrderSel = $("ruleOrder");
    const ruleOut = $("ruleOut");
    const ruleWhy = $("ruleWhy");
    const ruleAcc = $("ruleAcc");
    const ruleTP = $("ruleTP");
    const ruleFP = $("ruleFP");

    // Perzeptron
    const sliders = {
      w0:[$("w0"),$("w0Val")], w1:[$("w1"),$("w1Val")], w2:[$("w2"),$("w2Val")],
      w3:[$("w3"),$("w3Val")], w4:[$("w4"),$("w4Val")], theta:[$("theta"),$("thetaVal")]
    };
    const neuSum = $("neuSum");
    const neuOut = $("neuOut");
    const neuAcc = $("neuAcc");
    const neuTP = $("neuTP");
    const neuFP = $("neuFP");

    /* ---------- Rendering ---------- */
    function renderInboxCard(){
      const m = currentMail();
      inbox.innerHTML = `
        <div class="email-card">
          <div class="avatar" aria-hidden="true">${escapeHtml(initials(m.fromName))}</div>
          <div>
            <div class="subject">${escapeHtml(m.subj)}</div>
            <div class="snippet">${escapeHtml(m.snippet||"")}</div>
            <div class="meta">Von ${escapeHtml(m.fromName)} &lt;${escapeHtml(m.from)}&gt; <span class="label ${m.y? "pill-bad":"pill-ok"}">${m.y? "Soll: Spam":"Soll: kein Spam"}</span></div>
          </div>
          <div class="meta">${escapeHtml(m.time||"")}</div>
        </div>`;
    }

    function renderEmailSelect(){
      const prev = emailSelect.selectedIndex;
      emailSelect.innerHTML = data.map((m,i)=>`<option value="${i}">${i+1}. ${escapeHtml(m.subj)}</option>`).join("");
      emailSelect.selectedIndex = (prev>=0 && prev < data.length) ? prev : 0;
      $("idxTotal").textContent = data.length;
      $("idxNow").textContent = (emailSelect.selectedIndex+1);
    }

    function renderFeatTable(){
      const m = currentMail();
      goldTag.textContent = `Soll: ${m.y===1? "Spam":"kein Spam"}`;
      goldTag.className = "label " + (m.y? "pill-bad":"pill-ok");
      const map=["g","k","l","c","d"];
      featTableBody.innerHTML = map.map((k,idx)=> `<tr><td>${FEATS[idx].label}</td><td class="mono">${m[k]}</td></tr>`).join("");
    }

    function renderDataTable(){
      dataHead.innerHTML = `<tr>
        <th>Betreff</th>
        ${FEATS.map(f=>`<th>${f.label}</th>`).join("")}
        <th>Soll (Spam)</th>
      </tr>`;
      dataBody.innerHTML = data.map((m)=>{
        const vals = ["g","k","l","c","d"].map(k=>`<td class="mono">${m[k]}</td>`).join("");
        return `<tr>
          <td>${escapeHtml(m.subj)}</td>
          ${vals}
          <td class="mono">${m.y}</td>
        </tr>`;
      }).join("");
    }

    /* ---------- Modelle ---------- */
    function predRule(m){
      const rules = [];
      if(ruleChecks.r0?.checked && m.g===1) rules.push(FEATS[0].label);
      if(ruleChecks.r1?.checked && m.k===1) rules.push(FEATS[1].label);
      if(ruleChecks.r2?.checked && m.l===1) rules.push(FEATS[2].label);
      if(ruleChecks.r3?.checked && m.c===1) rules.push(FEATS[3].label);
      if(ruleChecks.r4?.checked && m.d===1) rules.push(FEATS[4].label);
      const order = ruleOrderSel.value;
      const why = (order==="prioritizeSpam") ? `Regeln (Spam zuerst): ${rules.join(" OR ") || "‚Äî"}` : `Regeln: ${rules.join(" OR ") || "‚Äî"}`;
      const y = rules.length>0 ? 1 : 0;
      return [y, y? `Match: ${why}` : `${why} | Default ‚áí kein Spam`];
    }

    function getWeights(){ return ["w0","w1","w2","w3","w4"].map(id=> parseFloat(sliders[id][0].value)); }
    function setWeights(ws){ ["w0","w1","w2","w3","w4"].forEach((id,i)=>{ sliders[id][0].value = ws[i]; sliders[id][1].value = ws[i]; }); }
    const getTheta = ()=> parseFloat(sliders.theta[0].value);

    function predNeuron(m){
      const x = mailToFeatVec(m);
      const w = getWeights();
      const sum = x.reduce((s,xi,i)=> s + xi*w[i], 0);
      const y = sum >= getTheta() ? 1 : 0;
      return {sum, y};
    }

    function evaluate(modelFn){
      let tp=0, tn=0, fp=0, fn=0;
      for(const m of data){
        const p = modelFn(m);
        const yhat = Array.isArray(p) ? p[0] : p.y;
        if(yhat===1 && m.y===1) tp++;
        else if(yhat===0 && m.y===0) tn++;
        else if(yhat===1 && m.y===0) fp++;
        else fn++;
      }
      const acc = data.length ? ((tp+tn)/data.length) : 0;
      return {acc, tp, tn, fp, fn};
    }

    /* ---------- Vergleich ---------- */
    function renderCompare(){
      compareBody.innerHTML = data.map(m=>{
        const r = predRule(m)[0];
        const n = predNeuron(m).y;
        return `<tr>
          <td>${escapeHtml(m.subj)}</td>
          <td class="${r? "bad":"ok"}">${r? "Spam":"kein Spam"}</td>
          <td class="${n? "bad":"ok"}">${n? "Spam":"kein Spam"}</td>
          <td class="${m.y? "bad":"ok"}">${m.y? "Spam":"kein Spam"}</td>
        </tr>`;
      }).join("");
    }

    /* ---------- Render core ---------- */
    function renderDecisions(){
      const [yr, why] = predRule(currentMail());
      ruleOut.textContent = yr? "Spam" : "kein Spam";
      ruleOut.className = "out " + (yr? "bad":"ok");
      ruleWhy.textContent = why;
      const sr = evaluate(predRule);
      ruleAcc.textContent = (sr.acc*100).toFixed(0)+"%";
      ruleTP.textContent = `${sr.tp} / ${sr.tn}`;
      ruleFP.textContent = `${sr.fp} / ${sr.fn}`;

      const pn = predNeuron(currentMail());
      neuSum.textContent = `Summe = ${pn.sum.toFixed(2)}  ${pn.sum >= getTheta()? "‚â•":"<"}  Œ∏=${getTheta().toFixed(2)}`;
      neuOut.textContent = pn.y? "Spam":"kein Spam";
      neuOut.className = "out " + (pn.y? "bad":"ok");
      const sn = evaluate(predNeuron);
      neuAcc.textContent = (sn.acc*100).toFixed(0)+"%";
      neuTP.textContent = `${sn.tp} / ${sn.tn}`;
      neuFP.textContent = `${sn.fp} / ${sn.fn}`;
    }

    function updateAll(){
      renderInboxCard();
      renderFeatTable();
      renderDecisions();
      renderCompare();
    }

    /* ---------- Training ---------- */
    let trainHistory = []; // [{epoch, updates, w:[...], theta}]
    function snapshot(epoch, updates){
      trainHistory.push({ epoch, updates, w: getWeights().slice(), theta: getTheta() });
      // simple tables
      $("epochTableBody").innerHTML = trainHistory.map(h=> `<tr><td>${h.epoch}</td><td>${h.updates}</td></tr>`).join("");
      $("weightTableBody").innerHTML = trainHistory.map(h=>{
        const w = h.w.map(v=> v.toFixed(2));
        return `<tr><td>${h.epoch}</td><td>${w[0]}</td><td>${w[1]}</td><td>${w[2]}</td><td>${w[3]}</td><td>${w[4]}</td><td>${h.theta.toFixed(2)}</td></tr>`;
      }).join("");
    }
    function resetTrainingDisplays(){
      trainHistory = [];
      $("epochTableBody").innerHTML = "";
      $("weightTableBody").innerHTML = "";
      $("trainLog").textContent = "";
    }
    function trainPerceptron(epochs=50, lr=0.2, singleEpoch=false){
      if(trainHistory.length===0) snapshot(0, 0); // Startzustand
      let w = getWeights();
      let theta = getTheta();
      for(let e=1; e<=epochs; e++){
        let updates = 0;
        for(const m of data){
          const x = mailToFeatVec(m);
          const sum = x.reduce((s,xi,i)=> s + xi*w[i], 0);
          const yhat = sum >= theta ? 1 : 0;
          const error = m.y - yhat;
          if(error!==0){
            for(let i=0;i<w.length;i++) w[i] = Math.max(-2,Math.min(2, w[i] + lr*error*x[i]));
            theta = Math.max(0, Math.min(3, theta - lr*error));
            updates++;
          }
        }
        // round to 2 decimals
        w = w.map(v=> +v.toFixed(2));
        theta = +theta.toFixed(2);
        setWeights(w);
        sliders.theta[0].value = theta; sliders.theta[1].value = theta;
        snapshot(e, updates);
        $("trainLog").textContent += `Epoche ${e}: ${updates===0? "keine √Ñnderung":"Updates: "+updates}\n`;
        if(updates===0 || singleEpoch) break;
      }
      updateAll();
    }

    /* ---------- Events ---------- */
    emailSelect.addEventListener("change", ()=>{ updateAll(); $("idxNow").textContent = (emailSelect.selectedIndex+1); });

    document.addEventListener("change", (e)=>{
      if(e.target && e.target.matches('input[type="checkbox"].r')) updateAll();
    });
    ruleOrderSel.addEventListener("change", updateAll);

    // Slider + Number koppeln
    Object.values(sliders).forEach(([range, number])=>{
      range.addEventListener("input", ()=>{ number.value = range.value; updateAll(); });
      number.addEventListener("input", ()=>{ range.value = number.value; updateAll(); });
    });

    // Navigator
    $("prevMail").addEventListener("click", ()=>{
      emailSelect.selectedIndex = Math.max(0, emailSelect.selectedIndex-1);
      emailSelect.dispatchEvent(new Event('change'));
    });
    $("nextMail").addEventListener("click", ()=>{
      emailSelect.selectedIndex = Math.min(data.length-1, emailSelect.selectedIndex+1);
      emailSelect.dispatchEvent(new Event('change'));
    });

    // Autoplay
    let timer = null;
    $("autoPlay").addEventListener("click", ()=>{
      if(timer){ clearInterval(timer); timer=null; $("autoPlay").textContent='Auto'; return; }
      $("autoPlay").textContent='Stopp';
      timer = setInterval(()=>{
        emailSelect.selectedIndex = (emailSelect.selectedIndex+1) % data.length;
        emailSelect.dispatchEvent(new Event('change'));
      }, 2500);
    });

    // Screenshot-Modus (Shadows aus)
    $("btnShot").addEventListener("click", ()=>{ document.documentElement.classList.toggle('screenshot'); });

    /* ---------- Initial ---------- */
    // Labels in Regel-Box
    $("ruleLbl0").textContent = FEATS[0].label;
    $("ruleLbl1").textContent = FEATS[1].label;
    $("ruleLbl2").textContent = FEATS[2].label;
    $("ruleLbl3").textContent = FEATS[3].label;
    $("ruleLbl4").textContent = FEATS[4].label;

    renderDataTable();
    renderEmailSelect();
    updateAll();

    // Training-Buttons
    $("fitOnce").addEventListener("click", ()=>{ resetTrainingDisplays(); snapshot(0,0); trainPerceptron(1, 0.2, true); });
    $("fitAuto").addEventListener("click", ()=>{ resetTrainingDisplays(); snapshot(0,0); trainPerceptron(50, 0.2, false); });
    $("resetW").addEventListener("click", ()=>{
      resetTrainingDisplays();
      setWeights([0.8,-0.5,0.6,0.4,0.7]);
      sliders.theta[0].value=0.7; sliders.theta[1].value=0.7;
      updateAll();
    });
  });
  </script>
</body>
</html>






