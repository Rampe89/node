<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Von der Wenn-Dann-Regel zum lernenden System – Spamfilter Demo</title>
  <style>
    :root{
      --bg:#f7fafc; --panel:#ffffff; --ink:#0b1220; --muted:#4b5563; --accent:#2563eb;
      --ok:#16a34a; --bad:#dc2626; --border:#e5e7eb; --shadow:0 1px 2px rgba(0,0,0,.05);
      --radius:12px; --card:#ffffff; --meta:#6b7280;
      --divider:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:16px/1.6 Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Helvetica, Arial;
      color:var(--ink); background:var(--bg);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:24px}
    header{display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:12px}
    h1{font-size:24px; margin:0; font-weight:800; letter-spacing:.2px}
    h2{margin:0 0 6px; font-size:18px}
    h3{margin:0 0 6px; font-size:15px}
    .small{font-size:13px; color:var(--muted)}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .grid{display:grid; grid-template-columns:300px 1fr; gap:16px}
    .panel{
      background:var(--panel); border:1px solid var(--border); border-radius:var(--radius);
      padding:16px; box-shadow:var(--shadow);
    }
    .section{margin-top:16px}
    .divider{height:1px; background:var(--divider); margin:12px 0}
    .pill{display:inline-block; font-size:12px; padding:4px 10px; border-radius:999px; background:#eef2ff; color:#1f2937; border:1px solid var(--border)}

    select,input,button,textarea{
      background:#ffffff; border:1px solid var(--border); color:var(--ink);
      padding:10px 12px; border-radius:10px; height:40px
    }
    input[type="range"]{height:auto}
    button{cursor:pointer; transition:transform .12s ease}
    button.primary{background:var(--accent); color:#ffffff; border-color:var(--accent); font-weight:700}
    button:hover{transform:translateY(-1px)}
    button:focus-visible, .switch:focus-visible, input:focus-visible, select:focus-visible{
      outline:2px solid var(--accent); outline-offset:2px
    }

    table{width:100%; border-collapse:collapse; background:#ffffff; border:1px solid var(--border); border-radius:8px; overflow:hidden}
    th,td{border-bottom:1px solid var(--border); padding:10px; text-align:left}
    thead th{background:#f3f4f6; font-weight:700; font-size:13px; color:#374151}

    .out{font-weight:800; font-size:18px}
    .ok{color:var(--ok)} .bad{color:var(--bad)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

    /* Inbox */
    .inbox{display:grid; gap:12px}
    .email-card{
      display:grid; grid-template-columns:40px 1fr auto; gap:12px; align-items:center;
      background:#ffffff; border:1px solid var(--border); border-radius:10px; padding:12px; box-shadow:0 1px 2px rgba(0,0,0,.04)
    }
    .avatar{
      width:32px; height:32px; border-radius:999px; background:#e5e7eb; color:#374151;
      display:grid; place-items:center; font-weight:700; font-size:12px
    }
    .subject{font-weight:800}
    .snippet{color:var(--muted); font-size:14px; margin-top:2px}
    .meta{color:var(--meta); font-size:12px}
    .label{display:inline-block; font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid var(--border); background:#f9fafb; margin-left:6px}

    /* Entscheidung */
    .decision{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .decision .box{background:#ffffff; border:1px solid var(--border); border-radius:10px; padding:12px}

    /* Modus-Schalter */
    .mode{display:flex; align-items:center; gap:8px}
    .switch{position:relative; width:64px; height:32px; background:#f3f4f6; border-radius:999px; border:1px solid var(--border); cursor:pointer}
    .switch::after{content:""; position:absolute; top:2px; left:2px; width:28px; height:28px; border-radius:999px; background:#ffffff; border:1px solid var(--border); transition:left .15s}
    .switch.on{background:#dbeafe; border-color:#bfdbfe}
    .switch.on::after{left:34px}

    /* Screenshot-Ansicht: ohne Schatten */
    .screenshot .panel,.screenshot .email-card{box-shadow:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Von der Wenn-Dann-Regel zum lernenden System · Spamfilter (Demo)</h1>
        <div class="small">Posteingang simulieren, Regeln prüfen, Perzeptron testen. Direktstart.</div>
      </div>
      <div class="row">
        <button id="btnShot">Screenshot-Ansicht</button>
      </div>
    </header>

    <div class="grid">
      <!-- Sidebar -->
      <aside class="panel">
        <h2>Datensatz</h2>
        <p class="small">Beispiel-Mails. Features sind 0/1. „Soll“ = korrektes Label.</p>

        <div class="row">
          <label>Mail:
            <select id="emailSelect" aria-label="Beispiel-Mail wählen"></select>
          </label>
          <span id="goldTag" class="pill">Soll: –</span>
        </div>

        <div class="divider"></div>

        <table id="featTable" aria-label="Merkmalswerte">
          <thead><tr><th>Feature</th><th>Wert</th></tr></thead>
          <tbody></tbody>
        </table>

        <details class="section">
          <summary>Alle Datensätze</summary>
          <table id="dataTable" style="margin-top:8px">
            <thead id="dataHead"></thead>
            <tbody id="dataBody"></tbody>
          </table>
        </details>
      </aside>

      <!-- Main -->
      <main style="display:grid;gap:16px">
        <!-- Inbox -->
        <section class="panel">
          <div class="row" style="justify-content:space-between">
            <h2 style="margin:0">Posteingang</h2>
            <div class="row">
              <button id="prevMail">⟨ Zurück</button>
              <button id="nextMail" class="primary">Weiter ⟩</button>
              <button id="autoPlay">Auto</button>
              <span class="small">Mail <span id="idxNow">1</span>/<span id="idxTotal">–</span></span>
            </div>
          </div>
          <div class="divider"></div>
          <div id="inbox" class="inbox"></div>

          <div class="section">
            <div class="decision">
              <div class="box">
                <h3>Regelbasierte Entscheidung</h3>
                <div id="ruleWhy" class="small mono">Regeln: –</div>
                <div id="ruleOut" class="out" aria-live="polite">–</div>
                <div class="divider"></div>
                <h4 style="margin:0 0 4px 0">Auswertung</h4>
                <div class="small mono">Trefferquote: <span id="ruleAcc">–</span></div>
                <div class="small mono">TP / TN: <span id="ruleTP">–</span></div>
                <div class="small mono">FP / FN: <span id="ruleFP">–</span></div>
              </div>
              <div class="box" id="learnBox">
                <h3>Perzeptron-Entscheidung</h3>
                <div id="neuSum" class="small mono">Summe = –</div>
                <div id="neuOut" class="out" aria-live="polite">–</div>
                <div class="divider"></div>
                <h4 style="margin:0 0 4px 0">Auswertung</h4>
                <div class="small mono">Trefferquote: <span id="neuAcc">–</span></div>
                <div class="small mono">TP / TN: <span id="neuTP">–</span></div>
                <div class="small mono">FP / FN: <span id="neuFP">–</span></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Regel-Panel -->
        <section class="panel" id="rulePanel">
          <div class="row" style="justify-content:space-between">
            <h2 style="margin:0">Regelbasierter Filter (Wenn-Dann)</h2>
            <div class="mode" title="Regelbasiert ↔ Lernendes System">
              <span class="small">Lernmodus:</span>
              <div id="modeSwitch" class="switch" role="switch" aria-checked="true" aria-label="Lernmodus umschalten" tabindex="0"></div>
              <span id="modeText" class="small">An</span>
            </div>
          </div>
          <div class="divider"></div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <details open><summary>Regeln bearbeiten</summary>
              <div class="row"><label><input type="checkbox" class="r" data-key="r0" checked> <span id="ruleLbl0">Betreff enthält »gratis«</span> ⇒ Spam</label></div>
              <div class="row"><label><input type="checkbox" class="r" data-key="r1" checked> <span id="ruleLbl1">Verdächtige/typo Absenderdomäne</span> ⇒ Spam</label></div>
              <div class="row"><label><input type="checkbox" class="r" data-key="r2" checked> <span id="ruleLbl2">Betreff in ALL CAPS</span> ⇒ Spam</label></div>
              <div class="row"><label><input type="checkbox" class="r" data-key="r3" checked> <span id="ruleLbl3">Dringlichkeit/Alarm</span> ⇒ Spam</label></div>
              <div class="row"><label><input type="checkbox" class="r" data-key="r4" checked> <span id="ruleLbl4">Werbung/Promo-Sprache</span> ⇒ Spam</label></div>
              <div class="row"><label>Reihenfolge:
                <select id="ruleOrder" aria-label="Regelreihenfolge">
                  <option value="natural">Natürliche Reihenfolge</option>
                  <option value="prioritizeSpam">„Spam“-Regeln zuerst</option>
                </select>
              </label></div>
            </details>
            <div>
              <h3 style="margin:0 0 6px 0">Modellgüte (akt. Einstellungen)</h3>
              <div class="small mono">Trefferquote: <span id="ruleAccTop">–</span></div>
              <div class="small mono">TP / TN: <span id="ruleTPTop">–</span></div>
              <div class="small mono">FP / FN: <span id="ruleFPTop">–</span></div>
            </div>
          </div>
        </section>

        <!-- Neuron-Panel -->
        <section class="panel" id="neuronPanel">
          <h2 style="margin:0">Lernendes System (Perzeptron)</h2>
          <div class="divider"></div>

          <div class="small">Gewichtete Summe der Merkmale, Vergleich mit Schwelle θ.</div>
          <div class="row" style="flex-wrap:wrap;margin-top:6px">
            <label id="wName0">w₁ <input id="w0" type="range" min="-2" max="2" step="0.1" value="0.8"><input id="w0Val" type="number" min="-2" max="2" step="0.1" value="0.8" style="width:80px"></label>
            <label id="wName1">w₂ <input id="w1" type="range" min="-2" max="2" step="0.1" value="-0.5"><input id="w1Val" type="number" min="-2" max="2" step="0.1" value="-0.5" style="width:80px"></label>
            <label id="wName2">w₃ <input id="w2" type="range" min="-2" max="2" step="0.1" value="0.6"><input id="w2Val" type="number" min="-2" max="2" step="0.1" value="0.6" style="width:80px"></label>
            <label id="wName3">w₄ <input id="w3" type="range" min="-2" max="2" step="0.1" value="0.4"><input id="w3Val" type="number" min="-2" max="2" step="0.1" value="0.4" style="width:80px"></label>
            <label id="wName4">w₅ <input id="w4" type="range" min="-2" max="2" step="0.1" value="0.7"><input id="w4Val" type="number" min="-2" max="2" step="0.1" value="0.7" style="width:80px"></label>
            <label>θ <input id="theta" type="range" min="0" max="3" step="0.1" value="0.7"><input id="thetaVal" type="number" min="0" max="3" step="0.1" value="0.7" style="width:80px"></label>
          </div>

          <div class="divider"></div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px">
            <div>
              <h3 style="margin:0 0 6px 0">Modellgüte (aktuelle Gewichte)</h3>
              <div class="small mono">Trefferquote: <span id="neuAcc">–</span></div>
              <div class="small mono">TP / TN: <span id="neuTP">–</span></div>
              <div class="small mono">FP / FN: <span id="neuFP">–</span></div>
            </div>
            <div>
              <h3 style="margin:0 0 6px 0">Training</h3>
              <div class="row" style="margin-top:4px">
                <button id="fitOnce">🚀 1× trainieren</button>
                <button id="fitAuto" class="primary">🤖 Auto-Training (Perzeptron)</button>
                <button id="resetW">🔁 Gewichte zurücksetzen</button>
              </div>
              <div id="trainLog" class="small mono" style="margin-top:8px;max-height:120px;overflow:auto;border:1px solid var(--border);border-radius:8px;padding:8px"></div>
              <details class="section">
                <summary>📉 Fehler pro Epoche</summary>
                <table style="margin-top:8px">
                  <thead><tr><th>Epoche</th><th>Anzahl Updates (Fehler)</th></tr></thead>
                  <tbody id="epochTableBody"></tbody>
                </table>
              </details>
              <details class="section">
                <summary>⚖️ Gewichtsverlauf (w₁…w₅, θ)</summary>
                <div class="small" style="margin:6px 0">Werte nach jeder Epoche (inkl. Startzustand als Epoche 0).</div>
                <table>
                  <thead><tr><th>Epoche</th><th>w₁</th><th>w₂</th><th>w₃</th><th>w₄</th><th>w₅</th><th>θ</th></tr></thead>
                  <tbody id="weightTableBody"></tbody>
                </table>
              </details>
            </div>
          </div>
        </section>

        <!-- Vergleich -->
        <section class="panel" id="comparePanel">
          <h2 style="margin:0">Direkter Vergleich</h2>
          <div class="divider"></div>
          <table>
            <thead><tr><th>Mail</th><th>Regelbasiert</th><th>Mini-Neuron</th><th>Soll</th></tr></thead>
            <tbody id="compareBody"></tbody>
          </table>
        </section>
      </main>
    </div>

    <div class="small" style="margin-top:12px;color:#6b7280">© Demo, frei nutzbar.</div>
  </div>

  <script>
  "use strict";
  document.addEventListener("DOMContentLoaded", function(){
    /* ---------- Daten ---------- */
    // g: "gratis" im Betreff, k: verdächtige/typo Domäne, l: ALL CAPS, c: Dringlichkeit/Alarm, d: Werbung/Promo
    const DEFAULT_DATA = [
      { subj:"GRATIS IPHONE JETZT SICHERN", fromName:"Gewinn-Club", from:"support@rnicrosoft.com", time:"09:12", snippet:"Nur heute: Jetzt sichern und abholen.", g:1, k:1, l:1, c:1, d:1, y:1 },
      { subj:"WICHTIG: IHR PAKET KONNTE NICHT ZUGESTELLT WERDEN", fromName:"Zustellung", from:"benachrichtigung@am4zon-help.net", time:"11:28", snippet:"Bestätigen Sie Ihre Adresse, um die Zustellung abzuschließen.", g:0, k:1, l:1, c:1, d:0, y:1 },
      { subj:"SONDERAKTION HEUTE NUR FÜR SIE", fromName:"Shopping World", from:"deals@shopping-world.net", time:"08:41", snippet:"Exklusive Rabatte für kurze Zeit.", g:0, k:0, l:1, c:1, d:1, y:1 },
      { subj:"Gewinn bestätigt: Jetzt PRÄMIE abholen", fromName:"Lotto Online", from:"gewinn@lotto-online.net", time:"10:05", snippet:"Herzlichen Glückwunsch! Folgen Sie dem Link zur Prämie.", g:0, k:1, l:0, c:1, d:1, y:1 },
      { subj:"Rechnung Oktober", fromName:"Buchhaltung", from:"invoice@contoso.com", time:"08:01", snippet:"Ihre Monatsabrechnung ist verfügbar.", g:0, k:1, l:0, c:0, d:0, y:1 },
      { subj:"Elternabend – Raumänderung", fromName:"Sekretariat HSA Klunkau", from:"sekretariat@hsa-klunkau.de", time:"07:43", snippet:"Bitte beachten: Der Elternabend findet nun in Raum B104 statt.", g:0, k:0, l:0, c:0, d:0, y:0 },
      { subj:"Einladung: Fachgruppe Informatik – Protokoll", fromName:"Fachgruppe", from:"kollegium@hs-klunkau.de", time:"15:06", snippet:"Anbei das Protokoll der letzten Sitzung.", g:0, k:0, l:0, c:0, d:0, y:0 }
    ];
    let data = JSON.parse(localStorage.getItem("spamDemoDataFixed") || "null") || DEFAULT_DATA.slice();

    // Feature-Labels (fix)
    let FEATS = [
      { key:"g", label:"Betreff enthält »gratis«" },
      { key:"k", label:"Verdächtige/typo Absenderdomäne" },
      { key:"l", label:"Betreff in ALL CAPS" },
      { key:"c", label:"Dringlichkeit/Alarm" },
      { key:"d", label:"Werbung/Promo-Sprache" }
    ];

    /* ---------- Helpers ---------- */
    const $ = (id) => document.getElementById(id);
    const saveData = ()=> localStorage.setItem("spamDemoDataFixed", JSON.stringify(data));
    const currentMail = ()=> data[$("emailSelect").selectedIndex || 0];
    const mailToFeatVec = (m)=> [m.g, m.k, m.l, m.c, m.d];
    const escapeHtml = (s)=> String(s).replace(/[&<>"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]));

    /* ---------- Regel & Neuron ---------- */
    const modeSwitch = $("modeSwitch");
    const modeText = $("modeText");
    let mode = "learn"; // Lernmodus standardmäßig AN

    const emailSelect = $("emailSelect");
    const goldTag = $("goldTag");
    const featTableBody = document.querySelector("#featTable tbody");
    const dataHead = $("dataHead");
    const dataBody = $("dataBody");
    const compareBody = $("compareBody");

    // Regel-Checkboxes
    const ruleChecks = { r0:null, r1:null, r2:null, r3:null, r4:null };
    function resolveRuleRefs(){
      ruleChecks.r0 = document.querySelector('input[data-key="r0"]');
      ruleChecks.r1 = document.querySelector('input[data-key="r1"]');
      ruleChecks.r2 = document.querySelector('input[data-key="r2"]');
      ruleChecks.r3 = document.querySelector('input[data-key="r3"]');
      ruleChecks.r4 = document.querySelector('input[data-key="r4"]');
    }
    resolveRuleRefs();

    const ruleOrderSel = $("ruleOrder");
    const ruleOut = $("ruleOut");
    const ruleWhy = $("ruleWhy");
    const ruleAcc = $("ruleAcc");
    const ruleTP = $("ruleTP");
    const ruleFP = $("ruleFP");
    const ruleAccTop = $("ruleAccTop");
    const ruleTPTop = $("ruleTPTop");
    const ruleFPTop = $("ruleFPTop");

    const sliders = {
      w0:[$("w0"),$("w0Val")], w1:[$("w1"),$("w1Val")], w2:[$("w2"),$("w2Val")],
      w3:[$("w3"),$("w3Val")], w4:[$("w4"),$("w4Val")], theta:[$("theta"),$("thetaVal")]
    };
    const neuSum = $("neuSum");
    const neuOut = $("neuOut");
    const neuAcc = $("neuAcc");
    const neuTP = $("neuTP");
    const neuFP = $("neuFP");

    /* ---------- Inbox Rendering ---------- */
    const inbox = $("inbox");
    function initials(name){
      return (name||"?").split(/\s+/).map(p=>p[0]).filter(Boolean).slice(0,2).join("").toUpperCase();
    }
    function renderInboxCard(){
      const m = currentMail();
      inbox.innerHTML = `
        <div class="email-card">
          <div class="avatar" aria-hidden="true">${escapeHtml(initials(m.fromName))}</div>
          <div>
            <div class="subject">${escapeHtml(m.subj)}</div>
            <div class="snippet">${escapeHtml(m.snippet||"")}</div>
            <div class="meta">Von ${escapeHtml(m.fromName)} &lt;${escapeHtml(m.from)}&gt; <span class="label">${m.y?"Soll: Spam":"Soll: kein Spam"}</span></div>
          </div>
          <div class="meta">${escapeHtml(m.time||"")}</div>
        </div>`;
    }

    /* ---------- Modelle ---------- */
    function predRule(m){
      const rules = [];
      if(ruleChecks.r0?.checked && m.g===1) rules.push(FEATS[0].label);
      if(ruleChecks.r1?.checked && m.k===1) rules.push(FEATS[1].label);
      if(ruleChecks.r2?.checked && m.l===1) rules.push(FEATS[2].label);
      if(ruleChecks.r3?.checked && m.c===1) rules.push(FEATS[3].label);
      if(ruleChecks.r4?.checked && m.d===1) rules.push(FEATS[4].label);
      const order = ruleOrderSel.value;
      const why = (order==="prioritizeSpam")
        ? `Regeln (Spam zuerst): ${rules.join(" OR ") || "—"}`
        : `Regeln: ${rules.join(" OR ") || "—"}`;
      const y = rules.length>0 ? 1 : 0;
      return [y, y? `Match: ${why}` : `${why} | Default ⇒ kein Spam`];
    }
    function getWeights(){ return ["w0","w1","w2","w3","w4"].map(id=> parseFloat(sliders[id][0].value)); }
    const getTheta = ()=> parseFloat(sliders.theta[0].value);
    function predNeuron(m){
      const x = mailToFeatVec(m);
      const w = getWeights();
      const sum = x.reduce((s,xi,i)=> s + xi*w[i], 0);
      const y = sum >= getTheta() ? 1 : 0;
      return {sum, y};
    }
    function evaluate(modelFn){
      let tp=0, tn=0, fp=0, fn=0;
      for(const m of data){
        const p = modelFn(m);
        const yhat = Array.isArray(p) ? p[0] : p.y;
        if(yhat===1 && m.y===1) tp++;
        else if(yhat===0 && m.y===0) tn++;
        else if(yhat===1 && m.y===0) fp++;
        else fn++;
      }
      const acc = data.length ? ((tp+tn)/data.length) : 0;
      return {acc, tp, tn, fp, fn};
    }

    /* ---------- Vergleich ---------- */
    function renderCompare(){
      compareBody.innerHTML = data.map(m=>{
        const r = predRule(m)[0];
        const n = predNeuron(m).y;
        return `<tr>
          <td>${escapeHtml(m.subj)}</td>
          <td class="${r? "bad":"ok"}">${r? "Spam":"kein Spam"}</td>
          <td class="${n? "bad":"ok"}">${n? "Spam":"kein Spam"}</td>
          <td class="${m.y? "bad":"ok"}">${m.y? "Spam":"kein Spam"}</td>
        </tr>`;
      }).join("");
    }

    /* ---------- Render ---------- */
    function renderEmailSelect(){
      const prev = emailSelect.selectedIndex;
      emailSelect.innerHTML = data.map((m,i)=>`<option value="${i}">${i+1}. ${escapeHtml(m.subj)}</option>`).join("");
      emailSelect.selectedIndex = (prev>=0 && prev < data.length) ? prev : 0;
      $("idxTotal").textContent = data.length;
      $("idxNow").textContent = (emailSelect.selectedIndex+1);
    }
    function renderFeatTable(){
      const m = currentMail();
      goldTag.textContent = `Soll: ${m.y===1? "Spam":"kein Spam"}`;
      goldTag.style.background = m.y? "#fee2e2" : "#dcfce7";
      goldTag.style.borderColor = m.y? "#fecaca" : "#bbf7d0";
      const map=["g","k","l","c","d"];
      featTableBody.innerHTML = map.map((k,idx)=> `<tr><td>${FEATS[idx].label}</td><td class="mono">${m[k]}</td></tr>`).join("");
    }
    function renderDataTable(){
      dataHead.innerHTML = `<tr>
        <th>Betreff</th>
        ${FEATS.map(f=>`<th>${f.label}</th>`).join("")}
        <th>Soll (Spam)</th>
      </tr>`;
      dataBody.innerHTML = data.map((m)=>{
        const vals = ["g","k","l","c","d"].map(k=>`<td class="mono">${m[k]}</td>`).join("");
        return `<tr>
          <td>${escapeHtml(m.subj)}</td>
          ${vals}
          <td class="mono">${m.y}</td>
        </tr>`;
      }).join("");
    }
    function renderDecisions(){
      // Regel
      const [yr, why] = predRule(currentMail());
      ruleOut.textContent = yr? "Spam" : "kein Spam";
      ruleOut.className = "out " + (yr? "bad":"ok");
      ruleWhy.textContent = why;
      const sr = evaluate(predRule);
      ruleAcc.textContent = (sr.acc*100).toFixed(0)+"%";
      ruleTP.textContent = `${sr.tp} / ${sr.tn}`;
      ruleFP.textContent = `${sr.fp} / ${sr.fn}`;
      // Top-Box im Regel-Panel
      ruleAccTop.textContent = (sr.acc*100).toFixed(0)+"%";
      ruleTPTop.textContent = `${sr.tp} / ${sr.tn}`;
      ruleFPTop.textContent = `${sr.fp} / ${sr.fn}`;

      // Perzeptron
      const pn = predNeuron(currentMail());
      neuSum.textContent = `Summe = ${pn.sum.toFixed(2)}  ${pn.sum >= getTheta()? "≥":"<"}  θ=${getTheta().toFixed(2)}`;
      neuOut.textContent = pn.y? "Spam":"kein Spam";
      neuOut.className = "out " + (pn.y? "bad":"ok");
      const sn = evaluate(predNeuron);
      neuAcc.textContent = (sn.acc*100).toFixed(0)+"%";
      neuTP.textContent = `${sn.tp} / ${sn.tn}`;
      neuFP.textContent = `${sn.fp} / ${sn.fn}`;
    }
    function updateAll(){
      renderInboxCard();
      renderFeatTable();
      renderDecisions();
      renderCompare();
      saveData();
    }

    function applyMode(){
      const learn = (mode==="learn");
      modeText.textContent = learn? "An" : "Aus";
      modeSwitch.classList.toggle("on", learn);
      $("learnBox").classList.toggle("hidden", !learn);
      // neuronPanel bleibt sichtbar, weil Training auch bei Aus sinnvoll demonstrierbar ist
      updateAll();
    }

    /* ---------- Events ---------- */
    modeSwitch.addEventListener("click", ()=>{ mode = (mode==="rule" ? "learn" : "rule"); applyMode(); });
    modeSwitch.addEventListener("keydown", (e)=>{ if(e.key==="Enter" || e.key===" "){ e.preventDefault(); mode = (mode==="rule" ? "learn" : "rule"); applyMode(); }});
    emailSelect.addEventListener("change", ()=>{ updateAll(); $("idxNow").textContent = (emailSelect.selectedIndex+1); });

    document.addEventListener("change", (e)=>{ if(e.target && e.target.matches('input[type="checkbox"].r')) updateAll(); });

    ["w0","w1","w2","w3","w4"].forEach(id=>{
      const range = sliders[id][0]; const number = sliders[id][1];
      range.addEventListener("input", ()=>{ number.value = range.value; updateAll(); });
      number.addEventListener("input", ()=>{ range.value = number.value; updateAll(); });
    });
    ["theta"].forEach(id=>{
      const range = sliders[id][0]; const number = sliders[id][1];
      range.addEventListener("input", ()=>{ number.value = range.value; updateAll(); });
      number.addEventListener("input", ()=>{ range.value = number.value; updateAll(); });
    });

    // Navigator
    $("prevMail").addEventListener("click", ()=>{ emailSelect.selectedIndex = Math.max(0, emailSelect.selectedIndex-1); emailSelect.dispatchEvent(new Event('change')); });
    $("nextMail").addEventListener("click", ()=>{ emailSelect.selectedIndex = Math.min(data.length-1, emailSelect.selectedIndex+1); emailSelect.dispatchEvent(new Event('change')); });

    // Auto-Play
    let timer = null;
    $("autoPlay").addEventListener("click", ()=>{
      if(timer){ clearInterval(timer); timer=null; $("autoPlay").textContent='Auto'; return; }
      $("autoPlay").textContent='Stopp';
      timer = setInterval(()=>{
        emailSelect.selectedIndex = (emailSelect.selectedIndex+1) % data.length;
        emailSelect.dispatchEvent(new Event('change'));
      }, 2500);
    });

    // Screenshot Mode
    $("btnShot").addEventListener("click", ()=>{ document.documentElement.classList.toggle('screenshot'); });

    /* ---------- Initial ---------- */
    renderDataTable();
    renderEmailSelect();
    mode = "learn"; // standardmäßig an
    applyMode();
  });
  </script>
</body>
</html>





