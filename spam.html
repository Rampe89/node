<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Von der Wenn-Dann-Regel zum lernenden System ‚Äì Spamfilter Demo</title>
  <style>
    :root{
      --bg:#f7f9fc;--panel:#fff;--ink:#0f172a;--muted:#64748b;--accent:#3b82f6;
      --ok:#16a34a;--warn:#f59e0b;--bad:#ef4444;--border:#e2e8f0;
      --shadow:0 8px 24px rgba(2,6,23,.06);--radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font:17px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial;background:var(--bg);color:var(--ink)}
    a{color:var(--accent)}
    .wrap{max-width:1200px;margin:0 auto;padding:28px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:20px}
    h1{font-size:26px;margin:0;font-weight:800;letter-spacing:.2px}
    .grid{display:grid;grid-template-columns:320px 1fr;gap:18px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);overflow:hidden}
    .panel h2{margin:0 0 8px 0;font-size:20px}
    .panel h3{margin:16px 0 8px 0;font-size:16px;color:var(--muted)}
    .small{font-size:14px;color:var(--muted)}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);padding:8px 12px;border-radius:999px;background:#fff}
    label{display:flex;align-items:center;gap:8px}
    input[type="range"]{width:200px}
    select, input[type="number"], input[type="text"], button, textarea{
      background:#fff;border:1px solid var(--border);color:var(--ink);padding:10px 12px;border-radius:12px;
    }
    select:focus, input:focus, button:focus, textarea:focus{outline:2px solid rgba(59,130,246,.45); outline-offset:2px; box-shadow:none}
    button{cursor:pointer}
    button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    button:hover{transform:translateY(-1px)}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden}
    th,td{border-bottom:1px solid var(--border);padding:10px;text-align:left}
    thead th{background:#f1f5f9;font-weight:700;font-size:14px}
    .tag{font-size:12px;border:1px solid var(--border);padding:4px 10px;border-radius:999px;color:var(--muted);background:#fff}
    .out{font-weight:800}
    .ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .footer{margin-top:18px;color:var(--muted);font-size:13px}
    details{border:1px dashed var(--border);border-radius:12px;padding:8px;background:#fff;margin-top:10px}
    summary{cursor:pointer;color:var(--muted);font-weight:600}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
    .kpi .panel{padding:12px;text-align:center}
    .hidden{display:none}
    /* Mode switch (Schiebeschalter) */
    .mode{display:flex;align-items:center;gap:10px}
    .switch{position:relative;width:72px;height:34px;background:#e5e7eb;border-radius:999px;border:1px solid var(--border);cursor:pointer;transition:background .2s}
    .switch::after{content:"";position:absolute;top:3px;left:3px;width:28px;height:28px;border-radius:999px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.15);transition:left .2s}
    .switch.on{background:#bfdbfe;border-color:#93c5fd}
    .switch.on::after{left:41px}
    .mode-label{font-size:14px;color:var(--muted)}
    /* Phasen */
    .phase{margin-bottom:18px}
    .hero-badge{font-size:12px;background:#e0f2fe;color:#0c4a6e;border-radius:999px;padding:4px 10px;display:inline-block}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Von der Wenn-Dann-Regel zum lernenden System ¬∑ Spamfilter (Demo)</h1>
        <div class="small">Ablauf: Ziele ‚Üí Brainstorming ‚Üí Regeln ‚Üí Lernendes System</div>
      </div>
    </header>

    <!-- Phase 0: Start & Ziele -->
    <section id="phase0" class="panel phase">
      <span class="hero-badge">Start</span>
      <h2>Workshop-Ziele</h2>
      <ul class="small">
        <li>Unterschied feste Entscheidungsregeln vs. lernende Systeme verstehen</li>
        <li>Eigenen Kriterienkatalog f√ºr Spam entwickeln</li>
        <li>Vom Regelwerk zum gewichteten Modell wechseln</li>
      </ul>
      <div class="row" style="margin-top:8px">
        <button id="startBrainstorm" class="primary">Los geht‚Äôs ‚Üí Brainstorming</button>
      </div>
    </section>

    <!-- Phase 1: Brainstorming -->
    <section id="phase1" class="panel phase hidden">
      <span class="hero-badge">Phase 1</span>
      <h2>Brainstorming: Kriterien & Beispiele</h2>
      <div class="small" style="margin-bottom:8px">Nur das erste Feld ist als Orientierung vorausgef√ºllt. Tragt eure eigenen Merkmale und Beispiele ein.</div>

      <h3>Merkmale</h3>
      <div class="row" style="flex-wrap:wrap">
        <label>1 <input id="featName0" type="text" value="Betreff enth√§lt ‚Äögratis‚Äò" style="width:260px"></label>
        <label>2 <input id="featName1" type="text" value="" placeholder="Merkmal 2" style="width:260px"></label>
        <label>3 <input id="featName2" type="text" value="" placeholder="Merkmal 3" style="width:260px"></label>
        <label>4 <input id="featName3" type="text" value="" placeholder="Merkmal 4" style="width:260px"></label>
        <label>5 <input id="featName4" type="text" value="" placeholder="Merkmal 5" style="width:260px"></label>
      </div>

      <h3 style="margin-top:12px">Beispiele erfassen</h3>
      <table id="bsTable">
        <thead>
          <tr>
            <th>Betreff</th>
            <th id="bsHead0">Merkmal 1</th>
            <th id="bsHead1">Merkmal 2</th>
            <th id="bsHead2">Merkmal 3</th>
            <th id="bsHead3">Merkmal 4</th>
            <th id="bsHead4">Merkmal 5</th>
            <th>Soll (Spam)</th>
          </tr>
        </thead>
        <tbody id="bsBody"></tbody>
      </table>
      <div class="row" style="margin-top:8px">
        <button id="bsAdd">‚ûï Zeile</button>
        <button id="bsReset">üóëÔ∏è Leeren</button>
        <button id="bsApply" class="primary">√úbernehmen & weiter ‚Üí Regeln</button>
      </div>
    </section>

    <!-- Phase 2/3: Demo -->
    <section id="phase2" class="phase hidden">
      <div class="panel" style="margin-bottom:18px">
        <div class="row" style="justify-content:space-between">
          <div class="small">Start im Regelmodus. Schiebeschalter f√ºr den Lernmodus.</div>
          <div class="mode" title="Schiebeschalter: Regelbasiert ‚Üî Lernendes System">
            <span class="mode-label">Modus:</span>
            <div id="modeSwitch" class="switch" role="switch" aria-checked="false" tabindex="0"></div>
            <span id="modeText" class="mode-label">Regelbasiert</span>
          </div>
        </div>
      </div>

      <div class="grid">
        <!-- Sidebar -->
        <aside class="panel">
          <h2>Datensatz</h2>
          <p class="small">W√§hle eine Beispiel-Mail. Features sind bin√§r (0/1). ‚ÄûSoll‚Äú ist die korrekte Klassifikation.</p>
          <div class="row">
            <label>Mail:
              <select id="emailSelect"></select>
            </label>
            <span id="goldTag" class="tag">Soll: ‚Äì</span>
          </div>

          <table id="featTable" style="margin-top:10px">
            <thead><tr><th>Feature</th><th>Wert</th></tr></thead>
            <tbody></tbody>
          </table>

          <details style="margin-top:12px">
            <summary>Datens√§tze anzeigen/bearbeiten</summary>
            <div class="small" style="margin:6px 0 8px">Du kannst hier Beispiele hinzuf√ºgen. Werte 0/1, ‚ÄûSoll‚Äú als 0/1.</div>
            <table id="dataTable">
              <thead id="dataHead"></thead>
              <tbody id="dataBody"></tbody>
            </table>
            <div class="row" style="margin-top:8px">
              <button id="addRow">‚ûï Beispiel</button>
              <button id="resetData">üóëÔ∏è Zur√ºcksetzen</button>
            </div>
          </details>
        </aside>

        <!-- Main -->
        <main style="display:grid;gap:18px">
          <section class="panel" id="rulePanel">
            <h2>Regelbasierter Filter (Wenn-Dann)</h2>
            <div class="small">Starre Entscheidungsregeln. Reihenfolge kann Wirkung haben.</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px">
              <div>
                <h3>Regeln</h3>
                <div class="row"><label><input type="checkbox" class="r" data-key="r0" checked> <span id="ruleLbl0">Merkmal 1</span> ‚áí Spam</label></div>
                <div class="row"><label><input type="checkbox" class="r" data-key="r4" checked> <span id="ruleLbl4">Merkmal 5</span> ‚áí Spam</label></div>
                <div class="row"><label><input type="checkbox" class="r" data-key="r1" checked> <span id="ruleLbl1">Merkmal 2</span> ‚áí kein Spam</label></div>
                <div class="row"><label><input type="checkbox" class="r" data-key="r3"> <span id="ruleLbl3">Merkmal 4</span> & <span id="ruleLbl2">Merkmal 3</span> ‚áí Spam</label></div>
                <div class="row"><label>Reihenfolge:
                  <select id="ruleOrder">
                    <option value="natural">Nat√ºrliche Reihenfolge</option>
                    <option value="prioritizeSafe">‚ÄûKein Spam‚Äú zuerst</option>
                    <option value="prioritizeSpam">‚ÄûSpam‚Äú zuerst</option>
                  </select>
                </label></div>
              </div>
              <div>
                <h3>Ausgabe</h3>
                <div id="ruleOut" class="out">‚Äì</div>
                <div id="ruleWhy" class="small mono"></div>
                <div class="kpi">
                  <div class="panel"><div class="small">Trefferquote</div><div id="ruleAcc" class="out">‚Äì</div></div>
                  <div class="panel"><div class="small">TP / TN</div><div id="ruleTP" class="out">‚Äì</div></div>
                  <div class="panel"><div class="small">FP / FN</div><div id="ruleFP" class="out">‚Äì</div></div>
                </div>
              </div>
            </div>
          </section>

          <section class="panel hidden" id="neuronPanel">
            <h2>Gewichtetes ‚ÄûMini-Neuron‚Äú (lernend)</h2>
            <div class="small">Eingabe √ó Gewicht ‚áí Summe ‚áí Schwelle. Optionales Training passt Gewichte an.</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px">
              <div>
                <h3>Gewichte & Schwelle</h3>
                <div class="row"><span class="pill" id="wLbl0">w<sub>1</sub><input type="range" id="w0" min="-1.5" max="1.5" step="0.1" value="0.8"><input id="w0Val" type="number" step="0.1" style="width:70px" value="0.8"></span></div>
                <div class="row"><span class="pill" id="wLbl1">w<sub>2</sub><input type="range" id="w1"  min="-1.5" max="1.5" step="0.1" value="-0.5"><input id="w1Val" type="number" step="0.1" style="width:70px" value="-0.5"></span></div>
                <div class="row"><span class="pill" id="wLbl2">w<sub>3</sub><input type="range" id="w2"  min="-1.5" max="1.5" step="0.1" value="0.6"><input id="w2Val" type="number" step="0.1" style="width:70px" value="0.6"></span></div>
                <div class="row"><span class="pill" id="wLbl3">w<sub>4</sub><input type="range" id="w3"   min="-1.5" max="1.5" step="0.1" value="0.4"><input id="w3Val" type="number" step="0.1" style="width:70px" value="0.4"></span></div>
                <div class="row"><span class="pill" id="wLbl4">w<sub>5</sub><input type="range" id="w4" min="-1.5" max="1.5" step="0.1" value="0.7"><input id="w4Val" type="number" step="0.1" style="width:70px" value="0.7"></span></div>
                <div class="row"><span class="pill">Schwelle Œ∏<input type="range" id="theta" min="0" max="2.5" step="0.05" value="0.7"><input id="thetaVal" type="number" step="0.05" style="width:70px" value="0.7"></span></div>
              </div>
              <div>
                <h3>Ausgabe</h3>
                <div id="neuSum" class="small mono">Summe = ‚Äì</div>
                <div id="neuOut" class="out">‚Äì</div>
                <div class="kpi">
                  <div class="panel"><div class="small">Trefferquote</div><div id="neuAcc" class="out">‚Äì</div></div>
                  <div class="panel"><div class="small">TP / TN</div><div id="neuTP" class="out">‚Äì</div></div>
                  <div class="panel"><div class="small">FP / FN</div><div id="neuFP" class="out">‚Äì</div></div>
                </div>
                <div class="row" style="margin-top:8px">
                  <button id="fitOnce">üöÄ 1√ó trainieren</button>
                  <button id="fitAuto" class="primary">ü§ñ Auto-Training (Perzeptron)</button>
                  <button id="resetW">üîÅ Gewichte zur√ºcksetzen</button>
                </div>
                <div id="trainLog" class="small mono" style="margin-top:8px;max-height:120px;overflow:auto;border:1px solid var(--border);border-radius:8px;padding:8px"></div>

                <details style="margin-top:10px">
                  <summary>üí° Was passiert hier?</summary>
                  <ul class="small">
                    <li><strong>1√ó Trainieren:</strong> passt die Gewichte einmal √ºber alle Beispiele an.</li>
                    <li><strong>Auto-Training:</strong> wiederholt viele Epochen, stoppt wenn keine √Ñnderungen mehr auftreten.</li>
                    <li><strong>Gewichte:</strong> St√§rke des Beitrags eines Merkmals zur Entscheidung.</li>
                    <li><strong>Schwelle (Œ∏):</strong> ab dieser Summe ‚áí ‚ÄûSpam‚Äú.</li>
                    <li><strong>Hinweis:</strong> Lernen braucht repr√§sentative Beispiele.</li>
                  </ul>
                </details>
              </div>
            </div>
          </section>

          <section class="panel hidden" id="comparePanel">
            <h2>Direkter Vergleich</h2>
            <table>
              <thead><tr><th>Mail</th><th>Regelbasiert</th><th>Mini-Neuron</th><th>Soll</th></tr></thead>
              <tbody id="compareBody"></tbody>
            </table>
          </section>
        </main>
      </div>
    </section>

    <div class="footer">
      ¬© Demo, frei nutzbar.
    </div>
  </div>

<script>
(function(){
  // ---- Datenmodell ----
  const DEFAULT_DATA = [
    { subj:"GRATIS iPhone jetzt sichern", g:1, k:0, l:1, c:1, d:1, y:1 },
    { subj:"Elternabend ‚Äì Raum√§nderung", g:0, k:1, l:0, c:0, d:0, y:0 },
    { subj:"Ihr Paket konnte nicht zugestellt werden", g:0, k:0, l:1, c:0, d:1, y:1 },
    { subj:"Klausurplan KW 42", g:0, k:1, l:0, c:0, d:0, y:0 },
  ];
  let data = JSON.parse(localStorage.getItem('spamDemoData')||'null') || DEFAULT_DATA.slice();

  // Feature-Definition (beschriftbar)
  let FEATS = [
    { key:'g', label:'Merkmal 1' },
    { key:'k', label:'Merkmal 2' },
    { key:'l', label:'Merkmal 3' },
    { key:'c', label:'Merkmal 4' },
    { key:'d', label:'Merkmal 5' },
  ];

  // ---- Phase-UI ----
  const phase0 = document.getElementById('phase0');
  const phase1 = document.getElementById('phase1');
  const phase2 = document.getElementById('phase2');
  document.getElementById('startBrainstorm').addEventListener('click', ()=> setPhase(1));

  // Brainstorming-UI
  const featInputs = [0,1,2,3,4].map(i=> document.getElementById('featName'+i));
  const bsHeadIds = [0,1,2,3,4].map(i=> document.getElementById('bsHead'+i));
  const bsBody = document.getElementById('bsBody');
  document.getElementById('bsAdd').addEventListener('click', addBsRow);
  document.getElementById('bsReset').addEventListener('click', ()=>{ bsBody.innerHTML=''; addBsRow(); addBsRow(); addBsRow(); });
  document.getElementById('bsApply').addEventListener('click', applyBrainstorm);
  featInputs.forEach((inp,i)=> inp.addEventListener('input', ()=>{ bsHeadIds[i].textContent = (inp.value.trim()||('Merkmal '+(i+1))); }));

  function addBsRow(){
    const r = document.createElement('tr');
    r.innerHTML = `
      <td><input type="text" placeholder="Betreff"></td>
      <td><input type="number" min="0" max="1" step="1" value="0" style="width:70px"></td>
      <td><input type="number" min="0" max="1" step="1" value="0" style="width:70px"></td>
      <td><input type="number" min="0" max="1" step="1" value="0" style="width:70px"></td>
      <td><input type="number" min="0" max="1" step="1" value="0" style="width:70px"></td>
      <td><input type="number" min="0" max="1" step="1" value="0" style="width:70px"></td>
      <td><input type="number" min="0" max="1" step="1" value="0" style="width:90px"></td>`;
    bsBody.appendChild(r);
  }
  // Seed rows
  addBsRow(); addBsRow(); addBsRow();

  // ---- Demo-UI Elemente ----
  const modeSwitch = document.getElementById('modeSwitch');
  const modeText = document.getElementById('modeText');
  let mode = 'rule';

  const emailSelect = document.getElementById('emailSelect');
  const goldTag = document.getElementById('goldTag');
  const featTableBody = document.querySelector('#featTable tbody');
  const dataHead = document.getElementById('dataHead');
  const dataBody = document.getElementById('dataBody');
  const compareBody = document.getElementById('compareBody');

  // Regeln
  const ruleChecks = {
    r0: document.querySelector('input[data-key="r0"]'),
    r4: document.querySelector('input[data-key="r4"]'),
    r1: document.querySelector('input[data-key="r1"]'),
    r3: document.querySelector('input[data-key="r3"]'),
  };
  const ruleOrderSel = document.getElementById('ruleOrder');
  const ruleOut = document.getElementById('ruleOut');
  const ruleWhy = document.getElementById('ruleWhy');
  const ruleAcc = document.getElementById('ruleAcc');
  const ruleTP = document.getElementById('ruleTP');
  const ruleFP = document.getElementById('ruleFP');

  // Neuron
  const sliders = {
    w0:[document.getElementById('w0'),document.getElementById('w0Val')],
    w1:[document.getElementById('w1'),document.getElementById('w1Val')],
    w2:[document.getElementById('w2'),document.getElementById('w2Val')],
    w3:[document.getElementById('w3'),document.getElementById('w3Val')],
    w4:[document.getElementById('w4'),document.getElementById('w4Val')],
    theta:[document.getElementById('theta'),document.getElementById('thetaVal')],
  };
  const neuSum = document.getElementById('neuSum');
  const neuOut = document.getElementById('neuOut');
  const neuAcc = document.getElementById('neuAcc');
  const neuTP = document.getElementById('neuTP');
  const neuFP = document.getElementById('neuFP');
  const fitOnceBtn = document.getElementById('fitOnce');
  const fitAutoBtn = document.getElementById('fitAuto');
  const resetWBtn = document.getElementById('resetW');
  const trainLog = document.getElementById('trainLog');

  const addRowBtn = document.getElementById('addRow');
  const resetDataBtn = document.getElementById('resetData');

  // ---- Utils ----
  function saveData(){ localStorage.setItem('spamDemoData', JSON.stringify(data)); }
  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
  function setDisabledGroup(on, root){ root.querySelectorAll('input,button,select,textarea').forEach(el=> el.disabled = on); }
  function currentMail(){ return data[emailSelect.selectedIndex || 0]; }
  function mailToFeatVec(m){ return [m.g, m.k, m.l, m.c, m.d]; }

  function renderDynamicLabels(){
    // Regeln
    document.getElementById('ruleLbl0').textContent = FEATS[0].label;
    document.getElementById('ruleLbl1').textContent = FEATS[1].label + ' (‚áí kein Spam)';
    document.getElementById('ruleLbl2').textContent = FEATS[2].label;
    document.getElementById('ruleLbl3').textContent = FEATS[3].label;
    document.getElementById('ruleLbl4').textContent = FEATS[4].label;
    // Gewichte (prepend Text)
    document.getElementById('wLbl0').firstChild.textContent = FEATS[0].label + ' ¬∑ ';
    document.getElementById('wLbl1').firstChild.textContent = FEATS[1].label + ' ¬∑ ';
    document.getElementById('wLbl2').firstChild.textContent = FEATS[2].label + ' ¬∑ ';
    document.getElementById('wLbl3').firstChild.textContent = FEATS[3].label + ' ¬∑ ';
    document.getElementById('wLbl4').firstChild.textContent = FEATS[4].label + ' ¬∑ ';
    // Datentabelle Kopf
    dataHead.innerHTML = `<tr>
      <th>Betreff</th>
      ${FEATS.map(f=>`<th>${f.label}</th>`).join('')}
      <th>Soll (Spam)</th>
    </tr>`;
  }

  function predRule(m){
    const order = ruleOrderSel.value;
    const rules = [];
    if(order === 'prioritizeSafe'){ rules.push('safe','f0','f4','f3x2'); }
    else if(order === 'prioritizeSpam'){ rules.push('f0','f4','f3x2','safe'); }
    else { rules.push('f0','f4','safe','f3x2'); }
    let why = [];
    for(const r of rules){
      if(r==='f0' && ruleChecks.r0.checked && m.g===1){ why.push(`Regel: ${FEATS[0].label} ‚áí Spam`); return [1, why.join(' | ')]; }
      if(r==='f4' && ruleChecks.r4.checked && m.d===1){ why.push(`Regel: ${FEATS[4].label} ‚áí Spam`); return [1, why.join(' | ')]; }
      if(r==='safe' && ruleChecks.r1.checked && m.k===1){ why.push(`Regel: ${FEATS[1].label} ‚áí kein Spam`); return [0, why.join(' | ')]; }
      if(r==='f3x2' && ruleChecks.r3.checked && m.c===1 && m.l===1){ why.push(`Regel: ${FEATS[3].label} & ${FEATS[2].label} ‚áí Spam`); return [1, why.join(' | ')]; }
    }
    if(why.length===0) why.push('Default ‚áí kein Spam');
    return [0, why.join(' | ')];
  }

  function getWeights(){
    return [
      parseFloat(sliders.w0[0].value),
      parseFloat(sliders.w1[0].value),
      parseFloat(sliders.w2[0].value),
      parseFloat(sliders.w3[0].value),
      parseFloat(sliders.w4[0].value)
    ];
  }
  function setWeights(ws){
    const ids=['w0','w1','w2','w3','w4'];
    ids.forEach((id,i)=>{ sliders[id][0].value=ws[i]; sliders[id][1].value=ws[i]; });
    updateAll();
  }
  function getTheta(){ return parseFloat(sliders.theta[0].value); }

  function predNeuron(m){
    const x = mailToFeatVec(m);
    const w = getWeights();
    const sum = x.reduce((s,xi,i)=> s + xi*w[i], 0);
    const y = sum >= getTheta() ? 1 : 0;
    return {sum, y};
  }

  function evaluate(modelFn){
    let tp=0, tn=0, fp=0, fn=0;
    for(const m of data){
      const p = modelFn(m);
      const yhat = Array.isArray(p)? p[0] : p.y;
      if(yhat===1 && m.y===1) tp++;
      else if(yhat===0 && m.y===0) tn++;
      else if(yhat===1 && m.y===0) fp++;
      else fn++;
    }
    const acc = data.length ? ((tp+tn)/data.length) : 0;
    return {acc, tp, tn, fp, fn};
  }

  // Perzeptron-Lernen
  function trainPerceptron(epochs=50, lr=0.2){
    const ids=['w0','w1','w2','w3','w4'];
    let w = getWeights();
    let theta = getTheta();
    let improved=false;
    for(let e=0;e<epochs;e++){
      let changed = false;
      for(const m of data){
        const x = mailToFeatVec(m);
        const sum = x.reduce((s,xi,i)=> s + xi*w[i], 0);
        let yhat = sum >= theta ? 1 : 0;
        const error = m.y - yhat; // +1, 0, -1
        if(error!==0){
          for(let i=0;i<w.length;i++) w[i] = clamp(w[i] + lr*error*x[i], -2, 2);
          theta = clamp(theta - lr*error, 0, 3);
          changed = true; improved = true;
        }
      }
      trainLog.textContent += `Epoche ${e+1}: ${changed? 'Update durchgef√ºhrt':'keine √Ñnderung'}\n`;
      if(!changed) break;
    }
    ids.forEach((id,i)=>{ sliders[id][0].value = w[i].toFixed(2); sliders[id][1].value = w[i].toFixed(2); });
    sliders.theta[0].value = theta.toFixed(2); sliders.theta[1].value = theta.toFixed(2);
    updateAll();
    return improved;
  }

  // ---- Rendering ----
  function renderEmailSelect(){
    emailSelect.innerHTML = data.map((m,i)=>`<option value="${i}">${i+1}. ${escapeHtml(m.subj)}</option>`).join('');
    emailSelect.selectedIndex = 0;
  }
  function renderFeatTable(){
    const m = currentMail();
    goldTag.textContent = `Soll: ${m.y===1? 'Spam':'kein Spam'}`;
    goldTag.style.color = m.y===1? 'var(--bad)': 'var(--ok)';
    const map = ['g','k','l','c','d'];
    featTableBody.innerHTML = map.map((k,idx)=>{
      const v = m[k];
      return `<tr><td>${FEATS[idx].label}</td><td class="mono">${v}</td></tr>`;
    }).join('');
  }

  function renderDataTable(){
    dataHead.innerHTML = `<tr>
      <th>Betreff</th>
      ${FEATS.map(f=>`<th>${f.label}</th>`).join('')}
      <th>Soll (Spam)</th>
    </tr>`;
    dataBody.innerHTML = data.map((m,i)=>{
      const vals = ['g','k','l','c','d'].map(k=>`<td><input data-i="${i}" data-k="${k}" type="number" min="0" max="1" step="1" value="${m[k]}"></td>`).join('');
      return `<tr>
        <td><input data-i="${i}" data-k="subj" type="text" value="${escapeAttr(m.subj)}" style="width:100%"></td>
        ${vals}
        <td><input data-i="${i}" data-k="y" type="number" min="0" max="1" step="1" value="${m.y}"></td>
      </tr>`;
    }).join('');
  }

  function renderRuleOutput(){
    const [y, why] = predRule(currentMail());
    ruleOut.textContent = y? 'Spam' : 'kein Spam';
    ruleOut.className = 'out ' + (y? 'bad':'ok');
    ruleWhy.textContent = why;
    const s = evaluate(predRule);
    ruleAcc.textContent = (s.acc*100).toFixed(0)+ '%';
    ruleTP.textContent = `${s.tp} / ${s.tn}`;
    ruleFP.textContent = `${s.fp} / ${s.fn}`;
  }

  function renderNeuronOutput(){
    const p = predNeuron(currentMail());
    neuSum.textContent = `Summe = ${p.sum.toFixed(2)}  ${p.sum >= getTheta()? '‚â•':'<'}  Œ∏=${getTheta().toFixed(2)}`;
    neuOut.textContent = p.y? 'Spam':'kein Spam';
    neuOut.className = 'out ' + (p.y? 'bad':'ok');
    const s = evaluate(predNeuron);
    neuAcc.textContent = (s.acc*100).toFixed(0)+ '%';
    neuTP.textContent = `${s.tp} / ${s.tn}`;
    neuFP.textContent = `${s.fp} / ${s.fn}`;
  }

  function renderCompare(){
    compareBody.innerHTML = data.map(m=>{
      const r = predRule(m)[0];
      const n = predNeuron(m).y;
      const c1 = r? 'bad':'ok';
      const c2 = n? 'bad':'ok';
      const cg = m.y? 'bad':'ok';
      return `<tr>
        <td>${escapeHtml(m.subj)}</td>
        <td class="${c1}">${r? 'Spam':'kein Spam'}</td>
        <td class="${c2}">${n? 'Spam':'kein Spam'}</td>
        <td class="${cg}">${m.y? 'Spam':'kein Spam'}</td>
      </tr>`;
    }).join('');
  }

  function updateAll(){
    renderFeatTable();
    renderRuleOutput();
    if(mode==='learn'){
      renderNeuronOutput();
      renderCompare();
    }
    saveData();
  }

  function applyMode(){
    const neuronPanel = document.getElementById('neuronPanel');
    const comparePanel = document.getElementById('comparePanel');
    if(mode==='rule'){
      neuronPanel.classList.add('hidden');
      comparePanel.classList.add('hidden');
      setDisabledGroup(true, neuronPanel);
    } else {
      neuronPanel.classList.remove('hidden');
      comparePanel.classList.remove('hidden');
      setDisabledGroup(false, neuronPanel);
      renderNeuronOutput();
      renderCompare();
    }
    modeText.textContent = mode==='rule' ? 'Regelbasiert' : 'Lernendes System';
    document.getElementById('modeSwitch').classList.toggle('on', mode==='learn');
    renderRuleOutput();
  }

  // ---- Events ----
  // Brainstorm-Header live
  featInputs.forEach((inp,i)=> inp.addEventListener('input', ()=>{ bsHeadIds[i].textContent = (inp.value.trim()||('Merkmal '+(i+1))); }));

  // Mode switch
  modeSwitch.addEventListener('click', ()=>{ mode = (mode==='rule'?'learn':'rule'); applyMode(); });
  modeSwitch.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); mode = (mode==='rule'?'learn':'rule'); applyMode(); }});

  emailSelect.addEventListener('change', updateAll);
  Object.values(ruleChecks).forEach(el=> el.addEventListener('change', updateAll));
  document.getElementById('ruleOrder').addEventListener('change', updateAll);

  Object.values(sliders).forEach(([range, number])=>{
    range.addEventListener('input', updateAll);
    number.addEventListener('input', ()=>{ range.value = number.value; updateAll(); });
  });

  fitOnceBtn.addEventListener('click', ()=>{ trainLog.textContent=''; trainPerceptron(1, 0.2); });
  fitAutoBtn.addEventListener('click', ()=>{ trainLog.textContent=''; trainPerceptron(50, 0.2); });
  resetWBtn.addEventListener('click', ()=>{ trainLog.textContent=''; setWeights([0.8,-0.5,0.6,0.4,0.7]); sliders.theta[0].value=0.7; sliders.theta[1].value=0.7; updateAll(); });

  addRowBtn.addEventListener('click', ()=>{
    data.push({ subj:"Neues Beispiel", g:0,k:0,l:0,c:0,d:0,y:0 });
    renderDataTable(); attachDataInputs(); renderEmailSelect(); updateAll();
  });
  resetDataBtn.addEventListener('click', ()=>{
    data = DEFAULT_DATA.slice();
    renderDataTable(); attachDataInputs(); renderEmailSelect(); updateAll();
  });

  function attachDataInputs(){
    dataBody.querySelectorAll('input').forEach(inp=>{
      inp.addEventListener('input', ()=>{
        const i = parseInt(inp.getAttribute('data-i'));
        const k = inp.getAttribute('data-k');
        if(k==='subj'){ data[i].subj = inp.value; }
        else { data[i][k] = clamp(parseInt(inp.value||'0')||0,0,1); inp.value = data[i][k]; }
        renderEmailSelect(); updateAll();
      });
    });
  }

  function escapeHtml(s){ return s.replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }
  function escapeAttr(s){ return s.replace(/"/g,'&quot;'); }

  // ---- Phasensteuerung ----
  function setPhase(p){
    [phase0, phase1, phase2].forEach((el,i)=> el.classList.toggle('hidden', i!==p));
  }

  function applyBrainstorm(){
    // Labels √ºbernehmen
    FEATS[0].label = featInputs[0].value.trim()||FEATS[0].label;
    FEATS[1].label = featInputs[1].value.trim()||FEATS[1].label;
    FEATS[2].label = featInputs[2].value.trim()||FEATS[2].label;
    FEATS[3].label = featInputs[3].value.trim()||FEATS[3].label;
    FEATS[4].label = featInputs[4].value.trim()||FEATS[4].label;

    // Beispiele √ºbernehmen
    const rows = Array.from(bsBody.querySelectorAll('tr'));
    const newData = [];
    rows.forEach(tr=>{
      const tds = tr.querySelectorAll('td');
      const subj = tds[0].querySelector('input').value.trim();
      if(!subj) return;
      const f0 = clamp(parseInt(tds[1].querySelector('input').value)||0,0,1);
      const f1 = clamp(parseInt(tds[2].querySelector('input').value)||0,0,1);
      const f2 = clamp(parseInt(tds[3].querySelector('input').value)||0,0,1);
      const f3 = clamp(parseInt(tds[4].querySelector('input').value)||0,0,1);
      const f4 = clamp(parseInt(tds[5].querySelector('input').value)||0,0,1);
      const y  = clamp(parseInt(tds[6].querySelector('input').value)||0,0,1);
      newData.push({ subj:subj, g:f0, k:f1, l:f2, c:f3, d:f4, y:y });
    });

    // Speicher sicher √ºberschreiben
    localStorage.removeItem('spamDemoData');
    if(newData.length >= 1){ data = newData; }
    saveData();

    // UI aktualisieren & zu Phase 2 wechseln
    renderDynamicLabels();
    renderDataTable(); attachDataInputs(); renderEmailSelect();
    emailSelect.selectedIndex = 0;
    mode = 'rule';
    applyMode();
    setPhase(2);
    updateAll();
  }

  // Initiale (unsichtbare) Basis vorbereiten
  renderDynamicLabels();
  renderDataTable(); attachDataInputs(); renderEmailSelect();

  // Start bei Phase 0
  setPhase(0);
})();
</script>
</body>
</html>



