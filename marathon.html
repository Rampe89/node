<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Hannah's Marathon Dashboard – Hannover 2026</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f3f4f6;
      --bg-soft: #e5f3ff;
      --card: #ffffff;
      --accent: #0ea5e9;
      --accent2: #22c55e;
      --accent-soft: rgba(14, 165, 233, 0.12);
      --text: #111827;
      --text-muted: #6b7280;
      --border-soft: #d1d5db;
      --danger: #ef4444;
      --warning: #f97316;
      --radius: 16px;
      --shadow: 0 14px 35px rgba(15, 23, 42, 0.12);
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background:
        radial-gradient(circle at top left, #eef6ff 0, #f9fafb 40%, #eef2ff 100%);
      color: var(--text);
    }

    .app {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 24px;
    }

    header h1 {
      margin: 0;
      font-size: 1.8rem;
      letter-spacing: 0.06em;
      display: flex;
      align-items: center;
      gap: 10px;
      text-transform: uppercase;
      color: #0f172a;
    }

    .logo {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #0ea5e9, #38bdf8 40%, #22c55e 100%);
      color: #f9fafb;
      font-size: 1.3rem;
      font-weight: 800;
      box-shadow:
        0 0 16px rgba(56,189,248,0.9),
        0 0 28px rgba(34,197,94,0.7);
      border: 2px solid #e0f2fe;
    }

    header p {
      margin: 4px 0 0;
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    .pill {
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      color: var(--text-muted);
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background:
        radial-gradient(circle at top left, rgba(14,165,233,0.15), transparent 55%),
        #ffffff;
      backdrop-filter: blur(8px);
      box-shadow: 0 8px 18px rgba(148, 163, 184, 0.25);
    }

    .pill strong {
      color: var(--accent);
    }

    .grid {
      display: grid;
      grid-template-columns: 1.4fr 1.8fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background:
        radial-gradient(circle at top left, rgba(219,234,254,0.7), transparent 55%),
        radial-gradient(circle at bottom right, rgba(209,250,229,0.6), transparent 55%),
        var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px 16px 18px;
      border: 1px solid rgba(209,213,219,0.9);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background:
        radial-gradient(circle at top right, rgba(56,189,248,0.12), transparent 60%);
      opacity: 0.8;
      pointer-events: none;
    }

    .card > * {
      position: relative;
      z-index: 1;
    }

    .card h2 {
      margin: 0 0 6px;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      font-weight: 600;
      color: #0f172a;
    }

    .card h2 span {
      font-size: 0.75rem;
      font-weight: 400;
      color: var(--text-muted);
      text-transform: none;
      letter-spacing: normal;
    }

    .small {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    label {
      display: block;
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    input, select, textarea {
      width: 100%;
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: #f9fafb;
      color: var(--text);
      font-size: 0.85rem;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      background: #ffffff;
      box-shadow:
        0 0 0 1px rgba(14,165,233,0.25),
        0 0 0 4px rgba(191, 219, 254, 0.8);
    }

    textarea {
      resize: vertical;
      min-height: 40px;
      max-height: 120px;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 8px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px 12px;
      margin-top: 8px;
    }

    .inline-row {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 3px;
    }

    .inline-row input[type="checkbox"] {
      width: auto;
    }

    .btn-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .btn-group-right {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 7px 16px;
      font-size: 0.85rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      white-space: nowrap;
      transition: transform 0.08s ease, box-shadow 0.12s ease, background 0.12s ease;
    }

    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #0ea5e9, #22c55e);
      color: #f9fafb;
      box-shadow:
        0 10px 18px rgba(56,189,248,0.45),
        0 0 20px rgba(34,197,94,0.45);
      border: none;
    }

    .btn-primary:hover {
      filter: brightness(1.03);
    }

    .btn-secondary {
      background: #ffffff;
      color: #111827;
      border: 1px solid rgba(148,163,184,0.8);
      box-shadow: 0 6px 14px rgba(148,163,184,0.35);
    }

    .btn-secondary:hover {
      background: #f3f4f6;
    }

    .btn-ghost {
      background: #ffffffaa;
      color: var(--text-muted);
      border: 1px dashed rgba(156,163,175,0.8);
    }

    .btn-ghost:hover {
      background: #f9fafb;
    }

    .hint {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .danger-link {
      color: var(--danger);
      text-decoration: underline;
      cursor: pointer;
      font-size: 0.78rem;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 8px;
    }

    .summary-card {
      border-radius: 12px;
      padding: 9px 9px;
      background:
        linear-gradient(135deg, #ffffff, #f9fafb);
      border: 1px solid rgba(209,213,219,0.9);
      box-shadow: 0 8px 18px rgba(209,213,219,0.6);
    }

    .summary-label {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .summary-value {
      font-size: 1.05rem;
      font-weight: 600;
      color: #111827;
    }

    .summary-value-big {
      font-size: 1.5rem;
      font-weight: 800;
      color: #0f172a;
    }

    .tag-ok {
      border-radius: 999px;
      padding: 2px 9px;
      font-size: 0.75rem;
      background: rgba(22, 163, 74, 0.08);
      color: #16a34a;
      display: inline-flex;
      align-items: center;
      margin-top: 4px;
      border: 1px solid rgba(74, 222, 128, 0.7);
    }

    .tag-warn {
      border-radius: 999px;
      padding: 2px 9px;
      font-size: 0.75rem;
      background: rgba(251, 191, 36, 0.08);
      color: var(--warning);
      border: 1px solid rgba(251, 146, 60, 0.7);
      display: inline-flex;
      align-items: center;
      margin-top: 4px;
    }

    .tag-bad {
      border-radius: 999px;
      padding: 2px 9px;
      font-size: 0.75rem;
      background: rgba(248, 113, 113, 0.08);
      color: var(--danger);
      border: 1px solid rgba(248, 113, 113, 0.8);
      display: inline-flex;
      align-items: center;
      margin-top: 4px;
    }

    .ampel-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: #e5e7eb;
      border: 1px solid rgba(209,213,219,0.9);
      overflow: hidden;
      margin-top: 6px;
    }

    .progress-fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #0ea5e9, #22c55e);
      width: 0%;
      transition: width 0.3s ease-out;
      box-shadow:
        0 0 10px rgba(56,189,248,0.8),
        0 0 14px rgba(34,197,94,0.7);
    }

    .level-subtext {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .coach-text {
      font-size: 0.8rem;
      line-height: 1.4;
      margin-top: 4px;
      color: #374151;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      font-size: 0.75rem;
      color: var(--text-muted);
      gap: 6px;
      background: #ffffffaa;
      backdrop-filter: blur(6px);
    }

    .chip-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 6px rgba(56,189,248,0.9);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.8rem;
    }

    thead {
      background: #e5f0ff;
    }

    th, td {
      padding: 5px 6px;
      border-bottom: 1px solid rgba(209,213,219,0.9);
      text-align: left;
      white-space: nowrap;
    }

    th {
      position: sticky;
      top: 0;
      background: #e5f0ff;
      z-index: 1;
      color: #374151;
      font-weight: 600;
    }

    tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    .table-wrapper {
      max-height: 280px;
      overflow: auto;
      margin-top: 4px;
      border-radius: 12px;
      border: 1px solid rgba(209,213,219,0.9);
      background: #ffffff;
      box-shadow: 0 10px 20px rgba(209,213,219,0.7);
    }

    .nowrap {
      white-space: nowrap;
    }

    .chart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 14px;
      margin-top: 8px;
    }

    .chart-card {
      background: #ffffff;
      border-radius: 12px;
      padding: 10px;
      border: 1px solid rgba(209,213,219,0.9);
      height: 210px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 8px 18px rgba(209,213,219,0.7);
    }

    .chart-card-title {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .chart-card canvas {
      flex: 1;
      width: 100% !important;
      height: 100% !important;
    }

    #importJsonInput {
      display: none;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>
          <span class="logo">HM</span>
          Hannah's Marathon Dashboard
        </h1>
        <p>Hannover Marathon 2026 – Lauf- & Krafttraining, Alltag & Erholung im Blick. Alles lokal gespeichert.</p>
      </div>
      <div>
        <div class="pill">
          <span>Ziel:</span><strong>Hannover Marathon · 12.04.2026</strong>
        </div>
      </div>
    </header>

    <!-- Einstellungen & Tageslog -->
    <div class="grid">
      <section class="card">
        <h2>Einstellungen <span>Renn-Datum · Zielbereiche · Backup</span></h2>
        <p class="small">Einmal sauber einstellen – danach läuft das Dashboard einfach mit.</p>
        <div class="settings-grid">
          <div>
            <label for="raceDate">Renn-Datum</label>
            <input type="date" id="raceDate" />
          </div>
          <div>
            <label for="targetKm">Ziel-Wochenkilometer (Laufen)</label>
            <input type="number" id="targetKm" min="0" step="1" placeholder="z.B. 50" />
          </div>
          <div>
            <label for="targetSleep">Ziel-Schlaf (Ø h / Tag)</label>
            <input type="number" id="targetSleep" min="0" step="0.1" placeholder="z.B. 7.5" />
          </div>
          <div>
            <label for="targetFluids">Ziel-Flüssigkeit (Ø L / Tag)</label>
            <input type="number" id="targetFluids" min="0" step="0.1" placeholder="z.B. 2.5" />
          </div>
        </div>

        <div class="btn-row" style="margin-top: 10px;">
          <div class="btn-group-right">
            <button class="btn-secondary" id="saveSettingsBtn">Einstellungen speichern</button>
          </div>
          <div class="btn-group-right">
            <button class="btn-ghost" id="exportJsonBtn">Backup exportieren (JSON)</button>
            <button class="btn-ghost" id="exportCsvBtn">Daten exportieren (CSV)</button>
          </div>
        </div>

        <div class="summary-grid" id="raceSummary"></div>
        <p class="hint">
          Tipp: Alle paar Wochen ein JSON-Backup sichern. Alles bleibt nur lokal im Browser.
        </p>
      </section>

      <section class="card">
        <h2>Neuen Tag eintragen <span>Training & Alltag</span></h2>
        <p class="small">Kurz ausfüllen – Score & Coaching passieren automatisch im Hintergrund.</p>

        <div class="form-grid">
          <div>
            <label for="entryDate">Datum</label>
            <input type="date" id="entryDate" />
          </div>
          <div>
            <label for="weight">Gewicht (kg)</label>
            <input type="number" id="weight" step="0.1" min="0" />
          </div>
          <div>
            <label for="trainingType">Training (Art)</label>
            <select id="trainingType">
              <option value="">– Kein Training / Rest –</option>
              <option value="Langer Lauf">Langer Lauf</option>
              <option value="Intervall">Intervall</option>
              <option value="Tempo">Tempolauf</option>
              <option value="Locker">Lockerer Lauf</option>
              <option value="Kraft">Kraft / Stabi</option>
              <option value="Cross">Cross / Alternativ</option>
              <option value="Wettkampf">Wettkampf / Test</option>
            </select>
          </div>
          <div>
            <label for="distanceKm">Distanz (km) – nur Laufen</label>
            <input type="number" id="distanceKm" step="0.1" min="0" />
          </div>
          <div>
            <label for="durationMin">Dauer (Minuten)</label>
            <input type="number" id="durationMin" step="1" min="0" />
          </div>
          <div>
            <label for="rpe">Belastung (RPE 1–10)</label>
            <input type="number" id="rpe" step="1" min="1" max="10" />
          </div>
          <div>
            <label for="sleepHours">Schlaf (Stunden)</label>
            <input type="number" id="sleepHours" step="0.1" min="0" />
          </div>
          <div>
            <label for="sleepQuality">Schlaf-Qualität</label>
            <select id="sleepQuality">
              <option value="">–</option>
              <option value="sehr gut">sehr gut</option>
              <option value="gut">gut</option>
              <option value="okay">okay</option>
              <option value="schlecht">schlecht</option>
            </select>
          </div>
          <div>
            <label for="fluidsLiters">Flüssigkeit (L)</label>
            <input type="number" id="fluidsLiters" step="0.1" min="0" />
          </div>
          <div>
            <label for="wellbeing">Wohlbefinden (1–5)</label>
            <select id="wellbeing">
              <option value="">–</option>
              <option value="1">1 – sehr schlecht</option>
              <option value="2">2</option>
              <option value="3">3 – neutral</option>
              <option value="4">4</option>
              <option value="5">5 – sehr gut</option>
            </select>
          </div>
          <div>
            <label>&nbsp;</label>
            <div class="inline-row">
              <input type="checkbox" id="nightRun" />
              <span>Nachtlauf</span>
            </div>
            <div class="inline-row">
              <input type="checkbox" id="hasPain" />
              <span>Schmerzen heute?</span>
            </div>
          </div>

          <div style="grid-column: 1 / -1;">
            <label for="painNote">Schmerz / Beschwerden (optional)</label>
            <textarea id="painNote" placeholder="z.B. Knie, Achillessehne, Rücken, müde Beine …"></textarea>
          </div>
          <div style="grid-column: 1 / -1;">
            <label for="comments">Weitere Notizen</label>
            <textarea id="comments" placeholder="Was lief gut? Was war schwer? Was möchtest du festhalten?"></textarea>
          </div>
        </div>

        <div class="btn-row">
          <span class="hint">
            Alle Daten bleiben lokal im Browser (<code>localStorage</code>).
            <span class="danger-link" id="clearDataLink">Alle Daten löschen</span>
          </span>
          <div class="btn-group-right">
            <button class="btn-secondary" id="fillTodayBtn">Heute übernehmen</button>
            <button class="btn-primary" id="addEntryBtn">Eintrag speichern</button>
          </div>
        </div>
      </section>
    </div>

    <!-- Auswertung -->
    <section class="card">
      <h2>Auswertung letzte 7 Tage <span>Training · Alltag · Marathon-Status</span></h2>
      <div class="summary-grid" id="statsSummary"></div>
      <p class="hint">
        Idee: Viele kleine, passende Tage – dann wird der Weg nach Hannover leicht statt schwer.
      </p>
      <div id="coachFeedback" class="hint"></div>
    </section>

    <!-- Coaching -->
    <section class="card" style="margin-top:18px;">
      <h2>Coaching-Empfehlungen <span>Fokus für morgen & die Woche</span></h2>
      <div class="summary-grid">
        <div class="summary-card">
          <div class="summary-label">Empfehlung für morgen</div>
          <div class="summary-value" id="dailyCoachTitle">Wird aus deinen Einträgen berechnet …</div>
          <div class="coach-text" id="dailyCoachText"></div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Wochen-Fokus</div>
          <div class="summary-value" id="weeklyCoachTitle">Basierend auf der letzten Woche</div>
          <div class="coach-text" id="weeklyCoachText"></div>
        </div>
      </div>
    </section>

    <!-- Visualisierung -->
    <section class="card" style="margin-top:18px;">
      <h2>Visualisierung <span>Wochen-km · Gewicht</span></h2>
      <div class="chart-grid">
        <div class="chart-card">
          <div class="chart-card-title">Wochenkilometer (Laufen) vs. Ziel</div>
          <canvas id="weeklyKmChart"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-card-title">Gewicht über die Zeit</div>
          <canvas id="weightChart"></canvas>
        </div>
      </div>
    </section>

    <!-- Rohdaten -->
    <section class="card" style="margin-top:18px;">
      <h2>Alle Einträge <span>Log – einfach scrollbar</span></h2>
      <div class="chip" style="margin-bottom:6px;">
        <span class="chip-dot"></span>
        <span>Basis für Score, Coaching & den Weg nach Hannover</span>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Datum</th>
              <th>Gewicht</th>
              <th>Training</th>
              <th>km</th>
              <th>Dauer</th>
              <th>RPE</th>
              <th>Schlaf</th>
              <th>Flüssig.</th>
              <th>Wohlbef.</th>
              <th>Nacht?</th>
              <th>Schmerz?</th>
              <th>Schmerz-Notiz</th>
              <th>Notizen</th>
            </tr>
          </thead>
          <tbody id="entriesTableBody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // --- Helper ---
    function parseNumber(value) {
      if (value === null || value === undefined) return null;
      var v = String(value).replace(",", ".").trim();
      if (v === "") return null;
      var num = parseFloat(v);
      return isNaN(num) ? null : num;
    }

    function saveState(key, data) {
      localStorage.setItem(key, JSON.stringify(data));
    }

    function loadState(key, fallback) {
      var raw = localStorage.getItem(key);
      if (!raw) return fallback;
      try {
        return JSON.parse(raw);
      } catch (e) {
        console.warn("Konnte State nicht lesen:", key, e);
        return fallback;
      }
    }

    var STORAGE_ENTRIES_KEY = "hm26_entries_v1";
    var STORAGE_SETTINGS_KEY = "hm26_settings_v1";

    var entries = loadState(STORAGE_ENTRIES_KEY, []);
    var settings = loadState(STORAGE_SETTINGS_KEY, {
      raceDate: "2026-04-12",
      targetKm: 50,
      targetSleep: 7.5,
      targetFluids: 2.5
    });

    // DOM
    var raceDateInput = document.getElementById("raceDate");
    var targetKmInput = document.getElementById("targetKm");
    var targetSleepInput = document.getElementById("targetSleep");
    var targetFluidsInput = document.getElementById("targetFluids");
    var raceSummaryEl = document.getElementById("raceSummary");

    var entryDateInput = document.getElementById("entryDate");
    var weightInput = document.getElementById("weight");
    var trainingTypeInput = document.getElementById("trainingType");
    var distanceKmInput = document.getElementById("distanceKm");
    var durationMinInput = document.getElementById("durationMin");
    var rpeInput = document.getElementById("rpe");
    var sleepHoursInput = document.getElementById("sleepHours");
    var sleepQualityInput = document.getElementById("sleepQuality");
    var fluidsLitersInput = document.getElementById("fluidsLiters");
    var wellbeingInput = document.getElementById("wellbeing");
    var nightRunInput = document.getElementById("nightRun");
    var hasPainInput = document.getElementById("hasPain");
    var painNoteInput = document.getElementById("painNote");
    var commentsInput = document.getElementById("comments");

    var saveSettingsBtn = document.getElementById("saveSettingsBtn");
    var fillTodayBtn = document.getElementById("fillTodayBtn");
    var addEntryBtn = document.getElementById("addEntryBtn");
    var clearDataLink = document.getElementById("clearDataLink");

    var exportJsonBtn = document.getElementById("exportJsonBtn");
    var exportCsvBtn = document.getElementById("exportCsvBtn");

    var statsSummaryEl = document.getElementById("statsSummary");
    var entriesTableBody = document.getElementById("entriesTableBody");
    var coachFeedbackEl = document.getElementById("coachFeedback");

    var dailyCoachTitleEl = document.getElementById("dailyCoachTitle");
    var dailyCoachTextEl = document.getElementById("dailyCoachText");
    var weeklyCoachTitleEl = document.getElementById("weeklyCoachTitle");
    var weeklyCoachTextEl = document.getElementById("weeklyCoachText");

    var weeklyKmChart = null;
    var weightChart = null;

    // --- Settings ---
    function initSettingsUI() {
      raceDateInput.value = settings.raceDate || "2026-04-12";
      if (settings.targetKm != null) targetKmInput.value = settings.targetKm;
      if (settings.targetSleep != null) targetSleepInput.value = settings.targetSleep;
      if (settings.targetFluids != null) targetFluidsInput.value = settings.targetFluids;
    }

    function saveSettings() {
      settings.raceDate = raceDateInput.value || "2026-04-12";

      var tk = parseNumber(targetKmInput.value);
      settings.targetKm = tk != null ? tk : 50;

      var ts = parseNumber(targetSleepInput.value);
      settings.targetSleep = ts != null ? ts : 7.5;

      var tf = parseNumber(targetFluidsInput.value);
      settings.targetFluids = tf != null ? tf : 2.5;

      saveState(STORAGE_SETTINGS_KEY, settings);
      updateRaceSummary();
      updateStats();
    }

    function updateRaceSummary() {
      raceSummaryEl.innerHTML = "";
      var today = new Date();
      today.setHours(0,0,0,0);

      var raceDateStr = settings.raceDate || "2026-04-12";
      var blocks = "";

      if (raceDateStr) {
        var raceDate = new Date(raceDateStr + "T00:00:00");
        var diffMs = raceDate.getTime() - today.getTime();
        var diffDays = Math.round(diffMs / (1000 * 60 * 60 * 24));
        var statusText = "";
        var tagClass = "tag-ok";

        if (diffDays > 0) {
          statusText = diffDays + " Tage bis zum Hannover Marathon";
          if (diffDays < 7) {
            tagClass = "tag-bad";
            statusText = "Race Week – " + diffDays + " Tage";
          } else if (diffDays < 30) {
            tagClass = "tag-warn";
          }
        } else if (diffDays === 0) {
          statusText = "Heute ist Marathon-Tag!";
          tagClass = "tag-bad";
        } else {
          statusText = "Marathon liegt " + Math.abs(diffDays) + " Tage zurück";
          tagClass = "tag-warn";
        }

        blocks +=
          '<div class="summary-card">' +
            '<div class="summary-label">Countdown</div>' +
            '<div class="summary-value">' + statusText + '</div>' +
            '<div class="' + tagClass + '">Datum: ' + raceDate.toLocaleDateString("de-DE") + '</div>' +
          '</div>';
      }

      blocks +=
        '<div class="summary-card">' +
          '<div class="summary-label">Ziel-Wochenkilometer</div>' +
          '<div class="summary-value">' + (settings.targetKm != null ? settings.targetKm + ' km' : '50 km') + '</div>' +
          '<div class="tag-ok">Solider Bereich für die Marathon-Vorbereitung.</div>' +
        '</div>' +
        '<div class="summary-card">' +
          '<div class="summary-label">Ziel-Schlaf</div>' +
          '<div class="summary-value">' + (settings.targetSleep != null ? settings.targetSleep + ' h / Tag' : '7.5 h / Tag') + '</div>' +
          '<div class="tag-ok">Schlaf ist der wichtigste Erholungsfaktor.</div>' +
        '</div>' +
        '<div class="summary-card">' +
          '<div class="summary-label">Ziel-Flüssigkeit</div>' +
          '<div class="summary-value">' + (settings.targetFluids != null ? settings.targetFluids + ' L / Tag' : '2.5 L / Tag') + '</div>' +
          '<div class="tag-ok">Gerade an Lauftagen wichtig.</div>' +
        '</div>';

      raceSummaryEl.innerHTML = blocks;
    }

    function getMonday(dateString) {
      var d = new Date(dateString + "T00:00:00");
      var day = d.getDay(); // 0=So, 1=Mo
      var diff = (day === 0 ? -6 : 1 - day);
      d.setDate(d.getDate() + diff);
      d.setHours(0,0,0,0);
      return d;
    }

    function formatDateShort(dateString) {
      var d = new Date(dateString + "T00:00:00");
      return d.toLocaleDateString("de-DE", { day: "2-digit", month: "2-digit" });
    }

    // --- Score / XP ---
    function computeDailyXP(entry, settings) {
      var targetKm = settings.targetKm || 50;
      var targetSleep = settings.targetSleep || 7.5;
      var targetFluids = settings.targetFluids || 2.5;

      var xp = 0;
      var dist = parseNumber(entry.distanceKm);
      var dur = parseNumber(entry.durationMin);
      var rpe = parseNumber(entry.rpe);
      var sleep = parseNumber(entry.sleepHours);
      var fluids = parseNumber(entry.fluidsLiters);
      var wb = parseNumber(entry.wellbeing);

      var isTraining = dur != null && dur > 0;

      // Basis
      if (isTraining) xp += 10;
      else xp += 4; // Restday zählt auch

      // Distanz vs. Wochenziel
      if (dist != null && dist > 0 && targetKm > 0) {
        var dailyTarget = targetKm / 7;
        var ratio = dist / dailyTarget;
        if (ratio >= 0.8 && ratio <= 1.5) xp += 10;
        else if (ratio > 0.3) xp += 5;
        else xp += 2;
      }

      // Schlaf
      if (sleep != null) {
        var rs = sleep / targetSleep;
        if (rs >= 0.95) xp += 6;
        else if (rs >= 0.8) xp += 4;
        else if (rs >= 0.6) xp += 2;
      }

      // Flüssigkeit
      if (fluids != null) {
        var rf = fluids / targetFluids;
        if (rf >= 0.95) xp += 5;
        else if (rf >= 0.8) xp += 3;
        else if (rf >= 0.6) xp += 1;
      }

      // Wohlbefinden
      if (wb != null) {
        if (wb >= 4) xp += 3;
        else if (wb === 3) xp += 2;
        else xp += 1;
      }

      // Spezial: Nachtlauf / langer Lauf / sehr hart
      if (entry.nightRun) xp += 5;
      if (entry.trainingType === "Langer Lauf" && dist != null && dist >= 20) xp += 6;
      if (dur != null && rpe != null && dur >= 60 && rpe >= 8) xp += 4;

      if (xp < 3) xp = 3;
      if (xp > 30) xp = 30;
      return xp;
    }

    function computeTotalXP(entries, settings) {
      var total = 0;
      for (var i = 0; i < entries.length; i++) {
        var e = entries[i];
        if (!e.date) continue;
        total += computeDailyXP(e, settings);
      }
      return Math.round(total);
    }

    function getProgressFromXP(totalXP) {
      var xpPerStep = 40; // schnelleres Leveln / Score
      var score = Math.floor(totalXP / xpPerStep);
      if (score < 0) score = 0;
      if (score > 100) score = 100;
      var currScore = score;
      var xpIntoStep = totalXP - currScore * xpPerStep;
      return {
        score: score,
        currScore: currScore,
        xpPerStep: xpPerStep,
        xpIntoStep: xpIntoStep
      };
    }

    // --- Export ---
    function exportJSON() {
      var data = {
        version: 1,
        exportedAt: new Date().toISOString(),
        settings: settings,
        entries: entries
      };
      var blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      var dateStr = new Date().toISOString().slice(0,10);
      a.href = url;
      a.download = "hannah_marathon_backup_" + dateStr + ".json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function exportCSV() {
      if (!entries || entries.length === 0) {
        alert("Keine Einträge vorhanden, die exportiert werden könnten.");
        return;
      }
      var header = [
        "date","weight","trainingType","distanceKm","durationMin","rpe",
        "sleepHours","sleepQuality","fluidsLiters","wellbeing",
        "nightRun","hasPain","painNote","comments"
      ];
      var rows = [header];

      for (var i = 0; i < entries.length; i++) {
        var e = entries[i];
        rows.push([
          e.date || "",
          e.weight != null ? e.weight : "",
          e.trainingType || "",
          e.distanceKm != null ? e.distanceKm : "",
          e.durationMin != null ? e.durationMin : "",
          e.rpe != null ? e.rpe : "",
          e.sleepHours != null ? e.sleepHours : "",
          e.sleepQuality || "",
          e.fluidsLiters != null ? e.fluidsLiters : "",
          e.wellbeing != null ? e.wellbeing : "",
          e.nightRun ? "1" : "0",
          e.hasPain ? "1" : "0",
          (e.painNote || "").replace(/"/g, '""'),
          (e.comments || "").replace(/"/g, '""')
        ]);
      }

      var csvContent = rows.map(function(r) {
        return r.map(function(cell) {
          var str = String(cell);
          if (str.indexOf(",") !== -1 || str.indexOf("\"") !== -1 || str.indexOf("\n") !== -1) {
            return "\"" + str.replace(/"/g, '""') + "\"";
          }
          return str;
        }).join(",");
      }).join("\n");

      var blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      var dateStr2 = new Date().toISOString().slice(0,10);
      a.href = url;
      a.download = "hannah_marathon_entries_" + dateStr2 + ".csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // --- Stats & Charts ---
    function updateStats() {
      statsSummaryEl.innerHTML = "";
      if (coachFeedbackEl) coachFeedbackEl.textContent = "";

      if (!entries || entries.length === 0) {
        statsSummaryEl.innerHTML =
          '<div class="summary-card">' +
            '<div class="summary-label">Noch keine Daten</div>' +
            '<div class="summary-value">Erster Eintrag = Start des Dashboards ✨</div>' +
            '<div class="tag-warn">Ein paar Tage loggen, dann werden Score & Empfehlungen aussagekräftig.</div>' +
          '</div>';
        entriesTableBody.innerHTML = "";
        updateCharts({});
        updateCoaching({}, {});
        return;
      }

      var sorted = entries.slice().sort(function(a, b) {
        return (a.date || "").localeCompare(b.date || "");
      });

      var today = new Date();
      today.setHours(0,0,0,0);
      var sevenDaysAgo = new Date(today.getTime() - 6*24*60*60*1000);
      var thirtyDaysAgo = new Date(today.getTime() - 30*24*60*60*1000);
      var thirtyDaysAgoStr = thirtyDaysAgo.toISOString().substring(0,10);

      var sumKm = 0;
      var sumSleep = 0;
      var sumFluids = 0;
      var countSleep = 0;
      var countFluids = 0;

      var last7WellbeingSum = 0;
      var last7WellbeingCount = 0;
      var painCountLast7 = 0;

      var latestWeight = null;
      var weight30days = null;
      var weightSeries = [];
      var weeklyKmMap = {};

      for (var i = 0; i < sorted.length; i++) {
        var e = sorted[i];
        if (!e.date) continue;
        var d = new Date(e.date + "T00:00:00");
        var dateStr = e.date;

        if (d >= sevenDaysAgo && d <= today) {
          var dist = parseNumber(e.distanceKm);
          if (dist != null) sumKm += dist;

          var sleep = parseNumber(e.sleepHours);
          if (sleep != null) { sumSleep += sleep; countSleep++; }

          var fluids = parseNumber(e.fluidsLiters);
          if (fluids != null) { sumFluids += fluids; countFluids++; }

          var wb = parseNumber(e.wellbeing);
          if (wb != null) { last7WellbeingSum += wb; last7WellbeingCount++; }

          if (e.hasPain) painCountLast7++;
        }

        var w = parseNumber(e.weight);
        if (w != null) {
          if (!latestWeight || e.date > latestWeight.date) {
            latestWeight = { date: e.date, weight: w };
          }
          if (e.date <= thirtyDaysAgoStr) {
            if (!weight30days || e.date > weight30days.date) {
              weight30days = { date: e.date, weight: w };
            }
          }
          weightSeries.push({ date: e.date, weight: w });
        }

        var distWeek = parseNumber(e.distanceKm);
        if (distWeek != null && distWeek > 0) {
          var monday = getMonday(e.date);
          var mondayStr = monday.toISOString().substring(0,10);
          if (!weeklyKmMap[mondayStr]) weeklyKmMap[mondayStr] = 0;
          weeklyKmMap[mondayStr] += distWeek;
        }
      }

      var avgSleep = countSleep > 0 ? (sumSleep / countSleep) : null;
      var avgFluids = countFluids > 0 ? (sumFluids / countFluids) : null;
      var avgWellbeing = last7WellbeingCount > 0 ? last7WellbeingSum / last7WellbeingCount : null;

      function buildTag(current, target, unit) {
        if (target == null || current == null) {
          return '<div class="tag-warn">Noch zu wenige Daten oder kein Ziel gesetzt.</div>';
        }
        var diff = current - target;
        var diffAbs = Math.abs(diff).toFixed(1);
        if (current >= target * 0.9 && current <= target * 1.1) {
          return '<div class="tag-ok">Sehr nah am Ziel (' + (diff >= 0 ? "+" : "–") + diffAbs + ' ' + unit + ')</div>';
        } else if (current >= target * 0.6) {
          return '<div class="tag-warn">Okay, aber Luft nach oben (' + (diff >= 0 ? "+" : "–") + diffAbs + ' ' + unit + ')</div>';
        } else {
          return '<div class="tag-bad">Deutlich unter Ziel (' + (diff >= 0 ? "+" : "–") + diffAbs + ' ' + unit + ')</div>';
        }
      }

      function levelFromScore(score) {
        if (score >= 80) return { label: "Grün", className: "tag-ok" };
        if (score >= 60) return { label: "Gelb", className: "tag-warn" };
        return { label: "Rot", className: "tag-bad" };
      }

      var targetKm = settings.targetKm || 50;
      var targetSleep = settings.targetSleep || 7.5;
      var targetFluids = settings.targetFluids || 2.5;

      var kmScore = 50;
      var sleepScore = 50;
      var fluidsScore = 50;
      var weightScore = 50;

      if (targetKm > 0 && sumKm > 0) {
        var ratioKm = sumKm / targetKm;
        if (ratioKm >= 0.8 && ratioKm <= 1.1) kmScore = 90;
        else if (ratioKm >= 0.6 && ratioKm <= 1.3) kmScore = 75;
        else if (ratioKm >= 0.4 && ratioKm <= 1.6) kmScore = 55;
        else kmScore = 35;
      } else if (sumKm > 0) {
        kmScore = 70;
      }

      if (avgSleep != null) {
        var rs = avgSleep / targetSleep;
        if (rs >= 0.95 && rs <= 1.1) sleepScore = 90;
        else if (rs >= 0.8 && rs <= 1.2) sleepScore = 75;
        else if (rs >= 0.6 && rs <= 1.4) sleepScore = 55;
        else sleepScore = 35;
      }

      if (avgFluids != null) {
        var rf = avgFluids / targetFluids;
        if (rf >= 0.95 && rf <= 1.1) fluidsScore = 90;
        else if (rf >= 0.8 && rf <= 1.2) fluidsScore = 75;
        else if (rf >= 0.6 && rf <= 1.4) fluidsScore = 55;
        else fluidsScore = 35;
      }

      if (latestWeight && weight30days) {
        var diffW = latestWeight.weight - weight30days.weight;
        var diffAbsW = Math.abs(diffW);
        if (diffAbsW < 0.5) weightScore = 90;
        else if (diffAbsW < 1.5) weightScore = 75;
        else if (diffAbsW < 3) weightScore = 55;
        else weightScore = 35;
      } else if (latestWeight && !weight30days) {
        weightScore = 65;
      }

      var overallScore = Math.round(
        kmScore * 0.45 +
        sleepScore * 0.25 +
        fluidsScore * 0.2 +
        weightScore * 0.1
      );

      var overallText;
      if (overallScore >= 85) {
        overallText = "Sehr gut im Plan – Vorbereitung wirkt ruhig, stabil und marathon-tauglich.";
      } else if (overallScore >= 70) {
        overallText = "Gute Basis – etwas mehr Konstanz bei Umfang oder Schlaf macht es noch leichter.";
      } else if (overallScore >= 55) {
        overallText = "Solide, aber noch nicht stabil. Kleine regelmäßige Schritte sind wichtiger als große Sprünge.";
      } else {
        overallText = "Aktuell eher wackelig. Eher liebevoll reduzieren als auf Krampf steigern.";
      }

      var kmLevel = levelFromScore(kmScore);
      var sleepLevel = levelFromScore(sleepScore);
      var fluidsLevel = levelFromScore(fluidsScore);
      var weightLevel = levelFromScore(weightScore);

      var totalXP = computeTotalXP(sorted, settings);
      var progress = getProgressFromXP(totalXP);
      var levelPercent = Math.min(100, Math.max(0, progress.score));

      var summaryHtml = "";

      summaryHtml +=
        '<div class="summary-card">' +
          '<div class="summary-label">Marathon-Vorbereitungs-Score</div>' +
          '<div class="summary-value-big">' + progress.score + ' / 100</div>' +
          '<div class="progress-bar">' +
            '<div class="progress-fill" style="width: ' + levelPercent.toFixed(1) + '%;"></div>' +
          '</div>' +
          '<div class="level-subtext">Gesammelte Trainingstage-Punkte: ' + totalXP +
            ' · Jeder ruhige, passende Tag schiebt den Score nach oben.</div>' +
        '</div>';

      summaryHtml +=
        '<div class="summary-card">' +
          '<div class="summary-label">Status letzte 7 Tage</div>' +
          '<div class="summary-value-big">' + overallScore + ' / 100</div>' +
          '<div class="' + (overallScore >= 80 ? "tag-ok" : overallScore >= 60 ? "tag-warn" : "tag-bad") + '">' +
            overallText +
          '</div>' +
          '<div class="ampel-row">' +
            '<span class="' + kmLevel.className + '">Training (' + kmLevel.label + ')</span>' +
            '<span class="' + sleepLevel.className + '">Schlaf (' + sleepLevel.label + ')</span>' +
            '<span class="' + fluidsLevel.className + '">Flüssigkeit (' + fluidsLevel.label + ')</span>' +
            '<span class="' + weightLevel.className + '">Gewicht (' + weightLevel.label + ')</span>' +
          '</div>' +
        '</div>';

      summaryHtml +=
        '<div class="summary-card">' +
          '<div class="summary-label">Wochenkilometer (letzte 7 Tage)</div>' +
          '<div class="summary-value">' + sumKm.toFixed(1) + ' km</div>' +
          buildTag(sumKm, targetKm, "km/Woche") +
        '</div>';

      summaryHtml +=
        '<div class="summary-card">' +
          '<div class="summary-label">Ø Schlaf (letzte 7 Tage)</div>' +
          '<div class="summary-value">' + (avgSleep != null ? avgSleep.toFixed(2) + ' h' : '–') + '</div>' +
          buildTag(avgSleep, targetSleep, "h/Tag") +
        '</div>';

      summaryHtml +=
        '<div class="summary-card">' +
          '<div class="summary-label">Ø Flüssigkeit (letzte 7 Tage)</div>' +
          '<div class="summary-value">' + (avgFluids != null ? avgFluids.toFixed(2) + ' L' : '–') + '</div>' +
          buildTag(avgFluids, targetFluids, "L/Tag") +
        '</div>';

      var weightLine = "–";
      var trendTag = '<div class="tag-warn">Noch zu wenige Daten für einen Trend.</div>';
      if (latestWeight) {
        weightLine = latestWeight.weight.toFixed(1) + " kg";
        if (weight30days) {
          var diffW2 = latestWeight.weight - weight30days.weight;
          var diffAbs2 = Math.abs(diffW2).toFixed(1);
          if (Math.abs(diffW2) < 0.5) {
            trendTag = '<div class="tag-ok">Gewicht stabil (±' + diffAbs2 + ' kg in 30 Tagen)</div>';
          } else if (diffW2 < 0) {
            trendTag = '<div class="tag-warn">Gewichtsabnahme (' + diffAbs2 + ' kg in 30 Tagen) – passt das für dich?</div>';
          } else {
            trendTag = '<div class="tag-warn">Gewichtszunahme (' + diffAbs2 + ' kg in 30 Tagen) – bewusst so gewollt?</div>';
          }
        }
      }

      summaryHtml +=
        '<div class="summary-card">' +
          '<div class="summary-label">Aktuelles Gewicht</div>' +
          '<div class="summary-value">' + weightLine + '</div>' +
          trendTag +
        '</div>';

      if (avgWellbeing != null) {
        summaryHtml +=
          '<div class="summary-card">' +
            '<div class="summary-label">Ø Wohlbefinden (1–5)</div>' +
            '<div class="summary-value">' + avgWellbeing.toFixed(2) + '</div>' +
            (avgWellbeing >= 4
              ? '<div class="tag-ok">Gefühlt insgesamt gut unterwegs – sehr gutes Zeichen.</div>'
              : avgWellbeing >= 3
                ? '<div class="tag-warn">Mittelfeld – hier lohnt sich extra Fokus auf Erholung.</div>'
                : '<div class="tag-bad">Wohlbefinden eher niedrig – lieber etwas Druck rausnehmen.</div>') +
          '</div>';
      }

      statsSummaryEl.innerHTML = summaryHtml;

      // Coach-Fazit
      if (coachFeedbackEl) {
        var hints = [];
        if (kmScore < 60) hints.push("Laufumfang langsam erhöhen – z.B. jede Woche nur wenige Kilometer mehr, nicht sprunghaft.");
        if (sleepScore < 60) hints.push("Schlaf leicht priorisieren – 1–2 Abende bewusst früher ins Bett bringen viel.");
        if (fluidsScore < 60) hints.push("Trinken etwas steigern, besonders an Lauftagen.");
        if (weightScore < 60 && latestWeight && weight30days) hints.push("Gewichtstrend einmal anschauen – passt er zu deinem Zielgefühl?");
        if (painCountLast7 >= 2) hints.push("Schmerzen nicht ignorieren – lieber Tempo/Umfang anpassen, statt „durchzuziehen“.");

        coachFeedbackEl.innerHTML =
          "<strong>Coach-Fazit:</strong> " + overallText + "<br>" +
          (hints.length > 0 ? hints.map(function(h){ return "• " + h; }).join("<br>") :
            "• Im Moment kein akuter Handlungsbedarf – einfach ruhig weiterlaufen und auf den Körper hören.");
      }

      // Tabelle
      var rowsHtml = "";
      for (var k = 0; k < sorted.length; k++) {
        var e2 = sorted[k];
        rowsHtml +=
          "<tr>" +
            '<td class="nowrap">' + (e2.date || "") + "</td>" +
            "<td>" + (e2.weight != null ? e2.weight : "") + "</td>" +
            "<td>" + (e2.trainingType || "") + "</td>" +
            "<td>" + (e2.distanceKm != null ? e2.distanceKm : "") + "</td>" +
            "<td>" + (e2.durationMin != null ? e2.durationMin : "") + "</td>" +
            "<td>" + (e2.rpe != null ? e2.rpe : "") + "</td>" +
            "<td>" + (e2.sleepHours != null ? e2.sleepHours : "") + "</td>" +
            "<td>" + (e2.fluidsLiters != null ? e2.fluidsLiters : "") + "</td>" +
            "<td>" + (e2.wellbeing != null ? e2.wellbeing : "") + "</td>" +
            "<td>" + (e2.nightRun ? "Ja" : "") + "</td>" +
            "<td>" + (e2.hasPain ? "Ja" : "") + "</td>" +
            "<td>" + (e2.painNote || "") + "</td>" +
            "<td>" + (e2.comments || "") + "</td>" +
          "</tr>";
      }
      entriesTableBody.innerHTML = rowsHtml;

      updateCharts({
        weeklyKmMap: weeklyKmMap,
        weightSeries: weightSeries,
        targetKm: targetKm
      });

      updateCoaching({
        sumKm: sumKm,
        targetKm: targetKm,
        avgSleep: avgSleep,
        avgFluids: avgFluids,
        avgWellbeing: avgWellbeing,
        painCountLast7: painCountLast7
      }, {
        kmScore: kmScore,
        sleepScore: sleepScore,
        fluidsScore: fluidsScore,
        weightScore: weightScore,
        overallScore: overallScore
      });
    }

    function updateCharts(data) {
      var ctxWeekly = document.getElementById("weeklyKmChart");
      var ctxWeight = document.getElementById("weightChart");

      var weeklyKmMap = data.weeklyKmMap || {};
      var weightSeries = data.weightSeries || [];
      var targetKm = data.targetKm;

      // Wochen-km
      var weekKeys = Object.keys(weeklyKmMap).sort();
      var weekLabels = weekKeys.map(function(k){ return "ab " + formatDateShort(k); });
      var weekValues = weekKeys.map(function(k){ return weeklyKmMap[k]; });
      var targetLine = targetKm ? weekKeys.map(function(){ return targetKm; }) : null;

      if (weeklyKmChart) weeklyKmChart.destroy();
      weeklyKmChart = new Chart(ctxWeekly, {
        type: "bar",
        data: {
          labels: weekLabels,
          datasets: ([
            { label: "Wochenkilometer", data: weekValues }
          ].concat(
            targetLine ? [{
              type: "line",
              label: "Ziel-Wochen-km",
              data: targetLine,
              borderWidth: 1,
              borderDash: [4, 4],
              pointRadius: 0
            }] : []
          ))
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { ticks: { autoSkip: true, maxTicksLimit: 6 } },
            y: { beginAtZero: true }
          }
        }
      });

      // Gewicht
      var sortedWeight = weightSeries.slice().sort(function(a, b){
        return a.date.localeCompare(b.date);
      });
      var weightLabels = sortedWeight.map(function(w){ return formatDateShort(w.date); });
      var weightValues = sortedWeight.map(function(w){ return w.weight; });

      if (weightChart) weightChart.destroy();
      weightChart = new Chart(ctxWeight, {
        type: "line",
        data: {
          labels: weightLabels,
          datasets: [
            {
              label: "Gewicht (kg)",
              data: weightValues,
              borderWidth: 1,
              tension: 0.3,
              pointRadius: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { ticks: { autoSkip: true, maxTicksLimit: 6 } },
            y: { beginAtZero: false }
          }
        }
      });
    }

    // --- Coaching ---
    function updateCoaching(metrics, scores) {
      var sumKm = metrics.sumKm || 0;
      var targetKm = metrics.targetKm || 50;
      var avgSleep = metrics.avgSleep;
      var avgFluids = metrics.avgFluids;
      var avgWellbeing = metrics.avgWellbeing;
      var painCountLast7 = metrics.painCountLast7 || 0;

      var kmScore = scores.kmScore || 50;
      var sleepScore = scores.sleepScore || 50;
      var fluidsScore = scores.fluidsScore || 50;
      var weightScore = scores.weightScore || 50;
      var overallScore = scores.overallScore || 50;

      var kmRatio = targetKm > 0 ? sumKm / targetKm : 0;
      var trainingState = "unter";
      if (kmRatio >= 0.8 && kmRatio <= 1.1) trainingState = "imPlan";
      else if (kmRatio > 1.1) trainingState = "drüber";

      var sleepFlag = "okay";
      if (avgSleep != null) {
        if (avgSleep >= 7) sleepFlag = "gut";
        else if (avgSleep < 6) sleepFlag = "schlecht";
      }

      var dailyTitle = "Empfehlung für morgen";
      var dailyText = "";

      if (painCountLast7 >= 2 || sleepFlag === "schlecht") {
        dailyTitle = "Morgen: Entlastung & Erholung";
        dailyText =
          "Die letzten Tage wirken eher anstrengend (Schmerzen oder wenig Schlaf). " +
          "Empfehlung: Entweder kompletter Ruhetag oder 30–45 Min sehr locker (RPE 2–3). " +
          "Lieber einmal kurz Luft holen als „durchbeißen“.";
      } else if (trainingState === "unter") {
        dailyTitle = "Morgen: sanfter Aufbau-Tag";
        dailyText =
          "Du liegst diese Woche unter deinem Zielumfang. Wenn du dich gut fühlst: " +
          "zum Beispiel 8–12 km lockerer Lauf (RPE 3–5) oder eine ruhige Kombi aus kurzem Lauf + leichter Kraft/Stabi. " +
          "Nichts Wildes – einfach ruhig nach vorne arbeiten.";
      } else if (trainingState === "drüber") {
        dailyTitle = "Morgen: Umfang halten, Intensität raus";
        dailyText =
          "Diese Woche ist eher „voll“. Empfehlung: 6–8 km sehr entspannt (RPE 3–4) oder nur leichte Kraft/Stabi. " +
          "Idee: Beine bewegen, aber nicht weiter aufstapeln.";
      } else {
        dailyTitle = "Morgen: kontrollierter Trainingsreiz";
        dailyText =
          "Umfang, Schlaf & Alltag wirken im Moment ganz gut. " +
          "Vorschlag: 8–10 km, davon 3–5 km etwas flotter (RPE 6), Rest locker. " +
          "Alternativ: moderates Kraft-/Stabitraining mit Fokus auf saubere Technik.";
      }

      if (!entries || entries.length < 3) {
        dailyTitle = "Morgen: Erstmal ins Log reinkommen";
        dailyText =
          "Sobald ein paar Tage eingetragen sind (Training, Schlaf, Flüssigkeit), werden Empfehlungen genauer. " +
          "Für morgen reicht: ein kurzer, entspannter Lauf oder ganz entspannt ausschlafen – je nachdem, was sich besser anfühlt.";
      }

      dailyCoachTitleEl.textContent = dailyTitle;
      dailyCoachTextEl.innerHTML = dailyText;

      // Wochen-Fokus
      var weeklyTitle = "Fokus für die kommende Woche";
      var weeklyText = "";

      if (!entries || entries.length < 7) {
        weeklyText =
          "Sobald 1–2 komplette Wochen im Dashboard sind, kann die Woche genauer geplant werden. " +
          "Bis dahin: 3–4 lockere Läufe, 1 längerer Lauf und 1 leichte Kraft-/Stabi-Einheit sind ein guter Rahmen.";
        weeklyCoachTitleEl.textContent = weeklyTitle;
        weeklyCoachTextEl.innerHTML = weeklyText;
        return;
      }

      if (kmRatio < 0.6) {
        weeklyText =
          "Letzte Woche war eher ruhig (deutlich unter Zielumfang). " +
          "<strong>Vorschlag:</strong><br>" +
          "• 3 lockere Läufe à 6–10 km<br>" +
          "• 1 etwas längerer Lauf (z.B. 14–18 km)<br>" +
          "• 1 leichte Kraft-/Stabi-Einheit<br>" +
          "• Viel Augenmerk auf guten Schlaf & genug trinken.";
      } else if (kmRatio >= 0.6 && kmRatio <= 1.1 && overallScore >= 70) {
        weeklyText =
          "Du wirkst gut im Plan. <strong>Vorschlag für eine typische Marathon-Vorbereitungswoche:</strong><br>" +
          "• 2–3 lockere Läufe (6–10 km)<br>" +
          "• 1 Langer Lauf (18–26 km, je nach Phase)<br>" +
          "• 1 Einheit mit etwas Tempo (z.B. 4×5 Min zügig, RPE 6–7)<br>" +
          "• 1 Kraft-/Stabi-Einheit (auch kurz ist okay)<br>" +
          "• Mindestens 1 richtiger Ruhetag ohne Laufen.";
      } else if (kmRatio > 1.1) {
        weeklyText =
          "Du warst eher fleißig unterwegs. <strong>Empfohlener Fokus:</strong><br>" +
          "• Gesamtumfang leicht reduzieren (ca. 80–90 % der letzten Woche)<br>" +
          "• 2–3 lockere Läufe, 1 Langer Lauf<br>" +
          "• Tempoeinheiten eher moderat halten<br>" +
          "• 1–2 echte Ruhetage einplanen – lieber akkumuliert frisch bleiben.";
      } else {
        weeklyText =
          "Die Kombination aus Umfang & Alltag wirkt noch etwas unruhig. " +
          "Eine einfache Struktur hilft:<br>" +
          "• 3–4 Läufe, davon 1 Langer<br>" +
          "• 1 leichte Kraft-/Stabi-Einheit<br>" +
          "• Klare Ruhetage einbauen, an denen du bewusst nichts „nachholst“.";
      }

      if (avgWellbeing != null && avgWellbeing < 3) {
        weeklyText += "<br><br><strong>Zusatz:</strong> Wohlbefinden war eher niedrig – lieber eine bewusst ruhigere Woche einplanen, bevor du weiter erhöhst.";
      }

      weeklyCoachTitleEl.textContent = weeklyTitle;
      weeklyCoachTextEl.innerHTML = weeklyText;
    }

    // --- CRUD ---
    function addEntry() {
      var dateVal = entryDateInput.value || new Date().toISOString().substring(0,10);
      var entry = {
        date: dateVal,
        weight: weightInput.value ? parseNumber(weightInput.value) : null,
        trainingType: trainingTypeInput.value || "",
        distanceKm: distanceKmInput.value ? parseNumber(distanceKmInput.value) : null,
        durationMin: durationMinInput.value ? parseNumber(durationMinInput.value) : null,
        rpe: rpeInput.value ? parseNumber(rpeInput.value) : null,
        sleepHours: sleepHoursInput.value ? parseNumber(sleepHoursInput.value) : null,
        sleepQuality: sleepQualityInput.value || "",
        fluidsLiters: fluidsLitersInput.value ? parseNumber(fluidsLitersInput.value) : null,
        wellbeing: wellbeingInput.value ? parseNumber(wellbeingInput.value) : null,
        nightRun: nightRunInput.checked,
        hasPain: hasPainInput.checked,
        painNote: painNoteInput.value || "",
        comments: commentsInput.value || ""
      };

      entries.push(entry);
      saveState(STORAGE_ENTRIES_KEY, entries);

      trainingTypeInput.value = "";
      distanceKmInput.value = "";
      durationMinInput.value = "";
      rpeInput.value = "";
      wellbeingInput.value = "";
      nightRunInput.checked = false;
      hasPainInput.checked = false;
      painNoteInput.value = "";
      commentsInput.value = "";

      updateStats();
    }

    function fillToday() {
      var todayStr = new Date().toISOString().substring(0,10);
      entryDateInput.value = todayStr;
    }

    function clearAllData() {
      if (!confirm("Wirklich alle Daten (Einträge & Einstellungen) löschen? Das kann nicht rückgängig gemacht werden.")) {
        return;
      }
      entries = [];
      settings = {
        raceDate: "2026-04-12",
        targetKm: 50,
        targetSleep: 7.5,
        targetFluids: 2.5
      };
      saveState(STORAGE_ENTRIES_KEY, entries);
      saveState(STORAGE_SETTINGS_KEY, settings);
      initSettingsUI();
      updateRaceSummary();
      updateStats();
    }

    // --- Events ---
    saveSettingsBtn.addEventListener("click", saveSettings);
    addEntryBtn.addEventListener("click", addEntry);
    fillTodayBtn.addEventListener("click", fillToday);
    clearDataLink.addEventListener("click", clearAllData);
    exportJsonBtn.addEventListener("click", exportJSON);
    exportCsvBtn.addEventListener("click", exportCSV);

    // --- Init ---
    (function init() {
      if (!entryDateInput.value) {
        entryDateInput.value = new Date().toISOString().substring(0,10);
      }
      initSettingsUI();
      updateRaceSummary();
      updateStats();
    })();
  </script>
</body>
</html>
