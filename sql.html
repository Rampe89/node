<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SQL Injection – Unterrichtssequenz (Simulation)</title>
<style>
:root{
  --bg:#061426; --card:#0c1b26; --muted:#9fb4c8; --accent:#2ea6ff; --danger:#f44336; --ok:#16a34a; --panel:#071b2a;
}
*{box-sizing:border-box}
body{font-family:Arial,Helvetica,sans-serif;background:linear-gradient(180deg,#041022,#0b2233);color:#e6eef6;margin:0}
.wrap{max-width:1000px;margin:0 auto;padding:20px}
.card{background:var(--card);border:1px solid rgba(255,255,255,0.06);border-radius:10px;padding:16px;margin:12px 0}
h1{margin:0 0 6px 0;font-size:1.5rem}
h2{margin:6px 0 8px 0;font-size:1.1rem}
p{margin:6px 0;color:var(--muted)}
label{display:block;margin:6px 0 4px 0}
input[type=text]{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:var(--panel);color:#e6eef6}
button{padding:8px 12px;border:0;border-radius:8px;background:var(--accent);color:#022;font-weight:700;cursor:pointer}
button.alt{background:#334155;color:#cfe6ff}
button.danger{background:var(--danger);color:#fff}
.btn-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
pre{background:#071524;border-radius:8px;padding:10px;overflow:auto;color:#d9f4ff}
table{width:100%;border-collapse:collapse;margin-top:8px}
th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.06);text-align:left}
.muted{color:var(--muted)}
.notice{padding:8px;border-radius:8px}
.info{background:#072033;border-left:4px solid #2ea6ff}
.warn{background:#2a0b09;color:#ffdede;border-left:4px solid #f44336}
.good{background:#0b2916;color:#c9f5d2;border-left:4px solid #16a34a}
.badge{display:inline-block;padding:4px 8px;border-radius:6px;background:#123;color:#9fd;font-size:0.85rem}
.sensitive{color:transparent;text-shadow:0 0 6px rgba(0,0,0,0.6)}
.hidden{display:none}

/* Stepper */
.stepper{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
.step{padding:6px 10px;border-radius:999px;background:#0b2030;color:#9fc9ff}
.step.active{background:#2ea6ff;color:#012}
.step.done{background:#10936b;color:#012}

/* Teacher modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:60}
.modal{background:var(--card);padding:16px;border-radius:10px;width:330px;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
.modal h3{margin:0 0 8px 0}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.small{font-size:0.9rem;color:var(--muted)}
.kbd{font-family:monospace;background:#102235;border-radius:6px;padding:2px 6px}
</style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <h1>SQL Injection – Unterrichtssequenz</h1>
    <p class="muted">Ablauf in vier Phasen: normale Abfrage, Manipulation ausprobieren, Ursache verstehen, sichere Variante vergleichen.</p>
    <div class="stepper" id="stepper">
      <div class="step active" data-step="1">1 Normal</div>
      <div class="step" data-step="2">2 Manipulation</div>
      <div class="step" data-step="3">3 Warum</div>
      <div class="step" data-step="4">4 Sicher</div>
    </div>
    <div class="row" style="justify-content:space-between">
      <div>
        <button id="btn-prev" class="alt">Zurück</button>
        <button id="btn-next">Weiter</button>
      </div>
      <div class="row">
        <button id="btn-teacher-login" class="alt">Lehrkraft: Login</button>
        <span id="teacher-state" class="small">(nicht angemeldet)</span>
        <span class="small">Passwort: <span class="badge">lehrer</span></span>
      </div>
    </div>
  </div>

  <!-- DB-Ansicht -->
  <div class="card">
    <h2>Schülerdaten (Simulation)</h2>
    <p class="muted">Keine echte Datenbank. Alles läuft im Browser. Noten und Kommentare sind standardmäßig verborgen.</p>
    <div class="btn-row" id="teacher-controls" style="display:none">
      <button id="btn-show-sensitive" class="alt">Sensible Felder zeigen</button>
      <button id="btn-hide-sensitive" class="alt hidden">Sensible Felder verbergen</button>
      <button id="btn-teacher-logout" class="danger">Logout</button>
    </div>
    <div class="notice info small">Hinweis: Die Tabelle dient nur als Datengrundlage für die Abfragen.</div>
    <div style="overflow:auto">
      <table id="db-table" style="min-width:700px">
        <thead>
          <tr>
            <th>ID</th><th>Username</th><th>Klasse</th><th>Durchschnitt (Note)</th><th>Kommentar</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Phase 1 -->
  <section class="card" id="phase-1">
    <h2>Phase 1: Normale Abfrage</h2>
    <p>Aufgabe: Finde den Datensatz zu einem Benutzernamen, z. B. <span class="kbd">alice</span>.</p>
    <label for="q1">Eingabe (username)</label>
    <input id="q1" type="text" placeholder="alice">
    <div class="btn-row" style="margin-top:8px">
      <button id="run1">Ausführen</button>
      <button class="alt sample" data-val="alice">alice</button>
      <button class="alt sample" data-val="bob">bob</button>
    </div>
    <div class="notice info" style="margin-top:8px">
      <strong>SQL-Befehl</strong>
      <pre id="sql1">SELECT * FROM students WHERE username = 'alice';</pre>
    </div>
    <div id="out1"></div>
  </section>

  <!-- Phase 2 -->
  <section class="card hidden" id="phase-2">
    <h2>Phase 2: Manipulation ausprobieren</h2>
    <p>Was passiert, wenn die Eingabe nicht nur ein Name ist. Teste zum Beispiel <span class="kbd">' OR '1'='1' --</span>.</p>
    <label for="q2">Eingabe (username)</label>
    <input id="q2" type="text" placeholder="' OR '1'='1' --">
    <div class="btn-row" style="margin-top:8px">
      <button id="run2">Ausführen (unsicher)</button>
      <button class="alt sample" data-val="' OR '1'='1' --">' OR '1'='1' --</button>
      <button class="alt sample" data-val="'; DROP TABLE students; --">'; DROP TABLE students; --</button>
    </div>
    <div class="notice warn" style="margin-top:8px">
      <strong>Generierte Query (unsicher, String-Konkatenation)</strong>
      <pre id="sql2">SELECT * FROM students WHERE username = '' OR '1'='1'; -- …</pre>
      <div class="small">Die WHERE-Bedingung wird durch die Eingabe verändert. Das ist das Kernproblem.</div>
    </div>
    <div id="out2"></div>
  </section>

  <!-- Phase 3 -->
  <section class="card hidden" id="phase-3">
    <h2>Phase 3: Warum funktioniert das</h2>
    <div class="notice info">
      <p><strong>Erklärung</strong></p>
      <ol>
        <li>Die Anwendung setzt die Eingabe ungeschützt in die SQL-Zeichenkette.</li>
        <li>Die Eingabe enthält eine OR-Bedingung, die immer wahr ist.</li>
        <li>Die Datenbank liefert deshalb alle Zeilen zurück.</li>
      </ol>
    </div>
    <div class="notice good" style="margin-top:8px">
      <strong>Visualisierung der manipulierten Abfrage</strong>
      <pre id="viz3">SELECT * FROM students WHERE username = '' <span style="background:#223b12">OR '1'='1'</span>;</pre>
      <div class="small">Der grün markierte Teil stammt aus der Eingabe und ändert die Logik der WHERE-Klausel.</div>
    </div>
  </section>

  <!-- Phase 4 -->
  <section class="card hidden" id="phase-4">
    <h2>Phase 4: Sichere Variante</h2>
    <p>Gleiche Eingabe, aber die Anwendung nutzt Parameterbindung. Die Struktur bleibt gleich.</p>
    <label for="q4">Eingabe wiederverwenden</label>
    <input id="q4" type="text" placeholder="' OR '1'='1' --">
    <div class="btn-row" style="margin-top:8px">
      <button id="run4">Ausführen (sicher)</button>
      <button class="alt sample" data-val="' OR '1'='1' --">' OR '1'='1' --</button>
    </div>
    <div class="notice info" style="margin-top:8px">
      <strong>Generierte Query (sicher, Parameter)</strong>
      <pre id="sql4">SELECT * FROM students WHERE username = ?  -- bind: ['alice']</pre>
      <div class="small">Die Eingabe ist ein Wert, kein Code. Eine OR-Bedingung landet nicht in der Struktur.</div>
    </div>
    <div id="out4"></div>
  </section>

  <!-- Aufgaben -->
  <section class="card">
    <h2>Aufgaben</h2>
    <ol>
      <li>Phase 2: Finde mit minimaler Eingabe alle Datensätze. Notiere die Eingabe.</li>
      <li>Erkläre in einem Satz, warum diese Eingabe wirkt.</li>
      <li>Phase 4: Teste dieselbe Eingabe. Was ändert sich und warum.</li>
      <li>Nenne zwei Schutzmaßnahmen.</li>
    </ol>
    <div class="btn-row" style="margin-top:8px">
      <button id="check">Kurz-Check</button>
      <button id="reset-check" class="alt">Zurücksetzen</button>
    </div>
    <div id="check-out" class="notice info" style="margin-top:8px"></div>
  </section>

  <!-- Lehrerbereich -->
  <section class="card hidden" id="teacher-panel">
    <h2>Lehrkraft: Lösungen und Hinweise</h2>
    <ul class="muted">
      <li>Musterlösung Input: <span class="kbd">' OR '1'='1' --</span></li>
      <li>Kernaussage: OR-Bedingung macht WHERE immer wahr.</li>
      <li>Sicher: Prepared Statements, Input-Validation, least privilege.</li>
    </ul>
  </section>

</div>

<!-- Modal -->
<div id="modal-root" class="hidden"></div>

<script>
/* -------- Datenbasis (simuliert) -------- */
const DB = [
  { id:1, username:"alice", class:"7a", grade:2.1, comment:"hilft anderen" },
  { id:2, username:"bob",   class:"8b", grade:3.4, comment:"schreibt gut" },
  { id:3, username:"carol", class:"9a", grade:1.7, comment:"Klassenvertretung" },
  { id:4, username:"dave",  class:"7a", grade:2.9, comment:"unregelmäßig" },
  { id:5, username:"eva",   class:"10c",grade:1.3, comment:"Tutor" }
];

/* -------- Hilfsfunktionen -------- */
const esc = s => String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
const qs  = sel => document.querySelector(sel);
const qsa = sel => Array.from(document.querySelectorAll(sel));

function renderDB(mask=true){
  const tb = qs("#db-table tbody");
  tb.innerHTML = "";
  DB.forEach(r=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${esc(r.id)}</td>
      <td>${esc(r.username)}</td>
      <td>${esc(r.class)}</td>
      <td>${mask ? '<span class="sensitive">••</span>' : esc(r.grade)}</td>
      <td>${mask ? '<span class="sensitive">—</span>' : esc(r.comment)}</td>`;
    tb.appendChild(tr);
  });
}
function renderRows(rows, mount){
  const el = typeof mount==="string" ? qs(mount) : mount;
  el.innerHTML = "";
  if(Array.isArray(rows)){
    if(rows.length===0){ el.innerHTML = '<p class="muted">Keine Ergebnisse</p>'; return; }
    const t = document.createElement("table");
    t.innerHTML = "<thead><tr><th>ID</th><th>Username</th><th>Klasse</th><th>Note</th></tr></thead>";
    const tb = document.createElement("tbody");
    rows.forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${esc(r.id)}</td><td>${esc(r.username)}</td><td>${esc(r.class)}</td><td>${esc(r.grade)}</td>`;
      tb.appendChild(tr);
    });
    t.appendChild(tb);
    el.appendChild(t);
  } else if(rows && rows.error){
    el.innerHTML = `<div class="notice warn">${esc(rows.error)}</div>`;
  }
}
function setStep(n){
  const steps = [1,2,3,4];
  steps.forEach(s=>{
    const chip = qs('.step[data-step="'+s+'"]');
    chip.classList.remove("active","done");
    if(s<n) chip.classList.add("done");
    if(s===n) chip.classList.add("active");
    qs("#phase-"+s).classList.toggle("hidden", s!==n);
  });
}

/* -------- Unsichere und sichere „Queries“ -------- */
function insecureQuery(input){
  const sql = "SELECT * FROM students WHERE username = '" + input + "';";
  qs("#sql2").textContent = sql;

  const low = input.toLowerCase();
  const reAlwaysTrue = /(\bor\b).*?(['"]?\s*1\s*['"]?\s*=\s*['"]?\s*1|true)/i;
  if(reAlwaysTrue.test(low)){
    return DB.slice();
  }
  const reDanger = /(drop\s+table|;|--|\/\*)/i;
  if(reDanger.test(input)){
    return { error:"Gefährliche Anweisung erkannt. In dieser Simulation wird nichts ausgeführt." };
  }
  return DB.filter(r=> r.username === input);
}
function secureQuery(input){
  const sql = "SELECT * FROM students WHERE username = ?  -- bind: [" + esc(input) + "]";
  qs("#sql4").textContent = sql;
  return DB.filter(r=> r.username === input);
}

/* -------- Lehrer-Login -------- */
const PW = "lehrer";
function openModal(){
  const root = qs("#modal-root");
  root.classList.remove("hidden");
  root.innerHTML = `
    <div class="modal-backdrop">
      <div class="modal" role="dialog" aria-modal="true">
        <h3>Lehrkraft-Login</h3>
        <p class="small">Bitte Passwort eingeben.</p>
        <div class="row" style="margin:8px 0">
          <input id="pw" type="password" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:var(--panel);color:#e6eef6">
          <button id="pw-ok" class="alt">Anmelden</button>
        </div>
        <div class="row">
          <button id="pw-cancel" class="alt">Abbrechen</button>
        </div>
      </div>
    </div>`;
  qs("#pw").focus();
  qs("#pw-cancel").onclick = closeModal;
  qs("#pw-ok").onclick = ()=>{
    const v = qs("#pw").value || "";
    if(v===PW){
      sessionStorage.setItem("teacher","1");
      closeModal();
      setTeacher(true);
    } else {
      alert("Falsches Passwort.");
      qs("#pw").value="";
      qs("#pw").focus();
    }
  };
}
function closeModal(){
  const root = qs("#modal-root");
  root.innerHTML="";
  root.classList.add("hidden");
}
function setTeacher(on){
  qs("#teacher-panel").classList.toggle("hidden", !on);
  qs("#teacher-controls").style.display = on ? "flex" : "none";
  qs("#teacher-state").textContent = on ? "(angemeldet)" : "(nicht angemeldet)";
  renderDB(!on);
}

/* -------- Kurz-Check -------- */
function quickCheck(){
  const res = qs("#out2 table");
  const count = res ? Math.max(0,res.querySelectorAll("tbody tr").length) : 0;
  let score = 0;
  const fb = [];

  if(count === DB.length){ score++; fb.push("1) Phase 2: alle Datensätze angezeigt."); }
  else fb.push("1) Phase 2: noch nicht alle Datensätze sichtbar.");

  const why = qs("#viz3").textContent.toLowerCase();
  if(why.includes("or") && why.includes("1") && why.includes("=")){ score++; fb.push("2) Ursache erfasst (OR 1=1)."); }
  else fb.push("2) Ursache noch unklar.");

  const s4 = qs("#sql4").textContent.toLowerCase();
  if(s4.includes(" ? ") || s4.includes("bind")){ score++; fb.push("3) Parameterbindung erkannt."); }
  else fb.push("3) Sichere Variante noch prüfen.");

  const out = `<strong>Ergebnis: ${Math.round(score/3*100)}% (${score}/3)</strong><ul><li>${fb.join("</li><li>")}</li></ul>`;
  qs("#check-out").innerHTML = out;
}

/* -------- Events -------- */
document.addEventListener("DOMContentLoaded", ()=>{
  // Tabelle initial
  const logged = sessionStorage.getItem("teacher")==="1";
  setTeacher(logged);

  renderDB(!logged);

  // Samples
  qsa(".sample").forEach(b=>{
    b.addEventListener("click", ()=> {
      const v = b.getAttribute("data-val");
      const current = qs('.step.active')?.getAttribute('data-step');
      if(current==="1") qs("#q1").value = v;
      if(current==="2") qs("#q2").value = v;
      if(current==="4") qs("#q4").value = v;
    });
  });

  // Phase 1
  qs("#run1").addEventListener("click", ()=>{
    const v = qs("#q1").value.trim();
    const rows = DB.filter(r=> r.username===v);
    qs("#sql1").textContent = `SELECT * FROM students WHERE username = '${v}';`;
    renderRows(rows, "#out1");
  });

  // Phase 2
  qs("#run2").addEventListener("click", ()=>{
    const v = qs("#q2").value.trim();
    const rows = insecureQuery(v);
    renderRows(rows, "#out2");
  });

  // Phase 4
  qs("#run4").addEventListener("click", ()=>{
    const v = qs("#q4").value.trim();
    const rows = secureQuery(v);
    renderRows(rows, "#out4");
  });

  // Stepper
  function step(n){ setStep(n); }
  let cur = 1;
  qs("#btn-next").addEventListener("click", ()=>{ cur = Math.min(4, cur+1); step(cur); });
  qs("#btn-prev").addEventListener("click", ()=>{ cur = Math.max(1, cur-1); step(cur); });

  // Lehrkraft
  qs("#btn-teacher-login").addEventListener("click", openModal);
  qs("#btn-teacher-logout").addEventListener("click", ()=>{ sessionStorage.removeItem("teacher"); setTeacher(false); });
  qs("#btn-show-sensitive").addEventListener("click", ()=>{ renderDB(false); qs("#btn-show-sensitive").classList.add("hidden"); qs("#btn-hide-sensitive").classList.remove("hidden"); });
  qs("#btn-hide-sensitive").addEventListener("click", ()=>{ renderDB(true); qs("#btn-hide-sensitive").classList.add("hidden"); qs("#btn-show-sensitive").classList.remove("hidden"); });

  // Aufgaben-Check
  qs("#check").addEventListener("click", quickCheck);
  qs("#reset-check").addEventListener("click", ()=>{ qs("#check-out").innerHTML=""; });

  // Direktstart: Phase 1
  setStep(1);
});
</script>
</body>
</html>


